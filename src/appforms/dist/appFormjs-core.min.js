if("undefined"==typeof window)var window={};!function(){function a(a){function b(){return e}var c={},d={exports:{}};!function(){function a(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var b,e,f={};b=this,null!=b&&(e=b.async),f.noConflict=function(){return b.async=e,f};var g=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},h=function(a,b){if(a.map)return a.map(b);var c=[];return g(a,function(a,d,e){c.push(b(a,d,e))}),c},i=function(a,b,c){return a.reduce?a.reduce(b,c):(g(a,function(a,d,e){c=b(c,a,d,e)}),c)},j=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};"undefined"!=typeof process&&process.nextTick?(f.nextTick=process.nextTick,f.setImmediate="undefined"!=typeof setImmediate?setImmediate:f.nextTick):"function"==typeof setImmediate?(f.nextTick=function(a){setImmediate(a)},f.setImmediate=f.nextTick):(f.nextTick=function(a){setTimeout(a,0)},f.setImmediate=f.nextTick),f.each=function(b,c,d){if(d=d||function(){},!b.length)return d();var e=0;g(b,function(f){c(f,a(function(a){a?(d(a),d=function(){}):(e+=1,e>=b.length&&d(null))}))})},f.forEach=f.each,f.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c(null):e())})};e()},f.forEachSeries=f.eachSeries,f.eachLimit=function(a,b,c,d){var e=k(b);e.apply(null,[a,c,d])},f.forEachLimit=f.eachLimit;var k=function(a){return function(b,c,d){if(d=d||function(){},!b.length||0>=a)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;a>g&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},l=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[f.each].concat(b))}},m=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[k(a)].concat(c))}},n=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[f.eachSeries].concat(b))}},o=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})};f.map=l(o),f.mapSeries=n(o),f.mapLimit=function(a,b,c,d){return p(b)(a,c,d)};var p=function(a){return m(a,o)};f.reduce=function(a,b,c,d){f.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){d(a,b)})},f.inject=f.reduce,f.foldl=f.reduce,f.reduceRight=function(a,b,c,d){var e=h(a,function(a){return a}).reverse();f.reduce(e,b,c,d)},f.foldr=f.reduceRight;var q=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};f.filter=l(q),f.filterSeries=n(q),f.select=f.filter,f.selectSeries=f.filterSeries;var r=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};f.reject=l(r),f.rejectSeries=n(r);var s=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(){d()})};f.detect=l(s),f.detectSeries=n(s),f.some=function(a,b,c){f.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(){c(!1)})},f.any=f.some,f.every=function(a,b,c){f.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(){c(!0)})},f.all=f.every,f.sortBy=function(a,b,c){f.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};c(null,h(b.sort(d),function(a){return a.value}))})},f.auto=function(a,b){b=b||function(){};var c=j(a);if(!c.length)return b(null);var d={},e=[],h=function(a){e.unshift(a)},k=function(a){for(var b=0;b<e.length;b+=1)if(e[b]===a)return e.splice(b,1),void 0},l=function(){g(e.slice(0),function(a){a()})};h(function(){j(d).length===c.length&&(b(null,d),b=function(){})}),g(c,function(c){var e=a[c]instanceof Function?[a[c]]:a[c],m=function(a){var e=Array.prototype.slice.call(arguments,1);if(e.length<=1&&(e=e[0]),a){var h={};g(j(d),function(a){h[a]=d[a]}),h[c]=e,b(a,h),b=function(){}}else d[c]=e,f.setImmediate(l)},n=e.slice(0,Math.abs(e.length-1))||[],o=function(){return i(n,function(a,b){return a&&d.hasOwnProperty(b)},!0)&&!d.hasOwnProperty(c)};if(o())e[e.length-1](m,d);else{var p=function(){o()&&(k(p),e[e.length-1](m,d))};h(p)}})},f.waterfall=function(a,b){if(b=b||function(){},a.constructor!==Array){var c=new Error("First argument to waterfall must be an array of functions");return b(c)}if(!a.length)return b();var d=function(a){return function(c){if(c)b.apply(null,arguments),b=function(){};else{var e=Array.prototype.slice.call(arguments,1),g=a.next();g?e.push(d(g)):e.push(b),f.setImmediate(function(){a.apply(null,e)})}}};d(f.iterator(a))()};var t=function(a,b,c){if(c=c||function(){},b.constructor===Array)a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(j(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};f.parallel=function(a,b){t({map:f.map,each:f.each},a,b)},f.parallelLimit=function(a,b,c){t({map:p(b),each:k(b)},a,c)},f.series=function(a,b){if(b=b||function(){},a.constructor===Array)f.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};f.eachSeries(j(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},f.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},f.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var u=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};f.concat=l(u),f.concatSeries=n(u),f.whilst=function(a,b,c){a()?b(function(d){return d?c(d):(f.whilst(a,b,c),void 0)}):c()},f.doWhilst=function(a,b,c){a(function(d){return d?c(d):(b()?f.doWhilst(a,b,c):c(),void 0)})},f.until=function(a,b,c){a()?c():b(function(d){return d?c(d):(f.until(a,b,c),void 0)})},f.doUntil=function(a,b,c){a(function(d){return d?c(d):(b()?c():f.doUntil(a,b,c),void 0)})},f.queue=function(b,c){function d(a,b,d,e){b.constructor!==Array&&(b=[b]),g(b,function(b){var g={data:b,callback:"function"==typeof e?e:null};d?a.tasks.unshift(g):a.tasks.push(g),a.saturated&&a.tasks.length===c&&a.saturated(),f.setImmediate(a.process)})}void 0===c&&(c=1);var e=0,h={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,push:function(a,b){d(h,a,!1,b)},unshift:function(a,b){d(h,a,!0,b)},process:function(){if(e<h.concurrency&&h.tasks.length){var c=h.tasks.shift();h.empty&&0===h.tasks.length&&h.empty(),e+=1;var d=function(){e-=1,c.callback&&c.callback.apply(c,arguments),h.drain&&h.tasks.length+e===0&&h.drain(),h.process()},f=a(d);b(c.data,f)}},length:function(){return h.tasks.length},running:function(){return e}};return h},f.cargo=function(a,b){var c=!1,d=[],e={tasks:d,payload:b,saturated:null,empty:null,drain:null,push:function(a,c){a.constructor!==Array&&(a=[a]),g(a,function(a){d.push({data:a,callback:"function"==typeof c?c:null}),e.saturated&&d.length===b&&e.saturated()}),f.setImmediate(e.process)},process:function i(){if(!c){if(0===d.length)return e.drain&&e.drain(),void 0;var f="number"==typeof b?d.splice(0,b):d.splice(0),j=h(f,function(a){return a.data});e.empty&&e.empty(),c=!0,a(j,function(){c=!1;var a=arguments;g(f,function(b){b.callback&&b.callback.apply(null,a)}),i()})}},length:function(){return d.length},running:function(){return c}};return e};var v=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&g(c,function(b){console[a](b)}))}]))}};f.log=v("log"),f.dir=v("dir"),f.memoize=function(a,b){var c={},d={};b=b||function(a){return a};var e=function(){var e=Array.prototype.slice.call(arguments),f=e.pop(),g=b.apply(null,e);g in c?f.apply(null,c[g]):g in d?d[g].push(f):(d[g]=[f],a.apply(null,e.concat([function(){c[g]=arguments;var a=d[g];delete d[g];for(var b=0,e=a.length;e>b;b++)a[b].apply(null,arguments)}])))};return e.memo=c,e.unmemoized=a,e},f.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},f.times=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(e);return f.map(d,b,c)},f.timesSeries=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(e);return f.mapSeries(d,b,c)},f.compose=function(){var a=Array.prototype.reverse.call(arguments);return function(){var b=this,c=Array.prototype.slice.call(arguments),d=c.pop();f.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){d.apply(b,[a].concat(c))})}};var w=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};f.applyEach=l(w),f.applyEachSeries=n(w),f.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},"undefined"!=typeof c&&c.amd?c([],function(){return f}):"undefined"!=typeof d&&d.exports?d.exports=f:b.async=f}();var e=d.exports;return function(){function a(a,b,c){var d=parseInt(a,10);return!isNaN(d)&&d>=b&&c>=d}function c(b){var c=0;if("string"==typeof b){var d=b.split(":");valid=2===d.length||3===d.length,valid&&(valid=a(d[0],0,23),c+=60*parseInt(d[0],10)*60),valid&&(valid=a(d[1],0,59),c+=60*parseInt(d[1],10)),valid&&3===d.length&&(valid=a(d[2],0,59),c+=parseInt(d[2],10))}return c}function e(a,b,d,e){var f=a.type,l=a.fieldOptions,m=!0;if("is equal to"===e)m=b===d;else if("is greater than"===e)m=b>d;else if("is less than"===e)m=d>b;else if("is at"===e){if(m=!1,f===h)switch(l.definition.dateTimeUnit){case i:try{m=new Date(new Date(b).toDateString()).getTime()==new Date(new Date(d).toDateString()).getTime()}catch(n){m=!1}break;case j:m=c(b)===c(d);break;case k:try{m=new Date(b).getTime()==new Date(d).getTime()}catch(n){m=!1}break;default:m=!1}}else if("is before"===e){if(m=!1,f===h)switch(l.definition.dateTimeUnit){case i:try{m=new Date(new Date(b).toDateString()).getTime()<new Date(new Date(d).toDateString()).getTime()}catch(n){m=!1}break;case j:m=c(b)<c(d);break;case k:try{m=new Date(b).getTime()<new Date(d).getTime()}catch(n){m=!1}break;default:m=!1}}else if("is after"===e){if(m=!1,f===h)switch(l.definition.dateTimeUnit){case i:try{m=new Date(new Date(b).toDateString()).getTime()>new Date(new Date(d).toDateString()).getTime()}catch(n){m=!1}break;case j:m=c(b)>c(d);break;case k:try{m=new Date(b).getTime()>new Date(d).getTime()}catch(n){m=!1}break;default:m=!1}}else m="is"===e?f===g?b&&b.selections&&-1!==b.selections.indexOf(d):b===d:"is not"===e?f===g?b&&b.selections&&-1===b.selections.indexOf(d):b!==d:"contains"===e?-1!==b.indexOf(d):"does not contain"===e?-1===b.indexOf(d):"begins with"===e?b.substring(0,d.length)===d:"ends with"===e?b.substring(Math.max(0,b.length-d.length),b.length)===d:!1;return m}var f=b("async"),g="checkboxes",h="dateTime",i="date",j="time",k="dateTime",l=function(b){function c(a){f.each(N.pages,function(a,b){f.each(a.fields,function(b,c){return b.pageId=a._id,O[b._id]=b,b.required&&(P[b._id]={field:b,submitted:!1,validated:!1}),c()},function(){return b()})},a)}function d(a){f.each(N.fieldRules,function(a,b){f.each(a.ruleConditionalStatements,function(b,c){var d=b.sourceField;return Q[d]=Q[d]||[],Q[d].push(a),c()},function(){return R[a.targetField]=R[a.targetField]||[],R[a.targetField].push(a),b()})},a)}function g(a){f.each(N.pageRules,function(a,b){a._id;f.each(a.ruleConditionalStatements,function(b,c){var d=b.sourceField;return S[d]=S[d]||[],S[d].push(a),c()},function(){return T[a.targetPage]=T[a.targetPage]||[],T[a.targetPage].push(a),b()})},a)}function h(a){f.each(M.formFields,function(a,b){return a.fieldId?(U[a.fieldId]=a,b()):b(new Error("No fieldId in this submission entry: "+util.inspect(a)))},a)}function l(a){return L?a():(f.parallel([c,d,g],function(b){return b?a(b):(L=!0,a())}),void 0)}function m(a,b){l(function(c){return c?b(c):(M=a,h(b),void 0)})}function n(a,b,c){return b&&b.formFields?(f.filter(b.formFields,function(b,c){return c(b.fieldId.toString()==a.fieldId.toString())},function(a){var b=null;return a&&a[0]&&a[0].fieldValues&&(b=a[0].fieldValues),c(void 0,b)}),void 0):c()}function o(a,b,c){"function"==typeof b&&(c=b,b=null),l(function(d){return d?c(d):(m(a,function(a){return a?c(a):(f.waterfall([function(a){return a(void 0,{validation:{valid:!0}})},function(a,c){p(a,b,c)},q],function(a,b){return a?c(a):c(void 0,b)}),void 0)}),void 0)})}function p(a,b,c){f.each(M.formFields,function(c,d){var e=c.fieldId,f=O[e];n(c,b,function(b,g){return b?d(b):(u(c,f,g,function(b,c){return b?d(b):(c.valid||(a.validation.valid=!1,a.validation[e]=c),P[e]&&(P[e].submitted=!0,P[e].validated=c.valid),d())}),void 0)})},function(b){return b?c(b):c(void 0,a)})}function q(a,b){f.each(Object.keys(P),function(b,c){var d={};return P[b].submitted?c():(J(b,!0,function(e,f){return e?c(e):(f&&(d.fieldId=b,d.valid=!1,d.errorMessages=["Required Field Not Submitted"],a.validation[b]=d,a.validation.valid=!1),c())}),void 0)},function(c){return c?b(c):b(void 0,a)})}function r(a,b,c){l(function(d){return d?c(d):(m(b,function(b){if(b)return c(b);var d=U[a],e=O[a];u(d,e,null,function(b,d){if(b)return c(b);var e={validation:{}};return e.validation[a]=d,c(void 0,e)})}),void 0)})}function s(a,b,c){l(function(d){if(d)return c(d);var e=O[a];v(e.type,function(d,f){return d?c(d):(f(b,e,void 0,function(b){return t(a,b,function(b,d){if(b)return c(b);var e={validation:{}};return e.validation[a]=d,c(void 0,e)})}),void 0)})})}function t(a,b,c){var d={};return d.fieldId=a,d.errorMessages=[],b?(d.errorMessages.push(b.message),d.valid=!1):d.valid=!0,c(void 0,d)}function u(a,b,c,d){w(a,b,c,function(b){t(a.fieldId,b,d)})}function v(a,b){var c=V[a];return c?b(void 0,c):b(new Error("Invalid Field Type "+a))}function w(a,b,c,d){function e(a,b,c){var d=a&&a.fieldValues&&a.fieldValues.length>0;return d?c():c(new Error("No value submitted for field "+b.name))}function g(a,b,c){var d=a.fieldValues.length;if(b.repeating&&b.fieldOptions.definition){if(b.fieldOptions.definition.minRepeat&&d<b.fieldOptions.definition.minRepeat)return c(new Error("Expected min of "+b.fieldOptions.definition.minRepeat+" values for field "+b.name+" but got "+d));if(b.fieldOptions.definition.maxRepeat&&d>b.fieldOptions.definition.maxRepeat)return c(new Error("Expected max of "+b.fieldOptions.definition.maxRepeat+" values for field "+b.name+" but got "+d))}else if(d>1)return c(new Error("Should not have multiple values for non-repeating field"));return c()}function h(a,b,c,d){v(b.type,function(e,g){f.eachSeries(a.fieldValues,function(a,d){g(a,b,c,d)},function(a){return a?d(a):d()})})}"function"==typeof c&&(d=c,c=null),f.series([f.apply(e,a,b),f.apply(g,a,b),f.apply(h,a,b,c)],d)}function x(a,b,c,d){return"string"!=typeof a?d(new Error("Expected string but got"+typeof a)):b.fieldOptions&&b.fieldOptions.validation&&b.fieldOptions.validation.min&&a.length<b.fieldOptions.validation.min?d(new Error("Expected minimum string length of "+b.fieldOptions.validation.min+" but submission is "+a.length+". Submitted val: "+a)):b.fieldOptions&&b.fieldOptions.validation&&b.fieldOptions.validation.max&&a.length>b.fieldOptions.validation.max?d(new Error("Expected maximum string length of "+b.fieldOptions.validation.max+" but submission is "+a.length+". Submitted val: "+a)):d()}function y(a,b,c,d){return"number"!=typeof a?d(new Error("Expected number but got "+typeof a)):b.fieldOptions&&b.fieldOptions.validation&&b.fieldOptions.validation.min&&a<b.fieldOptions.validation.min?d(new Error("Expected minimum Number "+b.fieldOptions.validation.min+" but submission is "+a+". Submitted number: "+a)):b.fieldOptions.validation.max&&a>b.fieldOptions.validation.max?d(new Error("Expected maximum Number "+b.fieldOptions.validation.max+" but submission is "+a+". Submitted number: "+a)):d()}function z(a,b,c,d){return"string"!=typeof a?d(new Error("Expected string but got"+typeof a)):null===a.match(/[-0-9a-zA-Z.+_]+@[-0-9a-zA-Z.+_]+\.[a-zA-Z]{2,4}/g)?d(new Error("Invalid email address format: "+a)):d()}function A(a,b,c,d){if("string"!=typeof a)return d(new Error("Expected dropdown submission to be string but got "+typeof a));if(!b.fieldOptions.definition.options)return d(new Error("No dropdown options exist for field "+b.name));var e=b.fieldOptions.definition.options.filter(function(b){return b.label===a});return 1!==e.length?d(new Error("Invalid number of dropdown options found: "+e.length)):d()}function B(a,b,c,d){if("string"!=typeof a)return d(new Error("Expected radio submission to be string but got "+typeof a));if(!b.fieldOptions.definition.options)return d(new Error("No radio options exist for field "+b.name));var e=b.fieldOptions.definition.options.filter(function(b){return b.label===a});return 1!==e.length?d(new Error("Invalid number of radio options found: "+e.length)):d()}function C(a,b,c,d){var e;b&&b.fieldOptions&&b.fieldOptions.validation&&(e=b.fieldOptions.validation.min);var g;if(b&&b.fieldOptions&&b.fieldOptions.validation&&(g=b.fieldOptions.validation.max),e&&(null===a.selections||void 0===a.selections||a.selections.length<e)){var h;return a.selections&&(h=a.selections.length),d(new Error("Expected a minimum number of selections "+e+" but got "+h))}if(g&&a.selections&&a.selections.length>g)return d(new Error("Expected a maximum number of selections "+g+" but got "+a.selections.length));var i=[];f.eachSeries(b.fieldOptions.definition.checkboxChoices,function(a,b){for(var c in a)i.push(c);return b()},function(){f.eachSeries(a.selections,function(a,b){return"string"!=typeof a?b(new Error("Expected checkbox submission to be string but got "+typeof a)):-1===i.indexOf(a)?b(new Error("Checkbox Option "+a+" does not exist in the field.")):b()},d)})}function D(a,b,c,d){function e(a,b){return"string"!=typeof a.zone||3!==a.zone.length?b(new Error("Invalid zone definition for northings and eastings location. "+a.zone)):"string"!=typeof a.eastings||6!==a.eastings.length?b(new Error("Invalid eastings definition for northings and eastings location. "+a.eastings)):"string"!=typeof a.northings||7!==a.northings.length?b(new Error("Invalid northings definition for northings and eastings location. "+a.northings)):b()}return"latLong"===b.fieldOptions.definition.locationUnit?a.lat&&a.long?isNaN(parseFloat(a.lat))||isNaN(parseFloat(a.lat))?d(new Error("Invalid latitude and longitude values")):d():d(new Error("Invalid object for latitude longitude submission")):a.zone&&a.eastings&&a.northings?e(a,d):d(new Error("Invalid object for northings easting submission. Zone, Eastings and Northings elemets are required"))}function E(a,b,c,d){return"string"!=typeof a?d(new Error("Expected string but got"+typeof a)):a.indexOf("filePlaceHolder")>-1?d():c&&c.indexOf(a)>-1?d():d(new Error("Invalid file placeholder text"+a))}function F(b,c,d,e){var f;if("string"!=typeof b)return e(new Error("Expected string but got"+typeof b));switch(c.fieldOptions.definition.dateTimeUnit){case i:try{f=new Date(b),valid="Invalid Date"!==f.toString()}catch(g){valid=!1}return valid?e():e(new Error("Invalid date value "+b));case j:var h=b.split(":");return valid=2===h.length||3===h.length,valid&&(valid=a(h[0],0,23)),valid&&(valid=a(h[1],0,59)),valid&&3===h.length&&(valid=a(h[2],0,59)),valid?e():e(new Error("Invalid date value "+b));case k:try{return f=new Date(b),"Invalid Date"===f.toString()?e(new Error("Invalid dateTime string "+b)):e()}catch(g){return e(new Error("Invalid dateTime string "+b))}break;default:return e(new Error("Invalid dateTime fieldtype "+fieldOptions.definition.dateTimeUnit))}}function G(a,b,c,d){return d(new Error("Should not submit section field: "+b.name))}function H(a,b){var c=!0;f.each(a,function(a,b){var d=[],g=[];f.each(a.ruleConditionalStatements,function(a,b){var c=O[a.sourceField],f=!1,h=[];if(U[a.sourceField]&&U[a.sourceField].fieldValues){h=U[a.sourceField].fieldValues;var i=a.restriction,j=a.sourceValue;f=e(c,h[0],j,i)}return d.push({field:c,submissionValues:h,condition:i,testValue:j,passed:f}),f&&g.push(c),b()},function(e){function f(a,b,c){return"and"===a&&b.length==c.length||"or"===a&&b.length>0}return e&&b(e),c=f(a.ruleConditionalOperator,g,d)?"show"===a.type:"show"!==a.type,b()})},function(a){return a?b(a):b(void 0,c)})}function I(a,b){l(function(c){return c?b(c):X(a)?H(T[a],b):b(void 0,!0)})}function J(a,b,c){l(function(d){if(d)return c(d);var e=O[a];return a?(f.waterfall([function(a){return b?(I(e.pageId,a),void 0):a(void 0,!0)},function(b,c){return b?W(a)?H(R[a],c):c(void 0,!0):c(void 0,!1)}],c),void 0):c(new Error("Field does not exist in form"))})}function K(a,b){l(function(c){return c?b(c):(m(a,function(a){if(a)return b(a);var c={};f.parallel([function(a){c.fields={},f.eachSeries(Object.keys(R),function(a,b){J(a,!1,function(d,e){return d?b(d):(c.fields[a]={targetId:a,action:e?"show":"hide"},b())})},a)},function(a){c.pages={},f.eachSeries(Object.keys(T),function(a,b){I(a,function(d,e){return d?b(d):(c.pages[a]={targetId:a,action:e?"show":"hide"},b())})},a)}],function(a){return a?b(a):b(void 0,{actions:c})})}),void 0)})}var L,M,N=b,O={},P={},Q={},R={},S={},T={},U={},V={text:x,textarea:x,number:y,emailAddress:z,dropdown:A,radio:B,checkboxes:C,location:D,locationMap:D,photo:E,signature:E,file:E,dateTime:F,sectionBreak:G},W=function(a){return!!R[a]},X=function(a){return!!T[a]};return{validateForm:o,validateField:r,validateFieldValue:s,checkRules:K,validateFieldInternal:w,initSubmission:m,isFieldVisible:J,isConditionActive:e}};"undefined"!=typeof d&&d.exports&&(d.exports=l)}(),d.exports(a)}var c=function(a){function b(a,b){"undefined"==typeof b&&(b=a);var d=a.config||{};c.config=c.models.config,c.config.init(d,function(){b()})}return a.init=b,a}(c||{});c.utils=function(a){function b(a,b){if(b.constructor&&b.constructor==Function)for(var c in b.prototype)a.prototype[c]=b.prototype[c];else for(var c in b)a.prototype[c]=b[c]}function c(a){var b=a.getProps(),c=b._id,d=b._type,e=(new Date).getTime();return c&&d?c+"_"+d+"_"+e:c?c+"_"+e:d?d+"_"+e:e}function d(a,b){"undefined"!=typeof $fh&&$fh.hash?$fh.hash({algorithm:"MD5",text:a},function(a){a&&a.hashvalue?b(null,a.hashvalue):b("Crypto failed.")}):b("Crypto not found")}return a.extend=b,a.localId=c,a.md5=d,a}(c.utils||{}),c.utils=function(a){function c(){return n}function d(a,c,d){var e=null,f=0;if("object"==typeof c)if(c instanceof File)e=c,f=e.size;else if(c instanceof Blob)e=c,f=b.size;else{var g=JSON.stringify(c),f=g.length;e=new Blob(g,{type:"text/plain"})}else"string"==typeof c&&(f=c.length,e=new Blob([c],{type:"text/plain"}));k(a,f,{create:!0},function(a,b){a?(console.error(a),d(a)):b.createWriter(function(a){function b(a){return d(null,a)}function c(){a.onwrite=b,a.write(e)}a.onwrite=c,a.truncate(0)},function(a){d("Failed to create file write:"+a)})})}function e(a,b){k(a,0,{},function(a,c){a?(console.error(a),b(a)):c.remove(function(){b(null,null)},function(a){console.error(a),b("Failed to remove file"+a)})})}function f(a,b){j(a,function(a,c){if(a)b(a);else{var d=new FileReader;d.onloadend=function(a){var c=a.target.result;try{c=decodeURIComponent(c)}catch(d){}return b(null,c)},d.readAsText(c)}})}function g(a,b){j(a,function(a,c){if(a)return b(a);var d=new FileReader;d.onloadend=function(a){var c=a.target.result;return b(null,c)},d.readAsDataURL(c)})}function h(a,b){j(a,function(a,c){if(a)return b(a);var d=c.type,e=new FileReader;e.onloadend=function(a){var c=a.target.result,e=new Blob([c],{type:d});b(null,e)},e.readAsArrayBuffer(c)})}function i(a,b){j(a,b)}function j(a,b){k(a,0,{},function(a,c){return a?b(a):(c.file(function(a){b(null,a)},function(a){console.error("Failed to get file:"+a),b(a)}),void 0)})}function k(a,b,c,d){o(p,b,function(e){e.root.getFile(a,c,function(a){d(null,a)},function(e){if("QuotaExceededError"==e.name||10==e.code){var f=1073741824;l(f,function(){k(a,b,c,d)})}else console.error("Failed to get file entry:"+e.message),d(e)})},function(){d("Failed to requestFileSystem")})}function l(a,b){navigator.webkitPersistentStorage?navigator.webkitPersistentStorage.requestQuota(a,function(a){b(null,a)},function(a){b(a,0)}):b(null,a)}function m(){window.requestFileSystem?(o=window.requestFileSystem,n=!0):window.webkitRequestFileSystem?(o=window.webkitRequestFileSystem,n=!0):n=!1,window.LocalFileSystem?p=window.LocalFileSystem.PERSISTENT:window.PERSISTENT&&(p=window.PERSISTENT)}a.fileSystem={isFileSystemAvailable:c,save:d,remove:e,readAsText:f,readAsBlob:h,readAsBase64Encoded:g,readAsFile:i};var n=!1,o=function(){},p=1;return m(),a}(c.utils||{}),c.utils=function(a){function b(){return g}function c(a,b){f(a,b)}function d(a,b){var c=a.width,d=a.height;g?navigator.camera.getPicture(e(b),b,{quality:100,targetWidth:c,targetHeight:d,saveToPhotoAlbum:!1,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.PNG}):h||b("Your device does not support camera.")}function e(a){return function(b){var c="data:image/png;base64,"+b;a(null,c)}}function f(a,b){var c=a.width,d=a.height;i.width=c,i.height=d,j.width=c,j.height=d,k||navigator.getUserMedia({video:!0},function(a){i.src=window.URL.createObjectURL(a),k=a,b(null)},b)}a.takePhoto=d,a.isPhoneGapAvailable=b,a.initHtml5Camera=c;var g=!1,h=!1,i=null,j=null,k=null;return a}(c.utils||{}),c.web=function(a){return a}(c.web||{}),c.web.ajax=function(a){function b(){}function c(a,b){e({url:a,type:"GET",success:function(a){b(null,a)},error:function(a){b(a)}})}function d(a,b,c){var d,f=!1;if("object"==typeof b)if(b instanceof File){f=!0,d=new FormData;var g=b.name;d.append(g,b),b=d}else b=JSON.stringify(b);var h={url:a,type:"POST",data:b,dataType:"json",success:function(a){c(null,a)},error:function(a){c(a)}};0==f&&(h.contentType="application/json"),e(h)}a="undefined"!=typeof $fh&&$fh.__ajax?$fh.__ajax:b,a.get=c,a.post=d;var e=a;return a}(c.web.ajax||{}),c.stores=function(a){function b(a){this.name=a}return a.Store=b,b.prototype.create=function(){throw"Create not implemented:"+this.name},b.prototype.read=function(){throw"Read not implemented:"+this.name},b.prototype.update=function(){throw"Update not implemented:"+this.name},b.prototype.delete=function(){throw"Delete not implemented:"+this.name},b.prototype.upsert=function(){throw"Upsert not implemented:"+this.name},a}(c.stores||{}),c.stores=function(a){function b(){c.stores.Store.call(this,"LocalStorage")}function d(){i()?f.apply({},arguments):e.apply({},arguments)}function e(a,b,c){$fh.data(a,function(c){"undefined"==typeof c&&(c={key:a.key,val:a.val}),"remove"==a.act.toLowerCase()&&b(null,null),b(null,c.val?c.val:null)},c)}function f(a,b,c){function d(a){return"undefined"!=typeof c?c(a,{}):void 0}function e(a,b){a+=$fh.app_props.appid,g.md5(a,function(c,d){c&&(d=a);var e=d+".txt";return"undefined"==typeof navigator.externalstorage?b(e):(navigator.externalstorage.enable(function(a){var c=e;return a.path&&(c=a.path,c.match(/\/$/)||(c+="/"),c+=e),e=c,b(e)},function(){return b(e)}),void 0)})}function f(a,c){e(a,function(a){h.save(a,c,function(a){a?d(a):b(null,c)})})}function i(a){e(a,function(a){h.remove(a,function(a){a?"NotFoundError"==a.name||1==a.code?b(null,null):d(a):b(null,null)})})}function j(a){e(a,function(a){h.readAsText(a,function(a,c){a?"NotFoundError"==a.name||1==a.code?b(null,null):d(a):b(null,c)})})}return"undefined"==typeof a.act?j(a.key):"save"===a.act?f(a.key,a.val):"remove"===a.act?i(a.key):"load"===a.act?j(a.key):"undefined"!=typeof c?c("Action ["+a.act+"] is not defined",{}):void 0}var g=c.utils,h=g.fileSystem,i=function(){};return c.utils.extend(b,c.stores.Store),b.prototype.create=function(a,b){var c=g.localId(a);a.setLocalId(c),this.update(a,b)},b.prototype.read=function(a,b){var c=a.getLocalId();null!=c?d({act:"load",key:c.toString()},b,b):b(null,null)},b.prototype.update=function(a,b){var c=a.getLocalId(),e=a.getProps(),f=JSON.stringify(e);d({act:"save",key:c.toString(),val:f},b,b)},b.prototype.delete=function(a,b){var c=a.getLocalId();d({act:"remove",key:c.toString()},b,b)},b.prototype.upsert=function(a,b){var c=a.getLocalId();null==c?this.create(a,b):this.update(a,b)},b.prototype.switchFileSystem=function(a){i=function(){return a}},b.prototype.defaultStorage=function(){i=function(){return h.isFileSystemAvailable()}},i=function(){return h.isFileSystemAvailable()},a.localStorage=new b,a}(c.stores||{}),c.stores=function(a){function b(){e.call(this,"MBaaS")}function d(a){var b=a.get("_type"),d=c.config.get("cloudHost"),e=c.config.get("mbaasBaseUrl"),f=c.config.get("formUrls");if(!f[b])throw"type not found to get url:"+b;var g=f[b],h=d+e+g,i={};switch(b){case"form":i.formId=a.get("_id");break;case"formSubmission":i.formId=a.getFormId();break;case"fileSubmission":i.submissionId=a.getSubmissionId(),i.hashName=a.getHashName(),i.fieldId=a.getFieldId()}for(var j in i)h=h.replace(":"+j,i[j]);return h}var e=c.stores.Store;return a.mBaaS=new b,c.utils.extend(b,e),b.prototype.create=function(a,b){var e=d(a);c.web.ajax.post(e,a.getProps(),b)},b.prototype.read=function(a,b){var e=d(a);c.web.ajax.get(e,b)},b.prototype.update=function(){},b.prototype.delete=function(){},a}(c.stores||{}),c.stores=function(a){function b(a,b){d.call(this,"DataAgent"),this.remoteStore=a,this.localStore=b}var d=c.stores.Store;return a.DataAgent=b,a.dataAgent=new b(c.stores.mBaaS,c.stores.localStorage),c.utils.extend(b,d),b.prototype.read=function(a,b){var c=this;this.localStore.read(a,function(d,e){d||!e?(d&&console.error(d),c.refreshRead(a,b)):b(null,e,!1)})},b.prototype.refreshRead=function(a,b){var c=this;this.remoteStore.read(a,function(d,e){d?(console.error(d),b(d)):(a.fromJSON(e),c.localStore.upsert(a,function(){var a=Array.prototype.slice.call(arguments,0);a.push(!0),b.apply({},a)}))})},a}(c.stores||{}),c.models=function(a){function b(a){if(this.props={_id:null,_type:null,_ludid:null},this.events={},"undefined"!=typeof a)for(var b in a)this.props[b]=a[b];this.touch()}return a.Model=b,b.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].indexOf(b)<0&&this.events[a].push(b)},b.prototype.off=function(a,b){this.events[a]&&this.events[a].indexOf(b)>=0&&this.events[a].splice(this.events[a].indexOf(b),1)},b.prototype.emit=function(){var a=Array.prototype.slice.call(arguments,0),b=a.shift(),c=this.events[b];if(c&&c.length>0)for(var d=0;d<c.length;d++){var e=c[d];e.apply(this,a)}},b.prototype.getProps=function(){return this.props},b.prototype.get=function(a,b){return"undefined"==typeof this.props[a]?b:this.props[a]},b.prototype.set=function(a,b){this.props[a]=b},b.prototype.setLocalId=function(a){this.set("_ludid",a)},b.prototype.getLocalId=function(){return this.get("_ludid")},b.prototype.fromJSON=function(a){if("string"==typeof a)this.fromJSONStr(a);else for(var b in a)this.set(b,a[b]);this.touch()},b.prototype.fromJSONStr=function(a){try{var b=JSON.parse(a);this.fromJSON(b)}catch(c){console.error(c)}},b.prototype.touch=function(){this.set("_localLastUpdate",(new Date).getTime())},b.prototype.getLocalUpdateTimeStamp=function(){return this.get("_localLastUpdate")},b.prototype.genLocalId=function(){return c.utils.localId(this)
},b.prototype.refresh=function(a,b){function c(a,c){!a&&c?(e.fromJSON(c),b(null,e)):b(a,e)}var d=this.getDataAgent(),e=this;"undefined"==typeof b&&(b=a,a=!1),a?d.refreshRead(this,c):d.read(this,c)},b.prototype.loadLocal=function(a){var b=c.stores.localStorage,d=this;b.read(this,function(b,c){b?a(b):(c&&d.fromJSON(c),a(b,d))})},b.prototype.saveLocal=function(a){var b=c.stores.localStorage;b.upsert(this,a)},b.prototype.clearLocal=function(a){var b=c.stores.localStorage;b.delete(this,a)},b.prototype.getDataAgent=function(){return this.dataAgent||this.setDataAgent(c.stores.dataAgent),this.dataAgent},b.prototype.setDataAgent=function(a){this.dataAgent=a},a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"config"})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.init=function(a,b){this.set("appId",$fh.app_props.appid),this.set("env",$fh.app_props.mode?$fh.app_props.mode:"dev"),this.set("timeoutTime",3e4),this._initMBaaS(),this.fromJSON(a),b()},b.prototype._initMBaaS=function(){var a=$fh.cloud_props,b=$fh.app_props,c=b.host,d=b.mode?b.mode:"dev";a&&a.hosts&&(c=d.indexOf("dev")>-1?a.hosts.debugCloudUrl:a.hosts.releaseCloudUrl),this.set("cloudHost",c),this.set("mbaasBaseUrl","/mbaas");var e=this.get("appId");this.set("formUrls",{forms:"/forms/"+e,form:"/forms/"+e+"/:formId",theme:"/forms/"+e+"/theme",formSubmission:"/forms/:formId/submitFormData",fileSubmission:"/:submissionId/:fieldId/:hashName/submitFormFile"})},a.config=new b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"forms",_ludid:"forms_list",loaded:!1})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.clearAllForms=function(){},b.prototype.isFormUpdated=function(a){var b=a.get("_id"),c=a.getLastUpdate(),d=this.getFormMetaById(b);return d?c==d.lastUpdatedTimestamp:!1},b.prototype.getFormMetaById=function(a){for(var b=this.get("forms"),c=0;c<b.length;c++){var d=b[c];if(d._id==a)return d}return null},b.prototype.size=function(){return this.get("forms").length},b.prototype.setLocalId=function(){throw"forms id cannot be set programmly"},b.prototype.getFormsList=function(){return this.get("forms")},b.prototype.getFormIdByIndex=function(a){return this.getFormsList()[a]._id},a.forms=new b,a}(c.models||{}),c.models=function(a){function b(a,b){var c=a.rawMode,f=a.rawData,g=a.formId;if(!g)throw"Cannot initialise a form object without an id. id:"+g;if(d.call(this,{_id:g,_type:"form"}),e[g])return b(null,e[g]),e[g];if(c===!0){this.fromJSON(f);try{this.initialise()}catch(h){console.error("Failed to initialise form."),console.error(h)}e[g]=this,b(null,this)}else{var i=a.fromRemote;if("function"!=typeof i&&"function"!=typeof b)throw"a callback function is required for initialising form data. new Form (formId, [isFromRemote], cb)";if("function"==typeof i){var b=i;i=!1}var j=this;this.refresh(i,function(a,c){try{j.initialise()}catch(d){console.error("Failed to initialise form."),console.error(d)}e[g]=c,b(a,c)})}}var d=c.models.Model;a.Form=b;var e={};return c.utils.extend(b,d),b.prototype.getLastUpdate=function(){return this.get("lastUpdatedTimestamp")},b.prototype.initialise=function(){this.initialisePage(),this.initialiseFields(),this.initialiseRules()},b.prototype.initialiseFields=function(){var a=this.getFieldRef();this.fields={};for(var b in a){var d=a[b],e=d.page,f=d.field;if(void 0==e||void 0==f)throw"Corruptted field reference";var g=this.getFieldDefByIndex(e,f);if(!g)throw"Field def is not found.";var h=new c.models.Field(g,this);this.fields[b]=h}},b.prototype.initialiseRules=function(){this.rules={};for(var a,b=this.getPageRules(),d=this.getFieldRules(),e=[],f=0;a=b[f];f++)e.push({type:"page",definition:a});for(var g,f=0;g=d[f];f++)e.push({type:"field",definition:g});for(var h,f=0;h=e[f];f++)for(var i,j=new c.models.Rule(h),k=j.getRelatedFieldId(),l=0;i=k[l];l++)this.rules[i]||(this.rules[i]=[]),this.rules[i].push(j)},b.prototype.getRulesByFieldId=function(a){return this.rules[a]},b.prototype.initialisePage=function(){var a=this.getPagesDef();this.pages=[];for(var b=0;b<a.length;b++){var d=a[b],e=new c.models.Page(d,this);this.pages.push(e)}},b.prototype.getPageModelList=function(){return this.pages},b.prototype.getName=function(){return this.get("name","")},b.prototype.getDescription=function(){return this.get("description","")},b.prototype.getPageRules=function(){return this.get("pageRules",[])},b.prototype.getFieldRules=function(){return this.get("fieldRules",[])},b.prototype.getFieldRef=function(){return this.get("fieldRef",{})},b.prototype.getPagesDef=function(){return this.get("pages",[])},b.prototype.getPageRef=function(){return this.get("pageRef",{})},b.prototype.getFieldModelById=function(a){return this.fields[a]},b.prototype.getFieldDefByIndex=function(a,b){var c=this.getPagesDef(),d=c[a];if(d){var e=d.fields?d.fields:[],f=e[b];if(f)return f}return null},b.prototype.getPageModelById=function(a){var b=this.getPageRef()[a];if("undefined"==typeof b)throw"page id is not found";return this.pages[b]},b.prototype.newSubmission=function(){return c.models.submission.newInstance(this)},b.prototype.getFormId=function(){return this.get("_id")},b.prototype.removeFromCache=function(){e[this.getFormId()]&&delete e[this.getFormId()]},b.prototype.getFileFieldsId=function(){var a=[];for(var b in this.fields){var c=this.fields[b];"file"==c.getType()&&a.push(b)}return a},b.prototype.getRuleEngine=function(){if(this.rulesEngine)return this.rulesEngine;var a=this.getProps();return this.rulesEngine=new c.RulesEngine(a)},a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"fileSubmission",data:a})}var d=c.models.Model;return a.FileSubmission=b,c.utils.extend(b,d),b.prototype.loadFile=function(a){var b=this.getHashName(),d=this;c.utils.fileSystem.readAsFile(b,function(b,c){b?(console.error(b),a(b)):(d.fileObj=c,a(null))})},b.prototype.getProps=function(){return this.fileObj},b.prototype.setSubmissionId=function(a){this.set("submissionId",a)},b.prototype.getSubmissionId=function(){return this.get("submissionId")},b.prototype.getHashName=function(){return this.get("data").hashName},b.prototype.getFieldId=function(){return this.get("data").fieldId},a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"formSubmission",data:a})}var d=c.models.Model;return a.FormSubmission=b,c.utils.extend(b,d),b.prototype.getProps=function(){return this.get("data")},b.prototype.getFormId=function(){return this.get("data").formId},a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"submissions",_ludid:"submissions_list",submissions:[]})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.setLocalId=function(){throw"It is not allowed to set local id programmly for submissions model."},b.prototype.saveSubmission=function(a,b){this.updateSubmissionWithoutSaving(a),this.saveLocal(b)},b.prototype.updateSubmissionWithoutSaving=function(a){var b=this.pruneSubmission(a),c=b._ludid;if(c){var d=this.findMetaByLocalId(c),e=this.get("submissions");d?(e.splice(e.indexOf(d),1),e.push(b)):e.push(b)}else console.error("Invalid submission:"+JSON.stringify(a))},b.prototype.findByFormId=function(a){for(var b=[],c=this.get("submissions"),d=0;d<c.length;d++){var e=c[d];c[d].formId==a&&b.push(e)}return b},b.prototype.getSubmissions=function(){return this.get("submissions")},b.prototype.getSubmissionMetaList=b.prototype.getSubmissions,b.prototype.findMetaByLocalId=function(a){for(var b=this.get("submissions"),c=0;c<b.length;c++){var d=b[c];if(b[c]._ludid==a)return d}return null},b.prototype.pruneSubmission=function(a){for(var b=["_id","_ludid","status","formName","formId","_localLastUpdate","createDate","submitDate","deviceFormTimestamp"],c=a.getProps(),d={},e=0;e<b.length;e++){var f=b[e];d[f]=c[f]}return d},b.prototype.validateBeforeSubmission=function(){return!0},b.prototype.clear=function(a){var b=this;this.clearLocal(function(c){c?(console.error(c),a(c)):(b.set("submissions",[]),a(null,null))})},b.prototype.getDrafts=function(){return this.findByStatus("draft")},b.prototype.getPending=function(){return this.findByStatus("pending")},b.prototype.getSubmitted=function(){return this.findByStatus("submitted")},b.prototype.getError=function(){return this.findByStatus("error")},b.prototype.getInProgress=function(){return this.findByStatus("inprogress")},b.prototype.findByStatus=function(a){for(var b=this.get("submissions"),c=[],d=0;d<b.length;d++)b[d].status==a&&c.push(b[d]);return c},b.prototype.getSubmissionByMeta=function(a,b){var d=a._ludid;if(!d)throw"local id not found for retrieving submission.";c.models.submission.fromLocal(d,b)},b.prototype.removeSubmission=function(a,b){var c=this.indexOf(a);c>-1&&this.get("submissions").splice(c,1),this.saveLocal(b)},b.prototype.indexOf=function(a){for(var b=this.get("submissions"),c=0;c<b.length;c++){{b[c]}if(b[c]._ludid==a)return c}return-1},a.submissions=new b,a}(c.models||{}),c.models=function(a){function b(a){return new e(a)}function d(a,b){if(f[a])b(null,f[a]);else{var c=new e;c.setLocalId(a),c.loadLocal(function(c,d){c?b(c):d.reloadForm(function(c){c?b(c):(f[a]=d,b(null,d))})})}}function e(a){g.call(this,{_type:"submission"}),"undefined"!=typeof a&&a&&(this.set("formName",a.get("name")),this.set("formId",a.get("_id")),this.set("deviceFormTimestamp",a.getLastUpdate()),this.form=a),this.set("status","new"),this.set("createDate",new Date),this.set("appId",c.config.get("appId")),this.set("appEnvironment",c.config.get("env")),this.set("appCloudName",""),this.set("comments",[]),this.set("formFields",[]),this.set("saveDate",null),this.set("submitDate",null),this.set("uploadStartDate",null),this.set("submittedDate",null),this.transactionMode=!1,this.genLocalId();var b=this.getLocalId();f[b]=this}a.submission={newInstance:b,fromLocal:d};var f={},g=c.models.Model,h={"new":["draft","pending"],draft:["pending","draft"],pending:["inprogress"],inprogress:["submitted","pending","error","inprogress"],submitted:[],error:[]};return c.utils.extend(e,g),e.prototype.saveDraft=function(a){var b="draft",c=this;this.set("timezoneOffset",(new Date).getTimezoneOffset()),this.set("saveDate",new Date),this.changeStatus(b,function(b){return b?a(b):(c.emit("savedraft"),a(null,null),void 0)})},e.prototype.validateField=function(a,b){var c=this;this.getForm(function(d,e){if(d)b(d);else{var f=c.getProps(),g=e.getRuleEngine();g.validateField(a,f,b)}})},e.prototype.checkRules=function(a){var b=this;this.getForm(function(c,d){if(c)a(c);else{var e=b.getProps(),f=d.getRuleEngine();f.checkRules(e,a)}})},e.prototype.submit=function(a){var b="pending",c=this;this.set("timezoneOffset",(new Date).getTimezoneOffset()),this.getForm(function(d,e){var f=e.getRuleEngine(),g=c.getProps();f.validateForm(g,function(d,e){if(d)a(d);else{var f=e.validation;f.valid?(c.set("submitDate",new Date),c.changeStatus(b,function(b){b?a(b):(c.emit("submit"),a(null,null))})):(a("Validation error"),c.emit("validationerror",f))}})})},e.prototype.getUploadTask=function(a){var b=this.getUploadTaskId();b?c.models.uploadManager.getTaskById(b,a):a(null,null)},e.prototype.cancelUploadTask=function(a){var b="submit",d=this;c.models.uploadManager.cancelSubmission(this,function(c){c&&console.error(c),d.changeStatus(b,a)})},e.prototype.getUploadTaskId=function(){return this.get("uploadTaskId")},e.prototype.setUploadTaskId=function(a){this.set("uploadTaskId",a)},e.prototype.submitted=function(a){var b="submitted",c=this;this.set("submittedDate",new Date),this.changeStatus(b,function(b){b?a(b):(c.emit("submitted"),a(null,null))})},e.prototype.genLocalId=function(){var a=c.utils.localId(this),b=this.get("formId")||Math.ceil(1e5*Math.random());this.setLocalId(b+"_"+a)},e.prototype.changeStatus=function(a,b){if(!this.isStatusValid(a))throw"Target status is not valid: "+a;var c=this;this.set("status",a),this.saveLocal(function(a,d){c.saveToList(function(){b(a,d)})})},e.prototype.upload=function(a){var b="inprogress",d=this;this.isStatusValid(b)&&(this.set("status",b),this.set("uploadStartDate",new Date),c.models.submissions.updateSubmissionWithoutSaving(this),c.models.uploadManager.queueSubmission(this,function(b,c){b?a(b):(d.emit("inprogress",c),a(null,c))}))},e.prototype.saveToList=function(a){c.models.submissions.saveSubmission(this,a)},e.prototype.error=function(a,b){this.set("errorMessage",a);var c="error";this.changeStatus(c,b),this.emit("submitted",a)},e.prototype.getStatus=function(){return this.get("status")},e.prototype.isStatusValid=function(a){var b=this.get("status").toLowerCase(),c=h[b];return c.indexOf(a)>-1?!0:!1},e.prototype.addComment=function(a,b){var c=new Date,d=c.getTime(),e={madeBy:"undefined"==typeof b?"":b.toString(),madeOn:c,value:a,timeStamp:d};return this.getComments().push(e),d},e.prototype.getComments=function(){return this.get("comments")},e.prototype.removeComment=function(a){for(var b=this.getComments(),c=0;c<b.length;c++){var d=b[c];if(d.timeStamp==a)return b.splice(c,1),void 0}},e.prototype.addInputValue=function(a,b,c){var d=this;this.getForm(function(e,f){var g=f.getFieldModelById(a);if(d.transactionMode)d.tmpFields[a]||(d.tmpFields[a]=[]),g.processInput(b,function(b,e){b?c(b):(d.tmpFields[a].push(e),c(null,e))});else{var h=d.getInputValueObjectById(a);g.processInput(b,function(a,b){a?c(a):(h.fieldValues.push(b),c(null,b))})}})},e.prototype.getInputValueByFieldId=function(a,b){var c=this.getInputValueObjectById(a).fieldValues;this.getForm(function(d,e){var f=e.getFieldModelById(a);f.convertSubmission(c,b)})},e.prototype.reset=function(){this.set("formFields",[])},e.prototype.startInputTransaction=function(){this.transactionMode=!0,this.tmpFields={}},e.prototype.endInputTransaction=function(a){if(this.transactionMode=!1,a){var b=(this.get("formFields"),this.tmpFields);for(var c in b)for(var d=this.getInputValueObjectById(c),e=b[c],f=0;f<e.length;f++){var g=e[f];d.fieldValues.push(g)}this.tmpFields={}}else this.tmpFields={}},e.prototype.removeFieldValue=function(a,b){var c=[];c=this.transactionMode?this.tmpFields.fieldId:this.getInputValueObjectById(a).fieldId,"undefined"==typeof b?c.splice(0,c.length):c.length>b&&c.splice(b,1)},e.prototype.getInputValueObjectById=function(a){for(var b=this.get("formFields",[]),c=0;c<b.length;c++){var d=b[c];if(d.fieldId==a)return d}var e={fieldId:a,fieldValues:[]};return b.push(e),e},e.prototype.getForm=function(a){var b=c.models.Form,d=this.get("formId");new b({formId:d},a)},e.prototype.reloadForm=function(a){var b=c.models.Form,d=this.get("formId");this.form=new b({formId:d},a)},e.prototype.getFileInputValues=function(){for(var a,b=[],c=this.form.getFileFieldsId(),d=0;a=c[d];d++)for(var e,e,f=this.getInputValueObjectById(a),g=0;e=f.fieldValues[g];g++)e.fieldId=a,b.push(e);return b},e.prototype.clearLocal=function(a){var b=this;g.prototype.clearLocal.call(this,function(d){return d?a(d):(c.models.submissions.removeSubmission(b.getLocalId(),function(d){return d?a(d):(c.models.uploadManager.cancelSubmission(b,a),void 0)}),void 0)})},a}(c.models||{}),c.models=function(a){function b(a,b){d.call(this,{_type:"field"}),a&&(this.fromJSON(a),this.genLocalId()),b&&(this.form=b)}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.isRequired=function(){return this.get("required")},b.prototype.getFieldValidation=function(){return this.getFieldOptions().validation||{}},b.prototype.getFieldDefinition=function(){return this.getFieldOptions().definition||{}},b.prototype.getMinRepeat=function(){var a=this.getFieldDefinition();return a.minRepeat||1},b.prototype.getMaxRepeat=function(){var a=this.getFieldDefinition();return a.maxRepeat||1},b.prototype.getFieldOptions=function(){return this.get("fieldOptions",{validation:{},definition:{}})},b.prototype.isRepeating=function(){return this.get("repeating",!1)},b.prototype.getType=function(){return this.get("type","text")},b.prototype.getFieldId=function(){return this.get("_id","")},b.prototype.getName=function(){return this.get("name","unknown name")},b.prototype.getHelpText=function(){return this.get("helpText","")},b.prototype.processInput=function(a,b){var c=this.getType(),d="process_"+c;return"undefined"==typeof a||null===a?b(null,a):(this[d]&&"function"==typeof this[d]?this[d](a,b):b(null,a),void 0)},b.prototype.convertSubmission=function(a,b){var c=this.getType(),d="convert_"+c;this[d]&&"function"==typeof this[d]?this[d](a,b):b(null,a)},b.prototype.validate=function(a,b){this.form.getRuleEngine().validateFieldValue(this.getFieldId(),a,b)},b.prototype.getRules=function(){var a=this.getFieldId();return this.form.getRulesByFieldId(a)},b.prototype.setVisible=function(a){this.set("visible",a),a?this.emit("visible"):this.emit("hidden")},a.Field=b,a}(c.models||{}),c.models.Field=function(a){return a.prototype.getCheckBoxOptions=function(){var a=this.getFieldDefinition();if(a.checkboxChoices)return a.checkboxChoices;throw"checkbox choice definition is not found in field definition"},a.prototype.process_checkboxes=function(a,b){if(a instanceof Array){var c={selections:a};b(null,c)}else b("the input value for processing checkbox field should be like [val1,val2]")},a.prototype.convert_checkboxes=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d].selections);b(null,c)},a}(c.models.Field||{}),c.models.Field=function(a){function b(a){return a.fileName&&a.fileType&&a.hashName}return a.prototype.process_file=function(a,d){if("undefined"==typeof a||null==a)return d(null,null);if("object"!=typeof a||!a instanceof HTMLInputElement&&!a instanceof File&&!b(a))throw"the input value for file field should be a html file input element or a File object";if(b(a))return d(null,a);var e=a;a instanceof HTMLInputElement&&(e=a.files[0]);var f={fileName:e.name,fileSize:e.size,fileType:e.type,fileUpdateTime:e.lastModifiedDate,hashName:""},g=e.name+Math.ceil(1e5*Math.random());c.utils.md5(g,function(a,b){var h=b;a&&(h=g),f.hashName=h,c.utils.fileSystem.save(h,e,function(a){a?(console.error(a),d(a)):d(null,f)})})},a}(c.models.Field||{}),c.models.Field=function(a){return a.prototype.process_location=function(a,b){var c=this.getFieldDefinition();switch(c.locationUnit){case"latLong":if(a.lat&&a["long"]){var d={lat:a.lat,"long":a.long};b(null,d)}else b("the input values for latlong field is {lat: number, long: number}");break;case"northEast":if(a.zone&&a.eastings&&a.northings){var d={zone:a.zone,eastings:a.eastings,northings:a.northings};b(null,d)}else b("the input values for northeast field is {zone: text, eastings: text, northings:text}")}},a}(c.models.Field||{}),c.models.Field=function(a){return a.prototype.getMatrixRows=function(){var a=this.getFieldDefinition();if(a.rows)return a.rows;throw"matrix rows definition is not found in field definition"},a.prototype.getMatrixCols=function(){var a=this.getFieldDefinition();if(a.columns)return a.columns;throw"matrix columns definition is not found in field definition"},a}(c.models.Field||{}),c.models.Field=function(a){return a.prototype.getRadioOption=function(){var a=this.getFieldDefinition();if(a.options)return a.options;throw"Radio options definition is not found in field definition"},a}(c.models.Field||{}),c.models=function(a){function b(a,b){if("undefined"==typeof a||"undefined"==typeof b)throw"Page initialise failed: new Page(pageDefinitionJSON, parentFormModel)";d.call(this,{_type:"page"}),this.fromJSON(a),this.form=b,this.initialise()}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.initialise=function(){var a=this.getFieldDef();this.fieldsIds=[];for(var b=0;b<a.length;b++)this.fieldsIds.push(a[b]._id)},b.prototype.setVisible=function(a){this.set("visible",a),a?this.emit("visible"):this.emit("hidden")},b.prototype.getName=function(){return this.get("name","")},b.prototype.getDescription=function(){return this.get("description","")},b.prototype.getFieldDef=function(){return this.get("fields",[])},b.prototype.getFieldModelList=function(){for(var a=[],b=0;b<this.fieldsIds.length;b++)a.push(this.form.getFieldModelById(this.fieldsIds[b]));return a},b.prototype.getFieldModelById=function(a){return this.form.getFieldModelById(a)},b.prototype.getPageId=function(){return this.get("_id","")},a.Page=b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"fieldvalidate"})}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.validate=function(a,b){var c=(b.isRequired(),b.getFieldValidation());for(var d in c){if(this[d]&&"function"==typeof this[d]){var e=this[d](a,c[d]);if(e===!0)continue;return e}console.error("Validation method is not found:"+d)}return!0},b.prototype.min=function(a,b){return a>=b?!0:"Min value is "+b+" while input value is "+a},b.prototype.max=function(a,b){return b>=a?!0:"Max value is "+b+" while input value is "+a},b.prototype.minSelected=function(a,b){return"array"==typeof a&&a.length>=b?!0:"Min selected number is "+b},b.prototype.maxSelected=function(a,b){return"array"==typeof a&&a.length<=b?!0:"Max selected number is "+b},a.fieldValidate=new b,a}(c.models||{}),c.models=function(a){function b(){d.call(this,{_type:"uploadManager"}),this.set("taskQueue",[]),this.timeOut=60,this.sending=!1,this.timerInterval=200,this.sendingStart=new Date}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.queueSubmission=function(a,b){var d,e=null,f=this;a.getUploadTaskId()?d=a.getUploadTaskId():(e=c.models.uploadTask.newInstance(a),d=e.getLocalId()),this.push(d),this.timer||this.start(),e?e.saveLocal(function(c){c&&console.error(c),f.saveLocal(function(c){c&&console.error(c),a.setUploadTaskId(d),b(null,e)})}):f.getTaskById(d,b)},b.prototype.cancelSubmission=function(a,b){var c=a.getUploadTaskId(),d=this.get("taskQueue");if(c){var e=d.indexOf(c);e>-1&&d.splice(e,1),this.getTaskById(c,function(a,c){a?(console.error(a),b(c)):c?c.clearLocal(b):b(null,null)})}else b(null,null)},b.prototype.getTaskQueue=function(){return this.get("taskQueue",[])},b.prototype.start=function(){var a=this;this.stop(),this.timer=setInterval(function(){a.tick()},this.timerInterval)},b.prototype.stop=function(){this.timer&&(clearInterval(this.timer),this.timer=null)},b.prototype.push=function(a){this.get("taskQueue").push(a)},b.prototype.shift=function(){return this.get("taskQueue").shift()},b.prototype.rollTask=function(){this.push(this.shift())},b.prototype.tick=function(){if(this.sending){var a=new Date,b=a.getTime()-this.sendingStart.getTime();b>1e3*this.timeOut&&(console.error("Uploading content timeout. it will try to reupload."),this.sending=!1,this.rollTask())}else if(this.hasTask()){this.sending=!0,this.sendingStart=new Date;var c=this;this.getCurrentTask(function(a,b){a||!b?(console.error(a),c.sending=!1):b.isCompleted()?(c.shift(),c.sending=!1,c.saveLocal(function(){})):b.uploadTick(function(a){a&&console.error(a),c.sending=!1})})}else this.stop()},b.prototype.hasTask=function(){return this.get("taskQueue").length>0},b.prototype.getCurrentTask=function(a){var b=this.getTaskQueue()[0];b?this.getTaskById(b,a):a(null,null)},b.prototype.getTaskById=function(a,b){c.models.uploadTask.fromLocal(a,b)},a.uploadManager=new b,a}(c.models||{}),c.models=function(a){function b(a){d.call(this,{_type:"rule"}),this.fromJSON(a)}var d=c.models.Model;return c.utils.extend(b,d),b.prototype.getRelatedFieldId=function(){for(var a,b=this.getDefinition(),c=b.ruleConditionalStatements,d=[],e=0;a=c[e];e++)d.push(a.sourceField);return d},b.prototype.test=function(a){for(var b,c=this.getRelatedFieldId(),d=this.getLogic(),e="or"==d?!1:!0,f=0;b=c[f];f++){var g=a[b];if(g){var h=this.testField(b,g);if("or"==d){if(e=e||h,1==e)return!0}else if(e=e&&h,0==e)return!1}else{if("or"!=d)return!1;e=e||!1}}return e},b.prototype.testField=function(a,b){var d=this.getRuleConditionStatement(a),e=d.restriction,f=d.sourceValue;return c.models.checkRule(e,f,b)},b.prototype.getRuleConditionStatement=function(a){for(var b,c=this.getDefinition().ruleConditionalStatements,d=0;b=c[d];d++)if(b.sourceField==a)return b;return null},b.prototype.getLogic=function(){var a=this.getDefinition();return a.ruleConditionalOperator.toLowerCase()},b.prototype.getDefinition=function(){return this.get("definition")},b.prototype.getAction=function(){var a=this.getDefinition(),b={action:a.type,targetId:"page"==this.get("type")?a.targetPage:a.targetField,targetType:this.get("type")};return b},a.Rule=b,a}(c.models||{}),c.models=function(a){function b(a,b,d){var e=a.toLowerCase().replace(/\s/g,"_"),f=c[e];return f?f(b,d):(console.error("Rule func not found:"+e),!1)}a.checkRule=b;var c={is_not:function(a,b){return a!=b},is_equal_to:function(a,b){return a==b},is_greater_than:function(a,b){return b>a},is_less_than:function(a,b){return a>b},is_on:function(a,b){try{return new Date(a).getTime()==new Date(b).getTime()}catch(c){return console.error(c),!1}},is_before:function(a,b){try{return new Date(a).getTime()>new Date(b).getTime()}catch(c){return console.error(c),!1}},is_after:function(a,b){try{return new Date(a).getTime()<new Date(b).getTime()}catch(c){return console.error(c),!1}},is:function(a,b){return a==b},contains:function(a,b){return b.toString().indexOf(a.toString())>-1},does_not_contain:function(a,b){return-1==b.toString().indexOf(a.toString())},begins_with:function(a,b){return 0==b.toString().indexOf(a.toString())},ends_with:function(a,b){return b.toString().length==b.toString().indexOf(a.toString())+a.toString().length}};return a}(c.models||{}),c.models=function(a){function b(a){var b=new e;return b.init(a),f[b.getLocalId()]=b,b}function d(a,b){if(f[a])return b(null,f[a]);var c=new e;c.setLocalId(a),f[a]=c,c.loadLocal(b)}function e(){g.call(this,{_type:"uploadTask"})}a.uploadTask={newInstance:b,fromLocal:d};var f={},g=c.models.Model;return c.utils.extend(e,g),e.prototype.init=function(a){var b=a.getProps(),c=a.getFileInputValues(),d=a.getLocalId();this.setLocalId(d+"_uploadTask"),this.set("submissionLocalId",d),this.set("jsonTask",b),this.set("fileTasks",[]),this.set("currentTask",null),this.set("completed",!1),this.set("formId",a.get("formId"));for(var e,c=a.getFileInputValues(),f=0;e=c[f];f++)this.addFileTask(e)},e.prototype.getTotalSize=function(){for(var a,b=JSON.stringify(this.get("jsonTask")).length,c=this.get("fileTasks"),d=0,e=0;a=c[e];e++)d+=a.fileSize;return b+d},e.prototype.getUploadedSize=function(){var a=this.getCurrentTask();if(null===a)return 0;for(var b,c=JSON.stringify(this.get("jsonTask")).length,d=this.get("fileTasks"),e=0,f=0;(b=d[f])&&a>f;f++)e+=b.fileSize;return c+e},e.prototype.getRemoteStore=function(){return c.stores.mBaaS},e.prototype.addFileTask=function(a){this.get("fileTasks").push(a)},e.prototype.getCurrentTask=function(){return this.get("currentTask")},e.prototype.isStarted=function(){return null==this.get("currentTask",null)?!1:!0},e.prototype.uploadForm=function(a){var b=this.get("jsonTask"),d=this,e=new c.models.FormSubmission(b);this.getRemoteStore().create(e,function(c,e){if(c)console.error(c),a(c);else{var f=e.submissionId,g=e.updatedFormDefinition;g?d.refreshForm(function(){d.submissionModel(function(b,c){if(c){var b="Form definition is out of date.";d.completed(b),a(b)}})}):(b.lastUpdate=new Date,d.set("submissionId",f),d.set("currentTask",0),d.emit("progress",d.getProgress()),a(null))}})},e.prototype.uploadFile=function(a){if(0==this.get("fileTasks").length)return this.completed(),a(null,null);var b=this.get("submissionId"),d=this;if(b){var e=this.get("currentTask");null==e&&(e=0);var f=this.get("fileTasks",[])[e];if(!f)return a("cannot find file task");var g=new c.models.FileSubmission(f);g.setSubmissionId(b),g.loadFile(function(b){b?a(b):d.getRemoteStore().create(g,function(b,c){if(b)a(b);else if("ok"==c.status){var e=d.get("currentTask");f.updateDate=new Date,e++,d.set("currentTask",e),d.emit("progress",d.getProgress()),d.get("fileTasks").length<=e&&d.completed(),a(null)}else a("File uploading failed.")})})}else this.completed("Failed to upload file. Submission Id not found."),a("Failed to upload file. Submission Id not found.")},e.prototype.uploadTick=function(a){if(this.isCompleted())return a(null,null);var b=this.get("currentTask",null);null===b?this.uploadForm(a):this.uploadFile(a)},e.prototype.completed=function(a){this.set("completed",!0),a&&this.set("error",a),this.submissionModel(function(b,c){a?c.error(a,function(){}):c.submitted(function(){})})},e.prototype.isCompleted=function(){return this.get("completed",!1)},e.prototype.getProgress=function(){var a={formJSON:!1,currentFileIndex:0,totalFiles:this.get("fileTasks").length,totalSize:this.getTotalSize(),uploaded:this.getUploadedSize()},b=this.get("currentTask");return null===b?a:(a.formJSON=!0,a.currentFileIndex=b,a)},e.prototype.refreshForm=function(a){var b=this.get("formId");new c.models.Form({formId:b},function(b,c){b&&console.error(b),c.refresh(!0,function(b){b&&console.error(b),a()})})},e.prototype.submissionModel=function(a){c.models.submission.fromLocal(this.get("submissionLocalId"),function(b,c){b&&console.error(b),a(b,c)})},a}(c.models||{}),c.api=function(a){function b(a,b){var d=a.fromRemote;void 0==d&&(d=!1),c.models.forms.refresh(d,b)}function d(a,b){new c.models.Form(a,b)}function e(a,b){null==f?c.models.submissions.loadLocal(function(a){a?(console.error(a),b(a)):(f=c.models.submissions,b(null,f))}):setTimeout(function(){b(null,f)},0)}a.getForms=b,a.getForm=d,a.getSubmissions=e;var f=null;return"undefined"==typeof $fh&&($fh={}),$fh.forms=a,$fh.forms.config=c.models.config,$fh.forms.init=c.init,a}(c.api||{}),c.RulesEngine=a}(window||module.exports);