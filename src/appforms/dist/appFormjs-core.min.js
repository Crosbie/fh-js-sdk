if("undefined"==typeof window)var window={};!function(){var a=function(b){function c(b,c){"undefined"==typeof c&&(c=b);var d=b.config||{};a.config=a.models.config,a.config.init(d,function(){c()})}return b.init=c,b}(a||{});a.utils=function(a){function b(a,b){if(b.constructor&&b.constructor==Function)for(var c in b.prototype)a.prototype[c]=b.prototype[c];else for(var c in b)a.prototype[c]=b[c]}function c(a){var b=a.getProps(),c=b._id,d=b._type,e=(new Date).getTime();return c&&d?c+"_"+d+"_"+e:c?c+"_"+e:d?d+"_"+e:e}function d(a,b){"undefined"!=typeof $fh&&$fh.hash?$fh.hash({algorithm:"MD5",text:a},function(a){a&&a.hashvalue?b(null,a.hashvalue):b("Crypto failed.")}):b("Crypto not found")}return a.extend=b,a.localId=c,a.md5=d,a}(a.utils||{}),a.utils=function(a){function c(){return n}function d(a,c,d){var e=null,f=0;if("object"==typeof c)if(c instanceof File)e=c,f=e.size;else if(c instanceof Blob)e=c,f=b.size;else{var g=JSON.stringify(c),f=g.length;e=new Blob(g,{type:"text/plain"})}else"string"==typeof c&&(f=c.length,e=new Blob([c],{type:"text/plain"}));k(a,f,{create:!0},function(a,b){a?(console.error(a),d(a)):b.createWriter(function(a){function b(a){return d(null,a)}function c(){a.onwrite=b,a.write(e)}a.onwrite=c,a.truncate(0)},function(a){d("Failed to create file write:"+a)})})}function e(a,b){k(a,0,{},function(a,c){a?(console.error(a),b(a)):c.remove(function(){b(null,null)},function(a){console.error(a),b("Failed to remove file"+a)})})}function f(a,b){j(a,function(a,c){if(a)b(a);else{var d=new FileReader;d.onloadend=function(a){var c=a.target.result;try{c=decodeURIComponent(c)}catch(d){}return b(null,c)},d.readAsText(c)}})}function g(a,b){j(a,function(a,c){if(a)return b(a);var d=new FileReader;d.onloadend=function(a){var c=a.target.result;return b(null,c)},d.readAsDataURL(c)})}function h(a,b){j(a,function(a,c){if(a)return b(a);var d=c.type,e=new FileReader;e.onloadend=function(a){var c=a.target.result,e=new Blob([c],{type:d});b(null,e)},e.readAsArrayBuffer(c)})}function i(a,b){j(a,b)}function j(a,b){k(a,0,{},function(a,c){return a?b(a):(c.file(function(a){b(null,a)},function(a){console.error("Failed to get file:"+a),b(a)}),void 0)})}function k(a,b,c,d){o(p,b,function(e){e.root.getFile(a,c,function(a){d(null,a)},function(e){if("QuotaExceededError"==e.name||10==e.code){var f=1073741824;l(f,function(){k(a,b,c,d)})}else console.error("Failed to get file entry:"+e.message),d(e)})},function(){d("Failed to requestFileSystem")})}function l(a,b){navigator.webkitPersistentStorage?navigator.webkitPersistentStorage.requestQuota(a,function(a){b(null,a)},function(a){b(a,0)}):b(null,a)}function m(){window.requestFileSystem?(o=window.requestFileSystem,n=!0):window.webkitRequestFileSystem?(o=window.webkitRequestFileSystem,n=!0):n=!1,window.LocalFileSystem?p=window.LocalFileSystem.PERSISTENT:window.PERSISTENT&&(p=window.PERSISTENT)}a.fileSystem={isFileSystemAvailable:c,save:d,remove:e,readAsText:f,readAsBlob:h,readAsBase64Encoded:g,readAsFile:i};var n=!1,o=function(){},p=1;return m(),a}(a.utils||{}),a.utils=function(a){function b(){return g}function c(a,b){f(a,b)}function d(a,b){var c=a.width,d=a.height;g?navigator.camera.getPicture(e(b),b,{quality:100,targetWidth:c,targetHeight:d,saveToPhotoAlbum:!1,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.PNG}):h||b("Your device does not support camera.")}function e(a){return function(b){var c="data:image/png;base64,"+b;a(null,c)}}function f(a,b){var c=a.width,d=a.height;i.width=c,i.height=d,j.width=c,j.height=d,k||navigator.getUserMedia({video:!0},function(a){i.src=window.URL.createObjectURL(a),k=a,b(null)},b)}a.takePhoto=d,a.isPhoneGapAvailable=b,a.initHtml5Camera=c;var g=!1,h=!1,i=null,j=null,k=null;return a}(a.utils||{}),a.web=function(a){return a}(a.web||{}),a.web.ajax=function(a){function b(){}function c(a,b){e({url:a,type:"GET",success:function(a){b(null,a)},error:function(a){b(a)}})}function d(a,b,c){var d,f=!1;if("object"==typeof b)if(b instanceof File){f=!0,d=new FormData;var g=b.name;d.append(g,b),b=d}else b=JSON.stringify(b);var h={url:a,type:"POST",data:b,dataType:"json",success:function(a){c(null,a)},error:function(a){c(a)}};0==f&&(h.contentType="application/json"),e(h)}a="undefined"!=typeof $fh&&$fh.__ajax?$fh.__ajax:b,a.get=c,a.post=d;var e=a;return a}(a.web.ajax||{}),a.stores=function(a){function b(a){this.name=a}return a.Store=b,b.prototype.create=function(){throw"Create not implemented:"+this.name},b.prototype.read=function(){throw"Read not implemented:"+this.name},b.prototype.update=function(){throw"Update not implemented:"+this.name},b.prototype.delete=function(){throw"Delete not implemented:"+this.name},b.prototype.upsert=function(){throw"Upsert not implemented:"+this.name},a}(a.stores||{}),a.stores=function(b){function c(){a.stores.Store.call(this,"LocalStorage")}function d(){i()?f.apply({},arguments):e.apply({},arguments)}function e(a,b,c){$fh.data(a,function(c){"undefined"==typeof c&&(c={key:a.key,val:a.val}),"remove"==a.act.toLowerCase()&&b(null,null),b(null,c.val?c.val:null)},c)}function f(a,b,c){function d(a){return"undefined"!=typeof c?c(a,{}):void 0}function e(a,b){a+=$fh.app_props.appid,g.md5(a,function(c,d){c&&(d=a);var e=d+".txt";return"undefined"==typeof navigator.externalstorage?b(e):(navigator.externalstorage.enable(function(a){var c=e;return a.path&&(c=a.path,c.match(/\/$/)||(c+="/"),c+=e),e=c,b(e)},function(){return b(e)}),void 0)})}function f(a,c){e(a,function(a){h.save(a,c,function(a){a?d(a):b(null,c)})})}function i(a){e(a,function(a){h.remove(a,function(a){a?"NotFoundError"==a.name||1==a.code?b(null,null):d(a):b(null,null)})})}function j(a){e(a,function(a){h.readAsText(a,function(a,c){a?"NotFoundError"==a.name||1==a.code?b(null,null):d(a):b(null,c)})})}return"undefined"==typeof a.act?j(a.key):"save"===a.act?f(a.key,a.val):"remove"===a.act?i(a.key):"load"===a.act?j(a.key):"undefined"!=typeof c?c("Action ["+a.act+"] is not defined",{}):void 0}var g=a.utils,h=g.fileSystem,i=function(){};return a.utils.extend(c,a.stores.Store),c.prototype.create=function(a,b){var c=g.localId(a);a.setLocalId(c),this.update(a,b)},c.prototype.read=function(a,b){var c=a.getLocalId();null!=c?d({act:"load",key:c.toString()},b,b):b(null,null)},c.prototype.update=function(a,b){var c=a.getLocalId(),e=a.getProps(),f=JSON.stringify(e);d({act:"save",key:c.toString(),val:f},b,b)},c.prototype.delete=function(a,b){var c=a.getLocalId();d({act:"remove",key:c.toString()},b,b)},c.prototype.upsert=function(a,b){var c=a.getLocalId();null==c?this.create(a,b):this.update(a,b)},c.prototype.switchFileSystem=function(a){i=function(){return a}},c.prototype.defaultStorage=function(){i=function(){return h.isFileSystemAvailable()}},i=function(){return h.isFileSystemAvailable()},b.localStorage=new c,b}(a.stores||{}),a.stores=function(b){function c(){e.call(this,"MBaaS")}function d(b){var c=b.get("_type"),d=a.config.get("cloudHost"),e=a.config.get("mbaasBaseUrl"),f=a.config.get("formUrls");if(!f[c])throw"type not found to get url:"+c;var g=f[c],h=d+e+g,i={};switch(c){case"form":i.formId=b.get("_id");break;case"formSubmission":i.formId=b.getFormId();break;case"fileSubmission":i.submissionId=b.getSubmissionId(),i.hashName=b.getHashName(),i.fieldId=b.getFieldId()}for(var j in i)h=h.replace(":"+j,i[j]);return h}var e=a.stores.Store;return b.mBaaS=new c,a.utils.extend(c,e),c.prototype.create=function(b,c){var e=d(b);a.web.ajax.post(e,b.getProps(),c)},c.prototype.read=function(b,c){var e=d(b);a.web.ajax.get(e,c)},c.prototype.update=function(){},c.prototype.delete=function(){},b}(a.stores||{}),a.stores=function(b){function c(a,b){d.call(this,"DataAgent"),this.remoteStore=a,this.localStore=b}var d=a.stores.Store;return b.DataAgent=c,b.dataAgent=new c(a.stores.mBaaS,a.stores.localStorage),a.utils.extend(c,d),c.prototype.read=function(a,b){var c=this;this.localStore.read(a,function(d,e){d||!e?(d&&console.error(d),c.refreshRead(a,b)):b(null,e,!1)})},c.prototype.refreshRead=function(a,b){var c=this;this.remoteStore.read(a,function(d,e){d?(console.error(d),b(d)):(a.fromJSON(e),c.localStore.upsert(a,function(){var a=Array.prototype.slice.call(arguments,0);a.push(!0),b.apply({},a)}))})},b}(a.stores||{}),a.models=function(b){function c(a){if(this.props={_id:null,_type:null,_ludid:null},this.events={},"undefined"!=typeof a)for(var b in a)this.props[b]=a[b];this.touch()}return b.Model=c,c.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].indexOf(b)<0&&this.events[a].push(b)},c.prototype.off=function(a,b){this.events[a]&&this.events[a].indexOf(b)>=0&&this.events[a].splice(this.events[a].indexOf(b),1)},c.prototype.emit=function(){var a=Array.prototype.slice.call(arguments,0),b=a.shift(),c=this.events[b];if(c&&c.length>0)for(var d=0;d<c.length;d++){var e=c[d];e.apply(this,a)}},c.prototype.getProps=function(){return this.props},c.prototype.get=function(a,b){return"undefined"==typeof this.props[a]?b:this.props[a]},c.prototype.set=function(a,b){this.props[a]=b},c.prototype.setLocalId=function(a){this.set("_ludid",a)},c.prototype.getLocalId=function(){return this.get("_ludid")},c.prototype.fromJSON=function(a){if("string"==typeof a)this.fromJSONStr(a);else for(var b in a)this.set(b,a[b]);this.touch()},c.prototype.fromJSONStr=function(a){try{var b=JSON.parse(a);this.fromJSON(b)}catch(c){console.error(c)}},c.prototype.touch=function(){this.set("_localLastUpdate",(new Date).getTime())},c.prototype.getLocalUpdateTimeStamp=function(){return this.get("_localLastUpdate")},c.prototype.genLocalId=function(){return a.utils.localId(this)},c.prototype.refresh=function(a,b){function c(a,c){!a&&c?(e.fromJSON(c),b(null,e)):b(a,e)}var d=this.getDataAgent(),e=this;"undefined"==typeof b&&(b=a,a=!1),a?d.refreshRead(this,c):d.read(this,c)},c.prototype.loadLocal=function(b){var c=a.stores.localStorage,d=this;c.read(this,function(a,c){a?b(a):(c&&d.fromJSON(c),b(a,d))})},c.prototype.saveLocal=function(b){var c=a.stores.localStorage;c.upsert(this,b)},c.prototype.clearLocal=function(b){var c=a.stores.localStorage;c.delete(this,b)},c.prototype.getDataAgent=function(){return this.dataAgent||this.setDataAgent(a.stores.dataAgent),this.dataAgent},c.prototype.setDataAgent=function(a){this.dataAgent=a},b}(a.models||{}),a.models=function(b){function c(){d.call(this,{_type:"config"})}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.init=function(a,b){this.set("appId",$fh.app_props.appid),this.set("env",$fh.app_props.mode?$fh.app_props.mode:"dev"),this.set("timeoutTime",3e4),this._initMBaaS(),this.fromJSON(a),b()},c.prototype._initMBaaS=function(){var a=$fh.cloud_props,b=$fh.app_props,c=b.host,d=b.mode?b.mode:"dev";a&&a.hosts&&(c=d.indexOf("dev")>-1?a.hosts.debugCloudUrl:a.hosts.releaseCloudUrl),this.set("cloudHost",c),this.set("mbaasBaseUrl","/mbaas");var e=this.get("appId");this.set("formUrls",{forms:"/forms/"+e,form:"/forms/"+e+"/:formId",theme:"/forms/"+e+"/theme",formSubmission:"/forms/:formId/submitFormData",fileSubmission:"/:submissionId/:fieldId/:hashName/submitFormFile"})},b.config=new c,b}(a.models||{}),a.models=function(b){function c(){d.call(this,{_type:"forms",_ludid:"forms_list",loaded:!1})}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.clearAllForms=function(){},c.prototype.isFormUpdated=function(a){var b=a.get("_id"),c=a.getLastUpdate(),d=this.getFormMetaById(b);return d?c==d.lastUpdatedTimestamp:!1},c.prototype.getFormMetaById=function(a){for(var b=this.get("forms"),c=0;c<b.length;c++){var d=b[c];if(d._id==a)return d}return null},c.prototype.size=function(){return this.get("forms").length},c.prototype.setLocalId=function(){throw"forms id cannot be set programmly"},c.prototype.getFormsList=function(){return this.get("forms")},c.prototype.getFormIdByIndex=function(a){return this.getFormsList()[a]._id},b.forms=new c,b}(a.models||{}),a.models=function(b){function c(a,b){var c=a.rawMode,f=a.rawData,g=a.formId;if(!g)throw"Cannot initialise a form object without an id. id:"+g;if(d.call(this,{_id:g,_type:"form"}),e[g])return b(null,e[g]),e[g];if(c===!0){this.fromJSON(f);try{this.initialise()}catch(h){console.error("Failed to initialise form."),console.error(h)}e[g]=this,b(null,this)}else{var i=a.fromRemote;if("function"!=typeof i&&"function"!=typeof b)throw"a callback function is required for initialising form data. new Form (formId, [isFromRemote], cb)";if("function"==typeof i){var b=i;i=!1}var j=this;this.refresh(i,function(a,c){try{j.initialise()}catch(d){console.error("Failed to initialise form."),console.error(d)}e[g]=c,b(a,c)})}}var d=a.models.Model;b.Form=c;var e={};return a.utils.extend(c,d),c.prototype.getLastUpdate=function(){return this.get("lastUpdatedTimestamp")},c.prototype.initialise=function(){this.initialisePage(),this.initialiseFields(),this.initialiseRules()},c.prototype.initialiseFields=function(){var b=this.getFieldRef();this.fields={};for(var c in b){var d=b[c],e=d.page,f=d.field;if(void 0==e||void 0==f)throw"Corruptted field reference";var g=this.getFieldDefByIndex(e,f);if(!g)throw"Field def is not found.";var h=new a.models.Field(g,this);this.fields[c]=h}},c.prototype.initialiseRules=function(){this.rules={};for(var b,c=this.getPageRules(),d=this.getFieldRules(),e=[],f=0;b=c[f];f++)e.push({type:"page",definition:b});for(var g,f=0;g=d[f];f++)e.push({type:"field",definition:g});for(var h,f=0;h=e[f];f++)for(var i,j=new a.models.Rule(h),k=j.getRelatedFieldId(),l=0;i=k[l];l++)this.rules[i]||(this.rules[i]=[]),this.rules[i].push(j)},c.prototype.getRulesByFieldId=function(a){return this.rules[a]},c.prototype.initialisePage=function(){var b=this.getPagesDef();this.pages=[];for(var c=0;c<b.length;c++){var d=b[c],e=new a.models.Page(d,this);this.pages.push(e)}},c.prototype.getPageModelList=function(){return this.pages},c.prototype.getName=function(){return this.get("name","")},c.prototype.getDescription=function(){return this.get("description","")},c.prototype.getPageRules=function(){return this.get("pageRules",[])},c.prototype.getFieldRules=function(){return this.get("fieldRules",[])},c.prototype.getFieldRef=function(){return this.get("fieldRef",{})},c.prototype.getPagesDef=function(){return this.get("pages",[])},c.prototype.getPageRef=function(){return this.get("pageRef",{})},c.prototype.getFieldModelById=function(a){return this.fields[a]},c.prototype.getFieldDefByIndex=function(a,b){var c=this.getPagesDef(),d=c[a];if(d){var e=d.fields?d.fields:[],f=e[b];if(f)return f}return null},c.prototype.getPageModelById=function(a){var b=this.getPageRef()[a];if("undefined"==typeof b)throw"page id is not found";return this.pages[b]},c.prototype.newSubmission=function(){return a.models.submission.newInstance(this)},c.prototype.getFormId=function(){return this.get("_id")},c.prototype.removeFromCache=function(){e[this.getFormId()]&&delete e[this.getFormId()]},c.prototype.getFileFieldsId=function(){var a=[];for(var b in this.fields){var c=this.fields[b];"file"==c.getType()&&a.push(b)}return a},b}(a.models||{}),a.models=function(b){function c(a){d.call(this,{_type:"fileSubmission",data:a})}var d=a.models.Model;return b.FileSubmission=c,a.utils.extend(c,d),c.prototype.loadFile=function(b){var c=this.getHashName(),d=this;a.utils.fileSystem.readAsFile(c,function(a,c){a?(console.error(a),b(a)):(d.fileObj=c,b(null))})},c.prototype.getProps=function(){return this.fileObj},c.prototype.setSubmissionId=function(a){this.set("submissionId",a)},c.prototype.getSubmissionId=function(){return this.get("submissionId")},c.prototype.getHashName=function(){return this.get("data").hashName},c.prototype.getFieldId=function(){return this.get("data").fieldId},b}(a.models||{}),a.models=function(b){function c(a){d.call(this,{_type:"formSubmission",data:a})}var d=a.models.Model;return b.FormSubmission=c,a.utils.extend(c,d),c.prototype.getProps=function(){return this.get("data")},c.prototype.getFormId=function(){return this.get("data").formId},b}(a.models||{}),a.models=function(b){function c(){d.call(this,{_type:"submissions",_ludid:"submissions_list",submissions:[]})}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.setLocalId=function(){throw"It is not allowed to set local id programmly for submissions model."},c.prototype.saveSubmission=function(a,b){this.updateSubmissionWithoutSaving(a),this.saveLocal(b)},c.prototype.updateSubmissionWithoutSaving=function(a){var b=this.pruneSubmission(a),c=b._ludid;if(c){var d=this.findMetaByLocalId(c),e=this.get("submissions");d?(e.splice(e.indexOf(d),1),e.push(b)):e.push(b)}else console.error("Invalid submission:"+JSON.stringify(a))},c.prototype.findByFormId=function(a){for(var b=[],c=this.get("submissions"),d=0;d<c.length;d++){var e=c[d];c[d].formId==a&&b.push(e)}return b},c.prototype.getSubmissions=function(){return this.get("submissions")},c.prototype.getSubmissionMetaList=c.prototype.getSubmissions,c.prototype.findMetaByLocalId=function(a){for(var b=this.get("submissions"),c=0;c<b.length;c++){var d=b[c];if(b[c]._ludid==a)return d}return null},c.prototype.pruneSubmission=function(a){for(var b=["_id","_ludid","status","formName","formId","_localLastUpdate","createDate","submitDate","deviceFormTimestamp"],c=a.getProps(),d={},e=0;e<b.length;e++){var f=b[e];d[f]=c[f]}return d},c.prototype.validateBeforeSubmission=function(){return!0},c.prototype.clear=function(a){var b=this;this.clearLocal(function(c){c?(console.error(c),a(c)):(b.set("submissions",[]),a(null,null))})},c.prototype.getDrafts=function(){return this.findByStatus("draft")},c.prototype.getPending=function(){return this.findByStatus("pending")},c.prototype.getSubmitted=function(){return this.findByStatus("submitted")},c.prototype.getError=function(){return this.findByStatus("error")},c.prototype.getInProgress=function(){return this.findByStatus("inprogress")},c.prototype.findByStatus=function(a){for(var b=this.get("submissions"),c=[],d=0;d<b.length;d++)b[d].status==a&&c.push(b[d]);return c},c.prototype.getSubmissionByMeta=function(b,c){var d=b._ludid;if(!d)throw"local id not found for retrieving submission.";a.models.submission.fromLocal(d,c)},c.prototype.removeSubmission=function(a,b){var c=this.indexOf(a);c>-1&&this.get("submissions").splice(c,1),this.saveLocal(b)},c.prototype.indexOf=function(a){for(var b=this.get("submissions"),c=0;c<b.length;c++){{b[c]}if(b[c]._ludid==a)return c}return-1},b.submissions=new c,b}(a.models||{}),a.models=function(b){function c(a){return new e(a)}function d(a,b){if(f[a])b(null,f[a]);else{var c=new e;c.setLocalId(a),c.loadLocal(function(c,d){c?b(c):d.reloadForm(function(c){c?b(c):(f[a]=d,b(null,d))})})}}function e(b){g.call(this,{_type:"submission"}),"undefined"!=typeof b&&b&&(this.set("formName",b.get("name")),this.set("formId",b.get("_id")),this.set("deviceFormTimestamp",b.getLastUpdate()),this.form=b),this.set("status","new"),this.set("createDate",new Date),this.set("appId",a.config.get("appId")),this.set("appEnvironment",a.config.get("env")),this.set("appCloudName",""),this.set("comments",[]),this.set("formFields",[]),this.set("saveDate",null),this.set("submitDate",null),this.set("uploadStartDate",null),this.set("submittedDate",null),this.transactionMode=!1,this.genLocalId();var c=this.getLocalId();f[c]=this}b.submission={newInstance:c,fromLocal:d};var f={},g=a.models.Model,h={"new":["draft","pending"],draft:["pending","draft"],pending:["inprogress"],inprogress:["submitted","pending","error","inprogress"],submitted:[],error:[]};return a.utils.extend(e,g),e.prototype.saveDraft=function(a){var b="draft",c=this;this.set("timezoneOffset",(new Date).getTimezoneOffset()),this.set("saveDate",new Date),this.changeStatus(b,function(b){return b?a(b):(c.emit("savedraft"),a(null,null),void 0)})},e.prototype.submit=function(a){var b="pending",c=!0,d=this;return this.set("timezoneOffset",(new Date).getTimezoneOffset()),c!==!0?"This should not happen!!":(d.set("submitDate",new Date),d.changeStatus(b,function(b){b?a(b):(d.emit("submit"),a(null,null))}),void 0)},e.prototype.getUploadTask=function(b){var c=this.getUploadTaskId();c?a.models.uploadManager.getTaskById(c,b):b(null,null)},e.prototype.cancelUploadTask=function(b){var c="submit",d=this;a.models.uploadManager.cancelSubmission(this,function(a){a&&console.error(a),d.changeStatus(c,b)})},e.prototype.getUploadTaskId=function(){return this.get("uploadTaskId")},e.prototype.setUploadTaskId=function(a){this.set("uploadTaskId",a)},e.prototype.submitted=function(a){var b="submitted",c=this;this.set("submittedDate",new Date),this.changeStatus(b,function(b){b?a(b):(c.emit("submitted"),a(null,null))})},e.prototype.genLocalId=function(){var b=a.utils.localId(this),c=this.get("formId")||Math.ceil(1e5*Math.random());this.setLocalId(c+"_"+b)},e.prototype.changeStatus=function(a,b){if(!this.isStatusValid(a))throw"Target status is not valid: "+a;var c=this;this.set("status",a),this.saveLocal(function(a,d){c.saveToList(function(){b(a,d)})})},e.prototype.upload=function(b){var c="inprogress",d=this;this.isStatusValid(c)&&(this.set("status",c),this.set("uploadStartDate",new Date),a.models.submissions.updateSubmissionWithoutSaving(this),a.models.uploadManager.queueSubmission(this,function(a,c){a?b(a):(d.emit("inprogress",c),b(null,c))}))},e.prototype.saveToList=function(b){a.models.submissions.saveSubmission(this,b)},e.prototype.error=function(a,b){this.set("errorMessage",a);var c="error";this.changeStatus(c,b),this.emit("submitted",a)},e.prototype.getStatus=function(){return this.get("status")},e.prototype.isStatusValid=function(a){var b=this.get("status").toLowerCase(),c=h[b];return c.indexOf(a)>-1?!0:!1},e.prototype.addComment=function(a,b){var c=new Date,d=c.getTime(),e={madeBy:"undefined"==typeof b?"":b.toString(),madeOn:c,value:a,timeStamp:d};return this.getComments().push(e),d},e.prototype.getComments=function(){return this.get("comments")},e.prototype.removeComment=function(a){for(var b=this.getComments(),c=0;c<b.length;c++){var d=b[c];if(d.timeStamp==a)return b.splice(c,1),void 0}},e.prototype.addInputValue=function(a,b,c){var d=this;this.getForm(function(e,f){var g=f.getFieldModelById(a),h=g.validate(b);if(h===!0)if(d.transactionMode)d.tmpFields[a]||(d.tmpFields[a]=[]),g.processInput(b,function(b,e){b?c(b):(e&&d.tmpFields[a].push(e),c(null,e))});else{var i=d.getInputValueObjectById(a);g.processInput(b,function(a,b){a?c(a):(b&&i.fieldValues.push(b),c(null,b))})}else c(h)})},e.prototype.getInputValueByFieldId=function(a,b){var c=this.getInputValueObjectById(a).fieldValues;this.getForm(function(d,e){var f=e.getFieldModelById(a);f.convertSubmission(c,b)})},e.prototype.reset=function(){this.set("formFields",[])},e.prototype.startInputTransaction=function(){this.transactionMode=!0,this.tmpFields={}},e.prototype.endInputTransaction=function(a){if(this.transactionMode=!1,a){var b=(this.get("formFields"),this.tmpFields);for(var c in b)for(var d=this.getInputValueObjectById(c),e=b[c],f=0;f<e.length;f++){var g=e[f];d.fieldValues.push(g)}this.tmpFields={}}else this.tmpFields={}},e.prototype.removeFieldValue=function(a,b){var c=[];c=this.transactionMode?this.tmpFields.fieldId:this.getInputValueObjectById(a).fieldId,"undefined"==typeof b?c.splice(0,c.length):c.length>b&&c.splice(b,1)},e.prototype.getInputValueObjectById=function(a){for(var b=this.get("formFields",[]),c=0;c<b.length;c++){var d=b[c];if(d.fieldId==a)return d}var e={fieldId:a,fieldValues:[]};return b.push(e),e},e.prototype.getForm=function(b){var c=a.models.Form,d=this.get("formId");new c({formId:d},b)},e.prototype.reloadForm=function(b){var c=a.models.Form,d=this.get("formId");this.form=new c({formId:d},b)},e.prototype.getFileInputValues=function(){for(var a,b=[],c=this.form.getFileFieldsId(),d=0;a=c[d];d++)for(var e,e,f=this.getInputValueObjectById(a),g=0;e=f.fieldValues[g];g++)e.fieldId=a,b.push(e);return b},e.prototype.clearLocal=function(b){var c=this;g.prototype.clearLocal.call(this,function(d){return d?b(d):(a.models.submissions.removeSubmission(c.getLocalId(),function(d){return d?b(d):(a.models.uploadManager.cancelSubmission(c,b),void 0)}),void 0)})},b}(a.models||{}),a.models=function(b){function c(a,b){d.call(this,{_type:"field"}),a&&(this.fromJSON(a),this.genLocalId()),b&&(this.form=b)}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.isRequired=function(){return this.get("required")},c.prototype.getFieldValidation=function(){return this.getFieldOptions().validation||{}},c.prototype.getFieldDefinition=function(){return this.getFieldOptions().definition||{}},c.prototype.getMinRepeat=function(){var a=this.getFieldDefinition();return a.minRepeat||1},c.prototype.getMaxRepeat=function(){var a=this.getFieldDefinition();return a.maxRepeat||1},c.prototype.getFieldOptions=function(){return this.get("fieldOptions",{validation:{},definition:{}})},c.prototype.isRepeating=function(){return this.get("repeating",!1)},c.prototype.getType=function(){return this.get("type","text")},c.prototype.getFieldId=function(){return this.get("_id","")},c.prototype.getName=function(){return this.get("name","unknown name")},c.prototype.getHelpText=function(){return this.get("helpText","")},c.prototype.processInput=function(a,b){var c=this.getType(),d="process_"+c;this[d]&&"function"==typeof this[d]?this[d](a,b):b(null,a)},c.prototype.convertSubmission=function(a,b){var c=this.getType(),d="convert_"+c;this[d]&&"function"==typeof this[d]?this[d](a,b):b(null,a)},c.prototype.validate=function(){return!0},c.prototype.getRules=function(){var a=this.getFieldId();return this.form.getRulesByFieldId(a)},c.prototype.setVisible=function(a){this.set("visible",a),a?this.emit("visible"):this.emit("hidden")},b.Field=c,b}(a.models||{}),a.models.Field=function(a){return a.prototype.getCheckBoxOptions=function(){var a=this.getFieldDefinition();if(a.checkboxChoices)return a.checkboxChoices;throw"checkbox choice definition is not found in field definition"},a.prototype.process_checkboxes=function(a,b){if(a instanceof Array){var c={selections:a};b(null,c)}else b("the input value for processing checkbox field should be like [val1,val2]")},a.prototype.convert_checkboxes=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d].selections);b(null,c)},a}(a.models.Field||{}),a.models.Field=function(b){function c(a){return a.fileName&&a.fileType&&a.hashName}return b.prototype.process_file=function(b,d){if("undefined"==typeof b||null==b)return d(null,null);if("object"!=typeof b||!b instanceof HTMLInputElement&&!b instanceof File&&!c(b))throw"the input value for file field should be a html file input element or a File object";if(c(b))return d(null,b);var e=b;b instanceof HTMLInputElement&&(e=b.files[0]);var f={fileName:e.name,fileSize:e.size,fileType:e.type,fileUpdateTime:e.lastModifiedDate,hashName:""},g=e.name+Math.ceil(1e5*Math.random());a.utils.md5(g,function(b,c){var h=c;b&&(h=g),f.hashName=h,a.utils.fileSystem.save(h,e,function(a){a?(console.error(a),d(a)):d(null,f)})})},b}(a.models.Field||{}),a.models.Field=function(a){return a.prototype.process_locationLatLong=function(a,b){if(a.lat&&a["long"]){var c={lat:a.lat,"long":a.long};b(null,c)}else b("the input values for latlong field is {lat: number, long: number}")},a}(a.models.Field||{}),a.models.Field=function(a){return a.prototype.getMatrixRows=function(){var a=this.getFieldDefinition();if(a.rows)return a.rows;throw"matrix rows definition is not found in field definition"},a.prototype.getMatrixCols=function(){var a=this.getFieldDefinition();if(a.columns)return a.columns;throw"matrix columns definition is not found in field definition"},a}(a.models.Field||{}),a.models.Field=function(a){return a.prototype.process_locationNorthEast=function(a,b){if(a.zone&&a.eastings&&a.northings){var c={zone:a.zone,eastings:a.eastings,northings:a.northings};b(null,c)}else b("the input values for northeast field is {zone: text, eastings: text, northings:text}")},a}(a.models.Field||{}),a.models.Field=function(a){return a.prototype.getRadioOption=function(){var a=this.getFieldDefinition();if(a.options)return a.options;throw"Radio options definition is not found in field definition"},a}(a.models.Field||{}),a.models=function(b){function c(a,b){if("undefined"==typeof a||"undefined"==typeof b)throw"Page initialise failed: new Page(pageDefinitionJSON, parentFormModel)";d.call(this,{_type:"page"}),this.fromJSON(a),this.form=b,this.initialise()}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.initialise=function(){var a=this.getFieldDef();this.fieldsIds=[];for(var b=0;b<a.length;b++)this.fieldsIds.push(a[b]._id)},c.prototype.setVisible=function(a){this.set("visible",a),a?this.emit("visible"):this.emit("hidden")},c.prototype.getName=function(){return this.get("name","")},c.prototype.getDescription=function(){return this.get("description","")},c.prototype.getFieldDef=function(){return this.get("fields",[])},c.prototype.getFieldModelList=function(){for(var a=[],b=0;b<this.fieldsIds.length;b++)a.push(this.form.getFieldModelById(this.fieldsIds[b]));return a},c.prototype.getFieldModelById=function(a){return this.form.getFieldModelById(a)},b.Page=c,b}(a.models||{}),a.models=function(b){function c(){d.call(this,{_type:"fieldvalidate"})}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.validate=function(a,b){var c=(b.isRequired(),b.getFieldValidation());for(var d in c){if(this[d]&&"function"==typeof this[d]){var e=this[d](a,c[d]);if(e===!0)continue;return e}console.error("Validation method is not found:"+d)}return!0},c.prototype.min=function(a,b){return a>=b?!0:"Min value is "+b+" while input value is "+a},c.prototype.max=function(a,b){return b>=a?!0:"Max value is "+b+" while input value is "+a},c.prototype.minSelected=function(a,b){return"array"==typeof a&&a.length>=b?!0:"Min selected number is "+b},c.prototype.maxSelected=function(a,b){return"array"==typeof a&&a.length<=b?!0:"Max selected number is "+b},b.fieldValidate=new c,b}(a.models||{}),a.models=function(b){function c(){d.call(this,{_type:"uploadManager"}),this.set("taskQueue",[]),this.timeOut=60,this.sending=!1,this.timerInterval=200,this.sendingStart=new Date}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.queueSubmission=function(b,c){var d,e=null,f=this;b.getUploadTaskId()?d=b.getUploadTaskId():(e=a.models.uploadTask.newInstance(b),d=e.getLocalId()),this.push(d),this.timer||this.start(),e?e.saveLocal(function(a){a&&console.error(a),f.saveLocal(function(a){a&&console.error(a),b.setUploadTaskId(d),c(null,e)})}):f.getTaskById(d,c)},c.prototype.cancelSubmission=function(a,b){var c=a.getUploadTaskId(),d=this.get("taskQueue");if(c){var e=d.indexOf(c);e>-1&&d.splice(e,1),this.getTaskById(c,function(a,c){a?(console.error(a),b(c)):c?c.clearLocal(b):b(null,null)})}else b(null,null)},c.prototype.getTaskQueue=function(){return this.get("taskQueue",[])},c.prototype.start=function(){var a=this;this.stop(),this.timer=setInterval(function(){a.tick()},this.timerInterval)},c.prototype.stop=function(){this.timer&&(clearInterval(this.timer),this.timer=null)},c.prototype.push=function(a){this.get("taskQueue").push(a)},c.prototype.shift=function(){return this.get("taskQueue").shift()},c.prototype.rollTask=function(){this.push(this.shift())},c.prototype.tick=function(){if(this.sending){var a=new Date,b=a.getTime()-this.sendingStart.getTime();b>1e3*this.timeOut&&(console.error("Uploading content timeout. it will try to reupload."),this.sending=!1,this.rollTask())}else if(this.hasTask()){this.sending=!0,this.sendingStart=new Date;var c=this;this.getCurrentTask(function(a,b){a||!b?(console.error(a),c.sending=!1):b.isCompleted()?(c.shift(),c.sending=!1,c.saveLocal(function(){})):b.uploadTick(function(a){a&&console.error(a),c.sending=!1})})}else this.stop()},c.prototype.hasTask=function(){return this.get("taskQueue").length>0},c.prototype.getCurrentTask=function(a){var b=this.getTaskQueue()[0];b?this.getTaskById(b,a):a(null,null)},c.prototype.getTaskById=function(b,c){a.models.uploadTask.fromLocal(b,c)},b.uploadManager=new c,b}(a.models||{}),a.models=function(b){function c(a){d.call(this,{_type:"rule"}),this.fromJSON(a)}var d=a.models.Model;return a.utils.extend(c,d),c.prototype.getRelatedFieldId=function(){for(var a,b=this.getDefinition(),c=b.ruleConditionalStatements,d=[],e=0;a=c[e];e++)d.push(a.sourceField);
return d},c.prototype.test=function(a){for(var b,c=this.getRelatedFieldId(),d=this.getLogic(),e="or"==d?!1:!0,f=0;b=c[f];f++){var g=a[b];if(g){var h=this.testField(b,g);if("or"==d){if(e=e||h,1==e)return!0}else if(e=e&&h,0==e)return!1}else{if("or"!=d)return!1;e=e||!1}}return e},c.prototype.testField=function(b,c){var d=this.getRuleConditionStatement(b),e=d.restriction,f=d.sourceValue;return a.models.checkRule(e,f,c)},c.prototype.getRuleConditionStatement=function(a){for(var b,c=this.getDefinition().ruleConditionalStatements,d=0;b=c[d];d++)if(b.sourceField==a)return b;return null},c.prototype.getLogic=function(){var a=this.getDefinition();return a.ruleConditionalOperator.toLowerCase()},c.prototype.getDefinition=function(){return this.get("definition")},c.prototype.getAction=function(){var a=this.getDefinition(),b={action:a.type,targetId:"page"==this.get("type")?a.targetPage:a.targetField,targetType:this.get("type")};return b},b.Rule=c,b}(a.models||{}),a.models=function(a){function b(a,b,d){var e=a.toLowerCase().replace(/\s/g,"_"),f=c[e];return f?f(b,d):(console.error("Rule func not found:"+e),!1)}a.checkRule=b;var c={is_not:function(a,b){return a!=b},is_equal_to:function(a,b){return a==b},is_greater_than:function(a,b){return b>a},is_less_than:function(a,b){return a>b},is_on:function(a,b){try{return new Date(a).getTime()==new Date(b).getTime()}catch(c){return console.error(c),!1}},is_before:function(a,b){try{return new Date(a).getTime()>new Date(b).getTime()}catch(c){return console.error(c),!1}},is_after:function(a,b){try{return new Date(a).getTime()<new Date(b).getTime()}catch(c){return console.error(c),!1}},is:function(a,b){return a==b},contains:function(a,b){return b.toString().indexOf(a.toString())>-1},does_not_contain:function(a,b){return-1==b.toString().indexOf(a.toString())},begins_with:function(a,b){return 0==b.toString().indexOf(a.toString())},ends_with:function(a,b){return b.toString().length==b.toString().indexOf(a.toString())+a.toString().length}};return a}(a.models||{}),a.models=function(b){function c(a){var b=new e;return b.init(a),f[b.getLocalId()]=b,b}function d(a,b){if(f[a])return b(null,f[a]);var c=new e;c.setLocalId(a),f[a]=c,c.loadLocal(b)}function e(){g.call(this,{_type:"uploadTask"})}b.uploadTask={newInstance:c,fromLocal:d};var f={},g=a.models.Model;return a.utils.extend(e,g),e.prototype.init=function(a){var b=a.getProps(),c=a.getFileInputValues(),d=a.getLocalId();this.setLocalId(d+"_uploadTask"),this.set("submissionLocalId",d),this.set("jsonTask",b),this.set("fileTasks",[]),this.set("currentTask",null),this.set("completed",!1),this.set("formId",a.get("formId"));for(var e,c=a.getFileInputValues(),f=0;e=c[f];f++)this.addFileTask(e)},e.prototype.getTotalSize=function(){for(var a,b=JSON.stringify(this.get("jsonTask")).length,c=this.get("fileTasks"),d=0,e=0;a=c[e];e++)d+=a.fileSize;return b+d},e.prototype.getUploadedSize=function(){var a=this.getCurrentTask();if(null===a)return 0;for(var b,c=JSON.stringify(this.get("jsonTask")).length,d=this.get("fileTasks"),e=0,f=0;(b=d[f])&&a>f;f++)e+=b.fileSize;return c+e},e.prototype.getRemoteStore=function(){return a.stores.mBaaS},e.prototype.addFileTask=function(a){this.get("fileTasks").push(a)},e.prototype.getCurrentTask=function(){return this.get("currentTask")},e.prototype.isStarted=function(){return null==this.get("currentTask",null)?!1:!0},e.prototype.uploadForm=function(b){var c=this.get("jsonTask"),d=this,e=new a.models.FormSubmission(c);this.getRemoteStore().create(e,function(a,e){if(a)console.error(a),b(a);else{var f=e.submissionId,g=e.updatedFormDefinition;g?d.refreshForm(function(){d.submissionModel(function(a,c){if(c){var a="Form definition is out of date.";d.completed(a),b(a)}})}):(c.lastUpdate=new Date,d.set("submissionId",f),d.set("currentTask",0),d.emit("progress",d.getProgress()),b(null))}})},e.prototype.uploadFile=function(b){if(0==this.get("fileTasks").length)return this.completed(),b(null,null);var c=this.get("submissionId"),d=this;if(c){var e=this.get("currentTask");null==e&&(e=0);var f=this.get("fileTasks",[])[e];if(!f)return b("cannot find file task");var g=new a.models.FileSubmission(f);g.setSubmissionId(c),g.loadFile(function(a){a?b(a):d.getRemoteStore().create(g,function(a,c){if(a)b(a);else if("ok"==c.status){var e=d.get("currentTask");f.updateDate=new Date,e++,d.set("currentTask",e),d.emit("progress",d.getProgress()),d.get("fileTasks").length<=e&&d.completed(),b(null)}else b("File uploading failed.")})})}else this.completed("Failed to upload file. Submission Id not found."),b("Failed to upload file. Submission Id not found.")},e.prototype.uploadTick=function(a){if(this.isCompleted())return a(null,null);var b=this.get("currentTask",null);null===b?this.uploadForm(a):this.uploadFile(a)},e.prototype.completed=function(a){this.set("completed",!0),a&&this.set("error",a),this.submissionModel(function(b,c){a?c.error(a,function(){}):c.submitted(function(){})})},e.prototype.isCompleted=function(){return this.get("completed",!1)},e.prototype.getProgress=function(){var a={formJSON:!1,currentFileIndex:0,totalFiles:this.get("fileTasks").length,totalSize:this.getTotalSize(),uploaded:this.getUploadedSize()},b=this.get("currentTask");return null===b?a:(a.formJSON=!0,a.currentFileIndex=b,a)},e.prototype.refreshForm=function(b){var c=this.get("formId");new a.models.Form({formId:c},function(a,c){a&&console.error(a),c.refresh(!0,function(a){a&&console.error(a),b()})})},e.prototype.submissionModel=function(b){a.models.submission.fromLocal(this.get("submissionLocalId"),function(a,c){a&&console.error(a),b(a,c)})},b}(a.models||{}),a.api=function(b){function c(b,c){var d=b.fromRemote;void 0==d&&(d=!1),a.models.forms.refresh(d,c)}function d(b,c){new a.models.Form(b,c)}function e(b,c){null==f?a.models.submissions.loadLocal(function(b){b?(console.error(b),c(b)):(f=a.models.submissions,c(null,f))}):setTimeout(function(){c(null,f)},0)}b.getForms=c,b.getForm=d,b.getSubmissions=e;var f=null;return"undefined"==typeof $fh&&($fh={}),$fh.forms=b,$fh.forms.config=a.models.config,$fh.forms.init=a.init,b}(a.api||{})}(window||module.exports);