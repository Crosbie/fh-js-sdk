if("undefined"==typeof window)var window={};!function(){var a=function(a){return a.views={},a.models={},a.collections={},a.config={},a.config.validationOn=!1,a.config.getValueOrDefault=function(a){switch(a){case"cam_quality":return 50;case"cam_targetWidth":return 300;case"cam_targetHeight":return 200}},a}(a||{}),b=Backbone.View.extend({onLoad:function(){},onLoadEnd:function(){}}),c=b.extend({events:{"click button#formlist_reload":"reload"},templates:{list:'<ul class="form_list"></ul>',header:"<h2>Your Forms</h2><h4>Choose a form from the list below</h4>",error:'<li><button id="formlist_reload" class="button-block <%= enabledClass %> <%= dataClass %>"><%= name %><div class="loading"></div></button></li>'},initialize:function(){_.bindAll(this,"render","appendForm"),this.views=[],this.model.on("updated",this.render)},reload:function(){var a=this;this.onLoad(),this.model.refresh(!0,function(b,c){this.onLoadEnd(),a.model=c,a.render()})},show:function(){$(this.el).show()},hide:function(){$(this.el).hide()},renderErrorHandler:function(a){try{(null==a||a.match("error_ajaxfail"))&&(a="An unexpected error occurred.")}catch(b){a="An unexpected error occurred."}var c=_.template(this.templates.error,{name:a+"<br/>Please Retry Later",enabledClass:"button-negative",dataClass:"fetched"});$("ul",this.el).append(c)},render:function(){this.options.parentEl.append(this.templates.list);var a=this.model.getFormsList();a.length>0?(this.options.parentEl.find("ul").append(this.templates.header),_(a).forEach(function(a){this.appendForm(a)},this)):this.renderErrorHandler(arguments[1])},appendForm:function(a){var b=new d({model:a});this.views.push(b),$("ul",this.options.parentEl).append(b.render().el)},initFormList:function(a,b){var c=this;$fh.forms.getForms({fromRemote:a},function(a,d){a?b(a):(c.model=d,b(null,c))})}}),d=b.extend({events:{"click button.show.fetched":"show","click button.show.fetch_error":"fetch"},templates:{form_button:'<li><button class="show button-block <%= enabledClass %> <%= dataClass %>"><%= name %><div class="loading"></div></button></li>'},render:function(){var a,b=!0;return a=_.template(this.templates.form_button,{name:this.model.name,enabledClass:b?"button-main":"",dataClass:"fetched"}),this.$el.html(a),this.$el.find("button").not(".fh_full_data_loaded"),this},unrender:function(){$(this.el).remove()},show:function(){var a=this.model._id,b=new e({parentEl:"#backbone #page"});b.loadForm({formId:a},function(){b.render(),Backbone.history.navigate("form",!0)})},fetch:function(){}});FieldView=Backbone.View.extend({className:"field_container",wrapper:'<div id="<%= fieldId %>_<%= index %>" title="<%= helpText %>"><%= title %><%= input %></div>',title:"<label><%= title %></label>",input:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>'/> ",instructions:'<p class="instruct"><%= helpText %></p>',template:[],events:{change:"contentChanged","blur input,select,textarea":"validate"},renderTitle:function(a){var b=this.model.getName(),c=b;return this.model.isRepeating()&&(c+=" ("+(a+1)+") "),_.template(this.title,{title:c})},renderInput:function(a){var b=this.model.getFieldId(),c=this.type||"text";return _.template(this.input,{fieldId:b,index:a,inputType:c})},renderEle:function(a,b,c){var d=this.model.getHelpText(),e=this.model.getFieldId();return _.template(this.wrapper,{fieldId:e,index:c,helpText:d,title:a,input:b})},addElement:function(){var a=this.curRepeat,b=this.renderTitle(a),c=this.renderInput(a),d=this.renderEle(b,c,a);this.$el.append(d),this.curRepeat++,this.onElementShow(a)},onElementShow:function(){},render:function(){var a=this;this.initialRepeat=1,this.maxRepeat=1,this.curRepeat=0,this.model.isRepeating()&&(this.initialRepeat=this.model.getMinRepeat(),this.maxRepeat=this.model.getMaxRepeat());for(var b=0;b<this.initialRepeat;b++)this.addElement();this.options.parentEl.append(this.$el),this.show(),this.$el.hasClass("hide")&&this.hide(!0);var c=this.options.formView.getSubmission();c&&(this.submission=c,this.submission.getInputValueByFieldId(this.model.get("_id"),function(b,c){console.log(b,c),a.value(c)})),this.onRender()},onRender:function(){},initialize:function(){_.bindAll(this,"dumpContent","clearError"),this.model.isRequired()&&this.$el.addClass("required"),this.render()},dumpContent:function(){console.log("Value changed :: "+JSON.stringify(this.value()))},getTopView:function(){var a,b=this.options.parentView;do a=b.options.parentView,a&&(b=a);while(a);return b},validate:function(b){if(a.config.validationOn){var c=$(b.currentTarget),d=c.val(),e=this.model.validate(d);e!==!0?(alert("Error: "+e),this.$el.addClass("error")):this.clearError()}},contentChanged:function(a){var b=$(a.currentTarget),c=b.val(),d=this;if(this.dumpContent(),this.model.validate(c)===!0){var e=this.value();this.options.formView.setInputValue(d.model.getFieldId(),e)}},addRules:function(){},isRequired:function(){return this.model.isRequired()},addValidationRules:function(){"1"===this.model.get("IsRequired")&&this.$el.find("#"+this.model.get("ID")).rules("add",{required:!0})},addSpecialRules:function(){var b=this,c={Show:function(b,c){var d="Field"+c.Setting.FieldName;b?a.views.form.showField(d):a.views.form.hideField(d)},Hide:function(b,c){var d="Field"+c.Setting.FieldName;b?a.views.form.hideField(d):a.views.form.showField(d)}};_(this.model.get("Rules")||[]).each(function(a){var d=_.clone(a);d.pageView=b.options.parentView,d.fn=c[a.Type],b.$el.find("#"+b.model.get("ID")).wufoo_rules("add",d)})},removeRules:function(){this.$el.find("#"+this.model.get("ID")).rules("remove")},hide:function(a){(a||this.$el.is(":visible"))&&(this.$el.hide(),this.removeRules())},renderButton:function(a,b,c){var d=$("<button>");d.addClass("special_button"),d.addClass(c),d.attr("data-index",a),d.text(" "+b);var e=$("<img>");return e.attr("src","./img/"+c+".png"),e.css("height","28px"),e.css("width","28px"),d.prepend(e),this.htmlFromjQuery(d)},addButton:function(a,b,c){var d=this,e=$("<button>");e.addClass("special_button"),e.addClass(b),e.text(" "+c);var f=$("<img>");return f.attr("src","./img/"+b+".png"),f.css("height","28px"),f.css("width","28px"),e.prepend(f),e.click(function(a){return d.action(this),a.preventDefault(),!1}),a.append(e),e},show:function(){this.$el.is(":visible")||this.$el.show()},defaultValue:function(){var a={};return a[this.model.get("_id")]=this.model.get("DefaultVal"),a},htmlFromjQuery:function(a){return $("<div>").append(a.clone()).html()},value:function(a){return a&&!_.isEmpty(a)&&this.valuePopulate(a),this.getValue()},getValue:function(){for(var a=[],b=this.curRepeat,c=0;b>c;c++)a[c]=this.valueFromElement(c);return a},valueFromElement:function(a){var b=this.getWrapper(a);return b.find("input,select,textarea").val()||""},valuePopulate:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.valuePopulateToElement(b,c)}},valuePopulateToElement:function(a,b){var c=this.getWrapper(a);c.find("input,select,textarea").val(b)},getWrapper:function(a){var b=this.model.getFieldId();return this.$el.find("#"+b+"_"+a)},fillArray:function(a,b){for(var c=0;c<a.length;c++)a[c]||(a[c]=b)},clearError:function(){this.$el.find("label[class=error]").remove(),this.$el.removeClass("error"),this.$el.find(".error").removeClass("error")}}),FieldCameraView=FieldView.extend({events:{"click button.remove":"removeThumb","click button.fhcam":"addFromCamera","click button.fhcam_lib":"addFromLibrary"},template:['<label for="<%= id %>"><%= title %></label>','<input id="<%= id %>" name="<%= id %>" type="hidden">','<div class="upload"><p>Please choose a picture</p>',"</div>",'<div class="uploaded"><p>Picture chosen</p>','<img class="imageThumb" width="100%">',"</div>"],initialize:function(){FieldView.prototype.initialize.call(this),_.bindAll(this,"setImageData","imageSelected"),this.on("visible",this.clearError)},render:function(){var a=this;this.$el.append(_.template(this.template.join(""),{id:this.model.get("_id"),title:this.model.get("name")})),this.addButton(this.$el,"fhcam","Capture Photo from Camera"),this.addButton(this.$el,"fhcam_lib","Choose Photo from Library"),this.addButton(this.$el,"remove","Remove Photo","uploaded"),this.setImageData(null,!0),this.$el.hide(),this.options.parentEl.append(this.$el);var b=this.options.formView.getSubmission();b&&(this.submission=b,this.submission.getInputValueByFieldId(this.model.get("_id"),function(b,c){console.log(b,c),a.value(c)})),this.show()},contentChanged:function(){FieldView.prototype.contentChanged.apply(this,arguments),this.clearError()},addButton:function(a,b,c,d,e){var f=$("<button>");f.addClass("special_button"),f.addClass(b),f.text(" "+c);var g=$("<img>");return g.attr("src","./img/"+b+".png"),g.css("height","28px"),g.css("width","28px"),f.prepend(g),"undefined"!=typeof e&&f.click(function(a){return e(),a.preventDefault(),!1}),d&&f.addClass(d),a.append(f),f},getOrder:function(){return this.options.order},setImageData:function(a,b){var c=this.$el.find("#"+this.model.get("_id"));if(a){console.debug("setting imageData:",a.length);var d=a;/\bdata\:image\/.+?\;base64,/.test(d)||(d="data:image/jpeg;base64,"+a),c.val(d),this.$el.find(".imageThumb").attr("src",d),this.$el.find(".upload").hide(),this.$el.find(".uploaded").show(),this.fileData={},this.fileData.fileBase64=d,this.fileData.filename="photo",this.fileData.content_type="image/jpeg"}else c.val(null),this.$el.find(".imageThumb").removeAttr("src"),this.$el.find(".upload").show(),this.$el.find(".uploaded").hide(),delete this.fileData;b||this.contentChanged()},dumpContent:function(){FieldFileView.prototype.dumpContent.call(this)},hasImageData:function(){return this.$el.find("#"+this.model.get("_id")).val().length>0},getImageData:function(){return this.$el.find("#"+this.model.get("_id")).val()},removeThumb:function(a){a.preventDefault(),console.debug("removeThumb"),this.setImageData(null),this.trigger("imageRemoved")},addFromCamera:function(a){a.preventDefault(),this.addImage()},addFromLibrary:function(a){a.preventDefault(),this.addImage(!0)},imageSelected:function(a){this.setImageData(a),this.trigger("imageAdded")},parseCssClassCameraOptions:function(){var a={targetHeight:null,targetWidth:null,quality:null};return a},addImage:function(b){var c={quality:a.config.getValueOrDefault("cam_quality"),targetWidth:a.config.getValueOrDefault("cam_targetWidth"),targetHeight:a.config.getValueOrDefault("cam_targetHeight")},d=this.parseCssClassCameraOptions();c=_.defaults(d,c),"undefined"==typeof navigator.camera?this.imageSelected(this.sampleImage()):(b&&(c.sourceType=Camera.PictureSourceType.PHOTOLIBRARY),a.resumeFetchAllowed=!1,navigator.camera.getPicture(this.imageSelected,function(a){alert("Camera Error: "+a)},c))},show:function(){this.options.initHidden?this.options.initHidden=!1:FieldView.prototype.show.call(this)},value:function(a){return a&&!_.isEmpty(a)&&a[this.model.get("_id")]&&a[this.model.get("_id")].fileBase64&&this.setImageData(a[this.model.get("_id")].fileBase64.replace(/^data:([^,]*,|)/,""),!0),a={},this.fileData&&(a[this.model.get("_id")]=this.fileData),a},sampleImages:["/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAAAAAD/4QMraHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjAtYzA2MCA2MS4xMzQ3NzcsIDIwMTAvMDIvMTItMTc6MzI6MDAgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzUgTWFjaW50b3NoIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjVEMzgyQjRCMTU1MjExRTJBNzNDQzMyMEE5ODI5OEU0IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjVEMzgyQjRDMTU1MjExRTJBNzNDQzMyMEE5ODI5OEU0Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NUQzODJCNDkxNTUyMTFFMkE3M0NDMzIwQTk4Mjk4RTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NUQzODJCNEExNTUyMTFFMkE3M0NDMzIwQTk4Mjk4RTQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAAbGhopHSlBJiZBQi8vL0JHPz4+P0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHAR0pKTQmND8oKD9HPzU/R0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0f/wAARCAAyADIDASIAAhEBAxEB/8QATQABAQAAAAAAAAAAAAAAAAAAAAQBAQEBAAAAAAAAAAAAAAAAAAAEBRABAAAAAAAAAAAAAAAAAAAAABEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8AiASt8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//9k=","iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAALklEQVQYV2NkwAT/oUKMyFIoHKAETBFIDU6FIEUgSaJMBJk0MhQihx2W8IcIAQBhewsKNsLKIgAAAABJRU5ErkJggg==","iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAYUlEQVQYV2NkQAJlM1X/g7hd6bdBFCOyHCNIEigBppElkNkgeYIKYBrwKoQ6A+wEuDtwOQHmLLgbQbqQ3YnubhSfwRTj9DUu3+J0I7oGkPVwXwMZKOEHdCdcPdQJILczAAACnDmkK8T25gAAAABJRU5ErkJggg=="],sampleImage:function(){return window.sampleImageNum=(window.sampleImageNum+=1)%this.sampleImages.length,this.sampleImages[window.sampleImageNum]}}),window.sampleImageNum=-1,FieldCameraGroupView=FieldCameraView.extend({initialize:function(){FieldCameraView.prototype.initialize.call(this);var a=this;this.on("visible",function(){$fh.logger.debug("group visible");var b=this.subviews;_(b).forEach(function(b){a!==b&&b.trigger("visible")})})},render:function(){var a=this;FieldCameraView.prototype.render.call(this),this.options.order=0,this.subviews=[this],this.bind("imageAdded imageRemoved",this.updateFields,this);for(var b=this.model.get("fieldOptions").definition,c=1;c<b.maxRepeat;c++){var d=new FieldCameraView({parentEl:a.options.parentEl,parentView:a.options.parentView,model:a.model,order:c+1,formView:a.options.formView,initHidden:"1"===a.model.IsRequired?!1:!0});d.bind("imageAdded imageRemoved",a.updateFields,a),a.subviews.push(d)}this._optimiseVisibleFields()},updateFields:function(){this._fillBlanks(),this._optimiseVisibleFields()},_fillBlanks:function(){var a=this._getGroupedFields();_(a.optFilled).forEach(function(b){var c=a.empty[0];c&&c.getOrder()<b.getOrder()&&(a.empty.shift(),c.setImageData(b.getImageData(),!0),b.setImageData(null,!1),a.empty.push(b))})},_optimiseVisibleFields:function(){var a=this._getGroupedFields(),b=a.reqFilled.length>=a.req.length?Math.min(a.opt.length,Math.max(0,a.optFilled.length+1)):0;_(a.opt).forEach(function(a,c){b>c?a.show():a.hide()})},_getGroupedFields:function(){var a={req:[],reqEmpty:[],reqFilled:[],opt:[],optEmpty:[],optFilled:[],empty:[]};return _(this.subviews).forEach(function(b){b.isRequired()?(a.req.push(b),b.hasImageData()?a.reqFilled.push(b):(a.reqEmpty.push(b),a.empty.push(b))):(a.opt.push(b),b.hasImageData()?a.optFilled.push(b):(a.optEmpty.push(b),a.empty.push(b)))}),a},value:function(a){return a&&!_.isEmpty(a)&&_(this.subviews).forEach(function(b){FieldCameraView.prototype.value.call(b,a)}),a={},_(this.subviews).forEach(function(b){$.extend(a,FieldCameraView.prototype.value.call(b))}),a}}),FieldCheckboxView=FieldView.extend({choice:'<input data-fieldId="<%= fieldId %>" <%= checked %> data-index="<%= index %>" name="<%= fieldId %>[]" type="checkbox" class="field checkbox" value="<%= value %>" ><label class="choice" ><%= choice %></label><br/>',renderInput:function(a){var b=this.model.getCheckBoxOptions(),c=this.model.getFieldId(),d=this,e="";return $.each(b,function(b,f){e+=_.template(d.choice,{fieldId:c,index:a,choice:f.label,value:f.value,checked:f.selected?"checked='checked'":""})}),e},valueFromElement:function(a){var b=[],c=this.getWrapper(a),d=c.find("input:checked");return d.each(function(){b.push($(this).val())}),b},valuePopulateToElement:function(a,b){var c=this.getWrapper(a);if(b&&!(!b instanceof Array))for(var d=0;d<b.length;d++){var e=b[d];c.find("input[value='"+e+"']").attr("checked","checked")}}}),FieldEmailView=FieldView.extend({type:"email"}),FieldFileView=FieldView.extend({input:"<button style='display:none' data-field='<%= fieldId %>' class='special_button' data-index='<%= index %>'></button><input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>'/> ",type:"file",fileObjs:[],contentChanged:function(a){var b=this,c=a.target,d=$(c),e=d.data().index,f=c.files?c.files[0]:null;if(f){var g={fileName:f.name,fileSize:f.size,fileType:f.type};b.showButton(e,g)}else b.showFile(e)},valueFromElement:function(a){var b=this.getWrapper(a),c=b.find("input[type='file']")[0];return c.files&&c.files.length>0?c.files[0]:this.fileObjs[a]},showButton:function(a,b){var c=this.getWrapper(a),d=c.find("button"),e=c.find("input[type='file']");e.hide(),d.show(),d.text(b.fileName+"("+b.fileSize+")"),d.off("click"),d.on("click",function(){$(this).data().index;e.click()})},showFile:function(a){var b=this.getWrapper(a),c=b.find("button"),d=b.find("input[type='file']");c.off("click"),c.hide(),d.show(),this.fileObjs[a]&&(this.fileObjs[a]=null)},valuePopulateToElement:function(a,b){this.fileObjs[a]=b,b&&this.showButton(a,b)}}),FieldGeoView=FieldView.extend({input:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>' disabled/> ",type:"text",renderInput:function(a){this.locationUnit=this.model.getFieldDefinition().locationUnit;var b="latLong"===this.locationUnit?"Capture Location (Lat/Lon)":"Capture Location (East/North)",c=_.template(this.input,{fieldId:this.model.getFieldId(),index:a,inputType:"text"});return c+=this.renderButton(a,b,"fhgeo")},onRender:function(){var a=this;this.$el.find("button").on("click",function(b){b.preventDefault();var c=$(this),d=c.data().index,e=a.getWrapper(d),f=e.find("input[type='text']");return $fh.geo(function(b){var c;if("latLong"===a.locationUnit)c="("+b.lat+", "+b.lon+")";else if("northEast"===a.locationUnit){var d=a.convertLocation(b);c="("+d.easting+", "+d.northing+")"}f.val(c)},function(){f.attr("placeholder","Location could not be determined")}),f.blur(),!1})},convertLocation:function(a){var b=a.lat,c=a.lon,d={lat:function(){return b},lon:function(){return c}};return OsGridRef.latLongToOsGrid(d)}}),FieldMapView=FieldView.extend({extension_type:"fhmap",input:"<div data-index='<%= index %>' class='fh_map_canvas' style='width:<%= width%>; height:<%= height%>;'></div>",mapSettings:{mapWidth:"100%",mapHeight:"300px",defaultZoom:16,location:{lon:-5.80078125,lat:53.12040528310657}},mapInited:0,maps:[],mapData:[],markers:[],allMapInitFunc:[],renderInput:function(a){return _.template(this.input,{width:this.mapSettings.mapWidth,height:this.mapSettings.mapHeight,index:a})},onMapInit:function(){this.mapInited++,this.mapInited==this.curRepeat&&this.allMapInit()},allMapInit:function(){for(;func=this.allMapInitFunc.shift();)func()},onAllMapInit:function(a){this.mapInited==this.curRepeat?a():-1==this.allMapInitFunc.indexOf(a)&&this.allMapInitFunc.push(a)},onElementShow:function(a){var b=this.getWrapper(a),c=this,d=b.find(".fh_map_canvas")[0];$fh.geo({interval:0},function(b){var e={lat:b.lat,lon:b.lon};$fh.map({target:d,lon:e.lon,lat:e.lat,zoom:c.mapSettings.defaultZoom},function(b){c.maps[a]=b.map;var d=new google.maps.Marker({position:c.maps[a].getCenter(),map:c.maps[a],draggable:!0,animation:google.maps.Animation.DROP,title:"Drag this to set position"});c.markers[a]=d,c.mapData[a]={lat:d.getPosition().lat(),"long":d.getPosition().lng(),zoom:c.mapSettings.defaultZoom},c.onMapInit(a)},function(b){console.error(b),c.onMapInit(a)})})},mapResize:function(){if(this.maps.length>0)for(var a=0;a<this.maps.length;a++){var b=this.maps[a];b&&(google.maps.event.trigger(b,"resize"),b.setCenter(new google.maps.LatLng(this.latLongs[a].lat,this.latLongs[a].long)))}},addValidationRules:function(){},valueFromElement:function(a){var b=this.maps[a],c=this.markers[a];return b&&c?{lat:c.getPosition().lat(),"long":c.getPosition().lng(),zoom:b.getZoom()}:null},valuePopulateToElement:function(a,b){function c(){var c=d.maps[a],e=new google.maps.LatLng(b.lat,b.long);c.setCenter(e),c.setZoom(b.zoom),d.markers[a].setPosition(e)}var d=this;this.onAllMapInit(c)}}),FieldNumberView=FieldView.extend({type:"number"}),FieldPhoneView=FieldView.extend({type:"tel"}),FieldRadioView=FieldView.extend({hidden_field:'<input id="radio<%= id %>" type="hidden" value="" data-type="radio">',choice:'<input data-field="<%= fieldId %>" data-index="<%= index %>" name="<%= fieldId %>_<%= index %>" type="radio" class="field radio" value="<%= value %>" ><label class="choice" ><%= choice %></label><br/>',renderInput:function(a){var b=this.model.getRadioOption(),c=this,d="",e=this.model.getFieldId();return $.each(b,function(b,f){var g=$(_.template(c.choice,{fieldId:e,choice:f.label,value:f.label,index:a}));1==f.checked&&g.attr("checked","checked"),d+=c.htmlFromjQuery(g)}),d},valuePopulateToElement:function(a,b){var c=this.getWrapper(a),d=c.find("input[value='"+b+"']");0==d.length&&(d=c.find("input:first-child")),d.attr("checked","checked")},valueFromElement:function(a){var b=this.getWrapper(a);return b.find("input:checked").val()||this.model.getRadioOption()[0].label}}),FieldSelectView=FieldView.extend({select:"<select data-field='<%= fieldId %>' data-index='<%= index %>'><%= options %></select>",option:'<option value="<%= value %>" <%= selected %>><%= value %></option>',renderInput:function(a){var b=this.model.getFieldId(),c=this.model.get("fieldOptions");c=c.definition.options;var d="",e=this;return $.each(c,function(a,b){d+=_.template(e.option,{value:b.label,selected:b.checked?"selected='selected'":""})}),_.template(this.select,{fieldId:b,index:a,options:d})}}),FieldSignatureView=FieldView.extend({extension_type:"fhsig",templates:{input:'<label for="<%= id %>"><%= title %></label><img class="sigImage"/><input id="<%= id %>" name="<%= id %>" type="hidden">',signaturePad:['<div class="sigPad">','<ul class="sigNav">','<button class="clearButton">Clear</button><button class="cap_sig_done_btn">Done</button>',"</ul>",'<div class="sig sigWrapper">','<canvas class="pad" width="<%= canvasWidth %>" height="<%= canvasHeight %>"></canvas>',"</div>","</div>"]},initialize:function(){FieldView.prototype.initialize.call(this),this.on("visible",this.clearError)},dumpContent:function(){FieldFileView.prototype.dumpContent.call(this)},render:function(){this.$el.append(_.template(this.templates.input,{id:this.model.get("_id"),title:this.model.get("Title")}));this.addButton(this.$el,this.extension_type,"Capture Signature");this.options.parentEl.append(this.$el),console.debug("render html="+this.$el.html()),this.show()},contentChanged:function(){FieldView.prototype.contentChanged.apply(this,arguments),this.clearError()},clearError:function(){var a=this.model.get("_id"),b=this.model.get("value");b&&b.hasOwnProperty(a)&&!this.isEmptyImage(b[a].fileBase64)&&FieldView.prototype.clearError.call(this)},action:function(){$("input",this.$el),this.showSignatureCapture()},showSignatureCapture:function(){var a=this,b=$(window).height(),c=$(window).width(),d=b-70,e=c-2,f=d-20;this.$el.append(_.template(this.templates.signaturePad.join(""),{canvasHeight:d,canvasWidth:e})),console.debug("showSignatureCapture html="+this.$el.html());var g=$(".sigPad",this.$el);g.css({position:"fixed","z-index":9999,width:c+"px",height:b+"px",top:"0px",left:"0px","background-color":"#fff"});var h=$(".sigNav",this.$el).outerHeight();$(".sigPad",this.$el).css({width:"100%",height:b+"px"}),$(".sigWrapper",this.$el).css({height:b-h-20+"px"}),sigPad=$(".sigPad",this.$el).signaturePad({drawOnly:!0,lineTop:f}),$(this.$el).data("sigpadInited",!0),$(".cap_sig_done_btn",this.$el).unbind("click").bind("click",function(b){var c=new LoadingView;c.show("generating signature"),b.preventDefault();var d=sigPad.getSignature();if(d&&d.length){var e=sigPad.getSignatureImage();a.dbgImage("signature field sig[default]=",e),a.isEmptyImage(e)&&(e=sigPad.getSignatureImage("image/png"),a.dbgImage("signature field sig[image/png]=",e)),a.isEmptyImage(e)&&(e=sigPad.getSignatureImage("image/jpeg"),a.dbgImage("signature field sig[image/jpeg]=",e)),a.isEmptyImage(e)&&(e=a.toJpg(),a.dbgImage("signature field sig[encoded jpg]=",e)),a.isEmptyImage(e)&&(e=a.toBmp(),a.dbgImage("signature field sigencoded bmp]=",e));var f=$(".sigImage",a.$el)[0];f.src=e,$("input",a.$el).val(e),a.fileData={},a.fileData.fileBase64=e;var g=a.splitImage(e);a.fileData.content_type=g[0],a.fileData.filename="signature."+g[1]}$(".sigPad",a.$el).hide(),c.hide(),a.contentChanged()})},value:function(a){return a&&!_.isEmpty(a)&&(this.fileData=a[this.model.get("_id")],$(".sigImage",this.$el).attr("src",this.fileData.fileBase64),$("input",this.$el).val(this.fileData.fileBase64)),a={},this.fileData&&(a[this.model.get("_id")]=this.fileData),console.debug("value html="+this.$el.html()),a},dbgImage:function(a,b){console.log(a+(b?b.substring(0,b.indexOf(","))+"[len="+b.length+"]":" empty"))},toJpg:function(a){a=_.extend({},a||{},{quality:100,width:248,height:100});var b=$(".sigPad",self.$el).find("canvas")[0],c=this.scaleCanvas(b,a.width,a.height),d=new JPEGEncoder(a.quality);return d.encode(c.getContext("2d").getImageData(0,0,a.width,a.height))},toBmp:function(a){a=_.extend({},a||{},{quality:100,width:248,height:100});var b,c=$(".sigPad",self.$el).find("canvas")[0],d=this.scaleCanvas(c,a.width,a.height),e=this.readCanvasData(d),f=this.createBMP(e);return b=this.makeDataURI(f,"image/bmp")},readCanvasData:function(a){var b=parseInt(a.width,10),c=parseInt(a.height,10);return a.getContext("2d").getImageData(0,0,b,c)},encodeData:function(a){var b="";if("string"==typeof a)b=a;else for(var c=a,d=0;d<c.length;d++)b+=String.fromCharCode(c[d]);return btoa(b)},createBMP:function(a){var b=[],c=a.width,d=a.height;b.push(66),b.push(77);var e=c*d*3+54;b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),b.push(0),b.push(0),b.push(0),b.push(0),b.push(54),b.push(0),b.push(0),b.push(0);var f=[];f.push(40),f.push(0),f.push(0),f.push(0);var g=c;f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256);var h=d;f.push(h%256),h=Math.floor(h/256),f.push(h%256),h=Math.floor(h/256),f.push(h%256),h=Math.floor(h/256),f.push(h%256),f.push(1),f.push(0),f.push(24),f.push(0),f.push(0),f.push(0),f.push(0),f.push(0);var i=c*d*3;f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256);for(var j=0;16>j;j++)f.push(0);var k=(4-3*c%4)%4,l=a.data,m="",n=d;do{for(var o=c*(n-1)*4,p="",q=0;c>q;q++){var r=4*q;p+=String.fromCharCode(l[o+r+2]),p+=String.fromCharCode(l[o+r+1]),p+=String.fromCharCode(l[o+r])}for(var s=0;k>s;s++)p+=String.fromCharCode(0);m+=p}while(--n);var t=this.encodeData(b.concat(f))+this.encodeData(m);return t},makeDataURI:function(a,b){return"data:"+b+";base64,"+a},scaleCanvas:function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d");return e.drawImage(a,0,0,a.width,a.height,0,0,b,c),d}return a},isEmptyImage:function(a){return null===a||""===a||"data:,"===a},splitImage:function(a){var b="data:",c=";base64,",d=a.indexOf(b),e="image/bmp",f="bmp";if(d>=0){var g=a.indexOf(c,d)+1;e=a.substring(d,g-1),f=e.split("/")[1]}return[e,f]}}),FieldTextView=FieldView.extend({template:['<label class="desc" for="<%= id %>"><%= title %></label>','<input class="field text medium" maxlength="255" id="<%= id %>" name="<%= id %>" type="text" value="<%= defaultVal %>">']}),FieldTextareaView=FieldView.extend({input:"<textarea data-field='<%= fieldId %>' data-index='<%= index %>'  ></textarea>"}),FieldSectionBreak=FieldView.extend({renderEle:function(){return"<hr/>"}}),FieldDateTimeView=FieldView.extend({extension_type:"fhdate",inputTime:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='time'>",inputDate:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='date'>",inputDateTime:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='text'>",renderInput:function(a){var b=this.model.getFieldId(),c=this.getUnit(),d="",e="";"dateTime"==c?(d=this.inputDateTime,e="Get Current Date & Time"):"date"==c?(d=this.inputDate,e="Get Current Date"):"time"==c&&(d=this.inputTime,e="Get Current Time");var f=_.template(d,{fieldId:b,index:a});return f+=this.renderButton(a,e,"fhdate")},getUnit:function(){var a=this.model.getFieldDefinition();return a.dateTimeUnit},onRender:function(){var a=this;this.$el.on("click","button",function(){a.action(this)})},action:function(a){var b=$(a).data().index,c=this,d=new Date;"dateTime"===c.getUnit()?$('input[data-index="'+b+'"]',this.$el).val(c.getDate(d)+" "+c.getTime(d)).blur():"date"===c.getUnit()?$('input[data-index="'+b+'"]',this.$el).val(c.getDate(d)).blur():"time"===c.getUnit()&&$('input[data-index="'+b+'"]',this.$el).val(c.getTime(d)).blur()},getDate:function(a){return"YYYY-MM-DD".replace("YYYY",a.getFullYear()).replace("MM",this.twoDigi(a.getMonth()+1)).replace("DD",this.twoDigi(a.getDate()))},getTime:function(a){return"HH:mm:ss".replace("HH",this.twoDigi(a.getHours())).replace("mm",this.twoDigi(a.getMinutes())).replace("ss",this.twoDigi(a.getSeconds()))},twoDigi:function(a){return 10>a?"0"+a.toString():a.toString()}}),PageView=b.extend({viewMap:{text:FieldTextView,number:FieldNumberView,textarea:FieldTextareaView,radio:FieldRadioView,checkboxes:FieldCheckboxView,dropdown:FieldSelectView,file:FieldFileView,emailAddress:FieldEmailView,phone:FieldPhoneView,location:FieldGeoView,photo:FieldCameraGroupView,signature:FieldSignatureView,locationMap:FieldMapView,dateTime:FieldDateTimeView,sectionBreak:FieldSectionBreak},initialize:function(){var a=this;_.bindAll(this,"render","show","hide"),this.model.on("visible",a.show),this.model.on("hidden",a.hide),this.render()},render:function(){var a=this;this.fieldViews={},this.$el.empty().addClass("page hidden"),this.options.parentEl.append(this.$el);var b=this.model.getFieldModelList();b.forEach(function(b){var c=b.getType();a.viewMap[c]?(console.log("*- "+c),a.fieldViews[b.get("_id")]=new a.viewMap[c]({parentEl:a.$el,parentView:a,model:b,formView:a.options.formView})):console.warn("FIELD NOT SUPPORTED:"+c)})},show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")},showField:function(a){this.fieldViews[a]&&this.fieldViews[a].show()},hideField:function(a){this.fieldViews[a]&&this.fieldViews[a].hide()},isValid:function(){var a=this.$el.find("input,select,option,textarea").not('.validate_ignore,[type!="hidden"]:hidden');return a.length?a.valid():!0},checkRules:function(){var a=this,b={},c={SkipToPage:function(a,c){var d=c.Setting.Page;a&&(b.skipToPage=d)}};return _(this.model.get("Rules")||[]).forEach(function(b,d){var e=a.$el.find("#Field"+b.condition.FieldName+",#radioField"+b.condition.FieldName);if(b.fn=c[b.Type],"radio"===e.data("type")){var f=a.$el.find("#Field"+b.condition.FieldName+"_"+d);f.wufoo_rules("exec",b)}else e.wufoo_rules("exec",b)}),b}});var e=b.extend({pageNum:0,pageCount:0,pageViews:[],submission:null,fieldValue:[],templates:{buttons:'<div id="buttons" class="fh_action_bar"><button class="saveDraft hidden button button-main">Save Draft</button><button class="previous hidden button">Previous</button><button class="next hidden button">Next</button><button class="submit hidden button button-positive">Submit</button></div>'},events:{"click button.next":"nextPage","click button.previous":"prevPage","click button.saveDraft":"saveToDraft","click button.submit":"submit"},initialize:function(){this.el=this.options.parentEl,this.fieldModels=[],this.el.empty()},loadForm:function(a,b){var c=this;a.formId?(this.onLoad(),$fh.forms.getForm(a,function(d,e){if(d)throw d.body;c.form=e,c.params=a,c.initWithForm(e,a),b()})):a.form&&(c.form=a.form,c.params=a,c.initWithForm(a.form,a),b())},readOnly:function(){this.readonly=!0;for(var a,b=0;a=this.fieldViews[b];b++)a.$el.find("button,input,textarea,select").attr("disabled","disabled");this.el.find("button.saveDraft").hide(),this.el.find(" button.submit").hide()
},initWithForm:function(a,b){var c=this;c.formId=a.getFormId(),c.el.empty(),c.model=a,b.submission||(b.submission=c.model.newSubmission()),c.submission=b.submission;for(var d,e=a.getPageModelList(),f=[],g=0;d=e[g];g++){var h=d.getFieldModelList();c.fieldModels=c.fieldModels.concat(h);var i=new PageView({model:d,parentEl:c.el,formView:c});f.push(i)}for(var i,j=[],g=0;i=f[g];g++){var k=i.fieldViews;for(var l in k){var m=k[l];j.push(m),c.readonly&&m.$el.find("input,button,textarea,select").attr("disabled","disabled")}}c.fieldViews=j,c.pageViews=f,c.pageCount=f.length,c.onLoadEnd()},rebindButtons:function(){var a=this;this.el.find("button.next").unbind().bind("click",function(){a.nextPage()}),this.el.find("button.previous").unbind().bind("click",function(){a.prevPage()}),this.el.find("button.saveDraft").unbind().bind("click",function(){a.saveToDraft()}),this.el.find("button.submit").unbind().bind("click",function(){a.submit()})},setSubmission:function(a){this.submission=a},getSubmission:function(){return this.submission},checkPages:function(){0===this.pageNum&&this.pageNum===this.pageCount-1?(this.el.find(" button.previous").hide(),this.el.find("button.next").hide(),this.el.find("button.saveDraft").show(),this.el.find(" button.submit").show(),this.el.find("button").addClass("two_button")):0===this.pageNum?(this.el.find(" button.previous").hide(),this.el.find("button.next").show(),this.el.find("button.saveDraft").show(),this.el.find(" button.submit").hide(),this.el.find("button").addClass("two_button")):this.pageNum===this.pageCount-1?(this.el.find(" button.previous").show(),this.el.find(" button.next").hide(),this.el.find(" button.saveDraft").show(),this.el.find(" button.submit").show(),this.el.find("button").addClass("three_button")):(this.el.find(" button.previous").show(),this.el.find(" button.next").show(),this.el.find(" button.saveDraft").show(),this.el.find(" button.submit").hide(),this.el.find("button").addClass("three_button")),this.readonly&&(this.el.find("button.saveDraft").hide(),this.el.find(" button.submit").hide())},render:function(){this.el.append(this.templates.buttons),this.rebindButtons(),this.pageViews[0].show(),this.checkPages()},nextPage:function(){this.hideAllPages(),this.pageViews[this.pageNum+1].show(),this.pageNum=this.pageNum+1,this.checkPages()},prevPage:function(){this.hideAllPages(),this.pageViews[this.pageNum-1].show(),this.pageNum=this.pageNum-1,this.checkPages()},hideAllPages:function(){this.pageViews.forEach(function(a){a.hide()})},submit:function(){var a=this;return $(".error").length>0?(alert("Please resolve all field validation errors"),void 0):(this.populateFieldViewsToSubmission(function(){a.submission.submit(function(){a.el.empty()})}),void 0)},saveToDraft:function(){var a=this;return $(".error").length>0?(alert("Please resolve all field validation errors"),void 0):(this.populateFieldViewsToSubmission(function(){a.submission.saveDraft(function(){a.el.empty()})}),void 0)},populateFieldViewsToSubmission:function(a){for(var b,c=this.submission,d=this.fieldViews,e=[],f=0;b=d[f];f++)for(var g,h=b.value(),i=b.model.getFieldId(),j=0;g=h[j];j++)e.push({id:i,value:g});var k=e.length;c.reset();for(var l,f=0;l=e[f];f++){var i=l.id,m=l.value;c.addInputValue(i,m,function(b){b&&console.error(b),k--,0==k&&a()})}},setInputValue:function(a,b){for(var c,d=0;c=this.fieldValue[d];d++)c.id==a&&this.fieldValue.splice(d,1);for(var e,d=0;e=b[d];d++)this.fieldValue.push({id:a,value:e});console.log("INPUT VALUE SET",a,b)}}),f=b.extend({events:{"click button#convert":"convert"},templates:{body:'<h1>Insert JSON</h1><textarea id="jsonBox" rows="30" cols="50"></textarea><button id="convert">Convert</button><div id="resultArea"></div>'},el:"#jsonPage",initialize:function(){_.bindAll(this,"render")},show:function(){$(this.el).show()},hide:function(){$(this.el).hide()},render:function(){$(this.el).html(this.templates.body),this.show()},convert:function(){var a=$("#jsonBox").val();try{var b=JSON.parse(a)}catch(c){throw console.log(c),"Invalid JSON object"}var d={formId:(new Date).getTime(),rawMode:!0,rawData:b},f=new e({parentEl:"#backbone #resultArea"});f.loadForm(d,function(){f.render()})}});"undefined"==typeof $fh&&($fh={}),$fh.forms||($fh.forms={}),$fh.forms.renderForm=function(a,b){var c=a.container,d=(a.formId,a.fromRemote||!1,a.type||"backbone"),f=new e({parentEl:c});f.loadForm(a,function(){"backbone"==d?b(null,f):"html"==d&&b(null,f)})},$fh.forms.renderFormList=function(a){var b=a.fromRemote||!1,d=a.parentEl;$fh.forms.getForms({fromRemote:b},function(a,b){formListView=new c({model:b,parentEl:d}),formListView.render()})},$fh.forms.backbone={},$fh.forms.backbone.FormView=e,a.Router=Backbone.Router.extend({routes:{form_list:"form_list",form:"showForm",json:"fromJson",submission:"checkSubmissions","":"startApp"},initialize:function(){},startApp:function(){$fh.forms.getForms({fromRemote:!1},function(a,b){formListView=new c({model:b,parentEl:$("#backbone #formList")}),formListView.render()})},form_list:function(){$("#page").addClass("hidden"),$("#formList").removeClass("hidden"),$("#jsonPage").addClass("hidden")},showForm:function(){$("#jsonPage").addClass("hidden"),$("#formList").addClass("hidden"),$("#page").removeClass("hidden")},checkSubmissions:function(){var a=this;$fh.forms.getSubmissions({},function(b,c){if(b)throw b;subsArr=c.get("submissions"),c.getSubmissionByMeta(subsArr[0],function(b,c){c.get("formFields");a.showForm();var d=new e({parentEl:"#backbone #page"});d.loadForm({formId:"527d4539639f521e0a000004",submission:c},function(){d.render()})})})},fromJson:function(){$("#page").addClass("hidden"),$("#formList").addClass("hidden"),$("#jsonPage").removeClass("hidden"),fromJson=new f,fromJson.render()}}),a.router=new a.Router}(window||module.exports);