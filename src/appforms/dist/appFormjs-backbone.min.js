if("undefined"==typeof window)var window={};!function(){function a(a,b,c){"undefined"==typeof c&&(c=6371),this._lat="number"==typeof a?a:"string"==typeof a&&""!=a.trim()?+a:0/0,this._lon="number"==typeof b?b:"string"==typeof b&&""!=b.trim()?+b:0/0,this._radius="number"==typeof c?c:"string"==typeof c&&""!=trim(b)?+c:0/0}function b(a,b){this.easting=parseInt(a,10),this.northing=parseInt(b,10)}var c={};c.parseDMS=function(a){if("object"==typeof c)throw new TypeError("Geo.parseDMS - dmsStr is [DOM?] object");if("number"==typeof a&&isFinite(a))return Number(a);var b=String(a).trim().replace(/^-/,"").replace(/[NSEW]$/i,"").split(/[^0-9.,]+/);if(""==b[b.length-1]&&b.splice(b.length-1),""==b)return 0/0;switch(b.length){case 3:var c=b[0]/1+b[1]/60+b[2]/3600;break;case 2:var c=b[0]/1+b[1]/60;break;case 1:var c=b[0];break;default:return 0/0}return/^-|[WS]$/i.test(a.trim())&&(c=-c),Number(c)},c.toDMS=function(a,b,c){if("object"==typeof a)throw new TypeError("Geo.toDMS - deg is [DOM?] object");if(isNaN(a))return null;if("undefined"==typeof b&&(b="dms"),"undefined"==typeof c)switch(b){case"d":c=4;break;case"dm":c=2;break;case"dms":c=0;break;default:b="dms",c=0}switch(a=Math.abs(a),b){case"d":e=a.toFixed(c),100>e&&(e="0"+e),10>e&&(e="0"+e),dms=e+"°";break;case"dm":var d=(60*a).toFixed(c),e=Math.floor(d/60),f=(d%60).toFixed(c);100>e&&(e="0"+e),10>e&&(e="0"+e),10>f&&(f="0"+f),dms=e+"°"+f+"′";break;case"dms":var g=(3600*a).toFixed(c),e=Math.floor(g/3600),f=Math.floor(g/60)%60,h=(g%60).toFixed(c);100>e&&(e="0"+e),10>e&&(e="0"+e),10>f&&(f="0"+f),10>h&&(h="0"+h),dms=e+"°"+f+"′"+h+"″"}return dms},c.toLat=function(a,b,d){var e=c.toDMS(a,b,d);return null==e?"â€“":e.slice(1)+(0>a?"S":"N")},c.toLon=function(a,b,d){var e=c.toDMS(a,b,d);return null==e?"â€“":e+(0>a?"W":"E")},c.toBrng=function(a,b,d){a=(Number(a)+360)%360;var e=c.toDMS(a,b,d);return null==e?"â€“":e.replace("360","0")},window.console||(window.console={log:function(){}}),a.prototype.distanceTo=function(a,b){"undefined"==typeof b&&(b=4);var c=this._radius,d=this._lat.toRad(),e=this._lon.toRad(),f=a._lat.toRad(),g=a._lon.toRad(),h=f-d,i=g-e,j=Math.sin(h/2)*Math.sin(h/2)+Math.cos(d)*Math.cos(f)*Math.sin(i/2)*Math.sin(i/2),k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)),l=c*k;return l.toPrecisionFixed(b)},a.prototype.bearingTo=function(a){var b=this._lat.toRad(),c=a._lat.toRad(),d=(a._lon-this._lon).toRad(),e=Math.sin(d)*Math.cos(c),f=Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(d),g=Math.atan2(e,f);return(g.toDeg()+360)%360},a.prototype.finalBearingTo=function(a){var b=a._lat.toRad(),c=this._lat.toRad(),d=(this._lon-a._lon).toRad(),e=Math.sin(d)*Math.cos(c),f=Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(d),g=Math.atan2(e,f);return(g.toDeg()+180)%360},a.prototype.midpointTo=function(b){lat1=this._lat.toRad(),lon1=this._lon.toRad(),lat2=b._lat.toRad();var c=(b._lon-this._lon).toRad(),d=Math.cos(lat2)*Math.cos(c),e=Math.cos(lat2)*Math.sin(c);return lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+d)*(Math.cos(lat1)+d)+e*e)),lon3=lon1+Math.atan2(e,Math.cos(lat1)+d),lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI,new a(lat3.toDeg(),lon3.toDeg())},a.prototype.destinationPoint=function(b,c){c="number"==typeof c?c:"string"==typeof c&&""!=c.trim()?+c:0/0,c/=this._radius,b=b.toRad();var d=this._lat.toRad(),e=this._lon.toRad(),f=Math.asin(Math.sin(d)*Math.cos(c)+Math.cos(d)*Math.sin(c)*Math.cos(b)),g=e+Math.atan2(Math.sin(b)*Math.sin(c)*Math.cos(d),Math.cos(c)-Math.sin(d)*Math.sin(f));return g=(g+3*Math.PI)%(2*Math.PI)-Math.PI,new a(f.toDeg(),g.toDeg())},a.intersection=function(b,c,d,e){return c="number"==typeof c?c:"string"==typeof c&&""!=trim(c)?+c:0/0,e="number"==typeof e?e:"string"==typeof e&&""!=trim(e)?+e:0/0,lat1=b._lat.toRad(),lon1=b._lon.toRad(),lat2=d._lat.toRad(),lon2=d._lon.toRad(),brng13=c.toRad(),brng23=e.toRad(),dLat=lat2-lat1,dLon=lon2-lon1,dist12=2*Math.asin(Math.sqrt(Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2))),0==dist12?null:(brngA=Math.acos((Math.sin(lat2)-Math.sin(lat1)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat1))),isNaN(brngA)&&(brngA=0),brngB=Math.acos((Math.sin(lat1)-Math.sin(lat2)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat2))),Math.sin(lon2-lon1)>0?(brng12=brngA,brng21=2*Math.PI-brngB):(brng12=2*Math.PI-brngA,brng21=brngB),alpha1=(brng13-brng12+Math.PI)%(2*Math.PI)-Math.PI,alpha2=(brng21-brng23+Math.PI)%(2*Math.PI)-Math.PI,0==Math.sin(alpha1)&&0==Math.sin(alpha2)?null:Math.sin(alpha1)*Math.sin(alpha2)<0?null:(alpha3=Math.acos(-Math.cos(alpha1)*Math.cos(alpha2)+Math.sin(alpha1)*Math.sin(alpha2)*Math.cos(dist12)),dist13=Math.atan2(Math.sin(dist12)*Math.sin(alpha1)*Math.sin(alpha2),Math.cos(alpha2)+Math.cos(alpha1)*Math.cos(alpha3)),lat3=Math.asin(Math.sin(lat1)*Math.cos(dist13)+Math.cos(lat1)*Math.sin(dist13)*Math.cos(brng13)),dLon13=Math.atan2(Math.sin(brng13)*Math.sin(dist13)*Math.cos(lat1),Math.cos(dist13)-Math.sin(lat1)*Math.sin(lat3)),lon3=lon1+dLon13,lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI,new a(lat3.toDeg(),lon3.toDeg())))},a.prototype.rhumbDistanceTo=function(a){var b=this._radius,c=this._lat.toRad(),d=a._lat.toRad(),e=(a._lat-this._lat).toRad(),f=Math.abs(a._lon-this._lon).toRad(),g=Math.log(Math.tan(d/2+Math.PI/4)/Math.tan(c/2+Math.PI/4)),h=isFinite(e/g)?e/g:Math.cos(c);Math.abs(f)>Math.PI&&(f=f>0?-(2*Math.PI-f):2*Math.PI+f);var i=Math.sqrt(e*e+h*h*f*f)*b;return i.toPrecisionFixed(4)},a.prototype.rhumbBearingTo=function(a){var b=this._lat.toRad(),c=a._lat.toRad(),d=(a._lon-this._lon).toRad(),e=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(b/2+Math.PI/4));Math.abs(d)>Math.PI&&(d=d>0?-(2*Math.PI-d):2*Math.PI+d);var f=Math.atan2(d,e);return(f.toDeg()+360)%360},a.prototype.rhumbDestinationPoint=function(b,c){var d=this._radius,e=parseFloat(c)/d,f=this._lat.toRad(),g=this._lon.toRad();b=b.toRad();var h=e*Math.cos(b);Math.abs(h)<1e-10&&(h=0);var i=f+h,j=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(f/2+Math.PI/4)),k=isFinite(h/j)?h/j:Math.cos(f),l=e*Math.sin(b)/k;return Math.abs(i)>Math.PI/2&&(i=i>0?Math.PI-i:-Math.PI-i),lon2=(g+l+3*Math.PI)%(2*Math.PI)-Math.PI,new a(i.toDeg(),lon2.toDeg())},a.prototype.rhumbMidpointTo=function(b){lat1=this._lat.toRad(),lon1=this._lon.toRad(),lat2=b._lat.toRad(),lon2=b._lon.toRad(),Math.abs(lon2-lon1)>Math.PI&&(lon1+=2*Math.PI);var c=(lat1+lat2)/2,d=Math.tan(Math.PI/4+lat1/2),e=Math.tan(Math.PI/4+lat2/2),f=Math.tan(Math.PI/4+c/2),g=((lon2-lon1)*Math.log(f)+lon1*Math.log(e)-lon2*Math.log(d))/Math.log(e/d);return isFinite(g)||(g=(lon1+lon2)/2),g=(g+3*Math.PI)%(2*Math.PI)-Math.PI,new a(c.toDeg(),g.toDeg())},a.prototype.lat=function(a,b){return"undefined"==typeof a?this._lat:c.toLat(this._lat,a,b)},a.prototype.lon=function(a,b){return"undefined"==typeof a?this._lon:c.toLon(this._lon,a,b)},a.prototype.toString=function(a,b){return"undefined"==typeof a&&(a="dms"),c.toLat(this._lat,a,b)+", "+c.toLon(this._lon,a,b)},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),"undefined"==typeof Number.prototype.toDeg&&(Number.prototype.toDeg=function(){return 180*this/Math.PI}),"undefined"==typeof Number.prototype.toPrecisionFixed&&(Number.prototype.toPrecisionFixed=function(a){var b=this.toPrecision(a);return b=b.replace(/(.+)e\+(.+)/,function(a,b,c){for(b=b.replace(/\./,""),l=b.length-1;c-->l;)b+="0";return b}),b=b.replace(/(.+)e-(.+)/,function(a,b,c){for(b=b.replace(/\./,"");c-->1;)b="0"+b;return"0."+b})}),"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),window.console||(window.console={log:function(){}}),b.latLongToOsGrid=function(a){var c=a.lat().toRad(),d=a.lon().toRad(),e=6377563.396,f=6356256.91,g=.9996012717,h=49..toRad(),i=(-2).toRad(),j=-1e5,k=4e5,l=1-f*f/(e*e),m=(e-f)/(e+f),n=m*m,o=m*m*m,p=Math.cos(c),q=Math.sin(c),r=e*g/Math.sqrt(1-l*q*q),s=e*g*(1-l)/Math.pow(1-l*q*q,1.5),t=r/s-1,u=(1+m+5/4*n+5/4*o)*(c-h),v=(3*m+3*m*m+21/8*o)*Math.sin(c-h)*Math.cos(c+h),w=(15/8*n+15/8*o)*Math.sin(2*(c-h))*Math.cos(2*(c+h)),x=35/24*o*Math.sin(3*(c-h))*Math.cos(3*(c+h)),y=f*g*(u-v+w-x),z=p*p*p,A=z*p*p,B=Math.tan(c)*Math.tan(c),C=B*B,D=y+j,E=r/2*q*p,F=r/24*q*z*(5-B+9*t),G=r/720*q*A*(61-58*B+C),H=r*p,I=r/6*z*(r/s-B),J=r/120*A*(5-18*B+C+14*t-58*B*t),K=d-i,L=K*K,M=L*K,N=M*K,O=N*K,P=O*K,Q=D+E*L+F*N+G*P,R=k+H*K+I*M+J*O;return new b(R,Q)},b.osGridToLatLong=function(b){var c=b.easting,d=b.northing,e=6377563.396,f=6356256.91,g=.9996012717,h=49*Math.PI/180,i=-2*Math.PI/180,j=-1e5,k=4e5,l=1-f*f/(e*e),m=(e-f)/(e+f),n=m*m,o=m*m*m,p=h,q=0;do{p=(d-j-q)/(e*g)+p;var r=(1+m+5/4*n+5/4*o)*(p-h),s=(3*m+3*m*m+21/8*o)*Math.sin(p-h)*Math.cos(p+h),t=(15/8*n+15/8*o)*Math.sin(2*(p-h))*Math.cos(2*(p+h)),u=35/24*o*Math.sin(3*(p-h))*Math.cos(3*(p+h));q=f*g*(r-s+t-u)}while(d-j-q>=1e-5);var v=Math.cos(p),w=Math.sin(p),x=e*g/Math.sqrt(1-l*w*w),y=e*g*(1-l)/Math.pow(1-l*w*w,1.5),z=x/y-1,A=Math.tan(p),B=A*A,C=B*B,D=C*B,E=1/v,F=x*x*x,G=F*x*x,H=G*x*x,I=A/(2*y*x),J=A/(24*y*F)*(5+3*B+z-9*B*z),K=A/(720*y*G)*(61+90*B+45*C),L=E/x,M=E/(6*F)*(x/y+2*B),N=E/(120*G)*(5+28*B+24*C),O=E/(5040*H)*(61+662*B+1320*C+720*D),P=c-k,Q=P*P,R=Q*P,S=Q*Q,T=R*Q,U=S*Q,V=T*Q;p=p-I*Q+J*S-K*U;var W=i+L*P-M*R+N*T-O*V;return new a(p.toDeg(),W.toDeg())},b.parse=function(a){a=a.trim();var c=a.toUpperCase().charCodeAt(0)-"A".charCodeAt(0),d=a.toUpperCase().charCodeAt(1)-"A".charCodeAt(0);c>7&&c--,d>7&&d--;var e=(c-2)%5*5+d%5,f=19-5*Math.floor(c/5)-Math.floor(d/5);if(0>e||e>6||0>f||f>12)return new b(0/0,0/0);switch(a=a.slice(2).replace(/ /g,""),e+=a.slice(0,a.length/2),f+=a.slice(a.length/2),a.length){case 0:e+="50000",f+="50000";break;case 2:e+="5000",f+="5000";break;case 4:e+="500",f+="500";break;case 6:e+="50",f+="50";break;case 8:e+="5",f+="5";break;case 10:break;default:return new b(0/0,0/0)}return new b(e,f)},b.prototype.toString=function(a){if(a="undefined"==typeof a?10:a,e=this.easting,n=this.northing,0/0==e||0/0==n)return"??";var b=Math.floor(e/1e5),c=Math.floor(n/1e5);if(0>b||b>6||0>c||c>12)return"";var d=19-c-(19-c)%5+Math.floor((b+10)/5),f=5*(19-c)%25+b%5;d>7&&d++,f>7&&f++;var g=String.fromCharCode(d+"A".charCodeAt(0),f+"A".charCodeAt(0));e=Math.floor(e%1e5/Math.pow(10,5-a/2)),n=Math.floor(n%1e5/Math.pow(10,5-a/2));var h=g+" "+e.padLz(a/2)+" "+n.padLz(a/2);return h},"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),"undefined"==typeof String.prototype.padLz&&(Number.prototype.padLz=function(a){for(var b=this.toString(),c=b.length,d=0;a-c>d;d++)b="0"+b;return b}),window.console||(window.console={log:function(){}});var d=function(a){return a.views={},a.models={},a.collections={},a.config={},a.config.validationOn=!0,a.config.getValueOrDefault=function(a){switch(a){case"cam_quality":return 50;case"cam_targetWidth":return 300;case"cam_targetHeight":return 200}},a}(d||{}),f=Backbone.View.extend({onLoad:function(){},onLoadEnd:function(){}}),g=f.extend({events:{"click button#formlist_reload":"reload"},templates:{list:'<ul class="form_list"></ul>',header:"<h2>Your Forms</h2><h4>Choose a form from the list below</h4>",error:'<li><button id="formlist_reload" class="button-block <%= enabledClass %> <%= dataClass %>"><%= name %><div class="loading"></div></button></li>'},initialize:function(){_.bindAll(this,"render","appendForm"),this.views=[],this.model.on("updated",this.render)},reload:function(){var a=this;this.onLoad(),this.model.refresh(!0,function(b,c){this.onLoadEnd(),a.model=c,a.render()})},show:function(){$(this.el).show()},hide:function(){$(this.el).hide()},renderErrorHandler:function(a){try{(null==a||a.match("error_ajaxfail"))&&(a="An unexpected error occurred.")}catch(b){a="An unexpected error occurred."}var c=_.template(this.templates.error,{name:a+"<br/>Please Retry Later",enabledClass:"button-negative",dataClass:"fetched"});$("ul",this.el).append(c)},render:function(){this.options.parentEl.append(this.templates.list);var a=this.model.getFormsList();a.length>0?(this.options.parentEl.find("ul").append(this.templates.header),_(a).forEach(function(a){this.appendForm(a)},this)):this.renderErrorHandler(arguments[1])},appendForm:function(a){var b=new h({model:a});this.views.push(b),$("ul",this.options.parentEl).append(b.render().el)},initFormList:function(a,b){var c=this;$fh.forms.getForms({fromRemote:a},function(a,d){a?b(a):(c.model=d,b(null,c))})}}),h=f.extend({events:{"click button.show.fetched":"show","click button.show.fetch_error":"fetch"},templates:{form_button:'<li><button class="show button-block <%= enabledClass %> <%= dataClass %>"><%= name %><div class="loading"></div></button></li>'},render:function(){var a,b=!0;return a=_.template(this.templates.form_button,{name:this.model.name,enabledClass:b?"button-main":"",dataClass:"fetched"}),this.$el.html(a),this.$el.find("button").not(".fh_full_data_loaded"),this},unrender:function(){$(this.el).remove()},show:function(){var a=this.model._id,b=new i({parentEl:$("#backbone #page")});b.loadForm({formId:a},function(){b.render(),Backbone.history.navigate("form",!0)})},fetch:function(){}});FieldView=Backbone.View.extend({className:"field_container",fieldWrapper:"<div />",wrapper:'<div id="wrapper_<%= fieldId %>_<%= index %>" title="<%= helpText %>"><%= title %><%= input %><label class="error errorMsg"></label></div>',title:"<label><%= title %> </label><%= helpText %>",input:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>'/> ",instructions:'<p class="instruct"><%= helpText %></p>',fieldActionBar:"<div class='fieldActionBar'><button class='addInputBtn special_button two_button'>Add Input</button><button class='special_button two_button removeInputBtn'>Remove Input</button></div>",events:{change:"contentChanged","blur input,select,textarea":"validate","click .addInputBtn":"onAddInput","click .removeInputBtn":"onRemoveInput"},onAddInput:function(){this.addElement(),this.checkActionBar()},onRemoveInput:function(){this.removeElement(),this.checkActionBar()},checkActionBar:function(){var a=this.curRepeat,b=this.maxRepeat,c=this.initialRepeat;b>a?this.$fieldActionBar.find(".addInputBtn").show():this.$fieldActionBar.find(".addInputBtn").hide(),a>c?this.$fieldActionBar.find(".removeInputBtn").show():this.$fieldActionBar.find(".removeInputBtn").hide()},removeElement:function(){var a=this.curRepeat,b=a-1;this.getWrapper(b).remove(),this.curRepeat--},renderTitle:function(a){var b=this.model.getName(),c=b,d="";return this.model.isRepeating()&&(c+=" ("+(a+1)+") "),0==a&&(d=this.renderHelpText()),_.template(this.title,{title:c,helpText:d})},renderInput:function(a){var b=this.model.getFieldId(),c=this.type||"text";return _.template(this.input,{fieldId:b,index:a,inputType:c})},renderEle:function(a,b,c){var d=this.model.getHelpText(),e=this.model.getFieldId();return _.template(this.wrapper,{fieldId:e,index:c,helpText:d,title:a,input:b})},renderHelpText:function(){var a=this.model.getHelpText();return _.template(this.instructions,{helpText:a})},addElement:function(){var a=this.curRepeat,b=this.renderTitle(a),c=this.renderInput(a),d=this.renderEle(b,c,a);this.$fieldWrapper.append(d),this.curRepeat++,this.onElementShow(a)},onElementShow:function(){},render:function(){var a=this;this.initialRepeat=1,this.maxRepeat=1,this.curRepeat=0,this.model.isRepeating()&&(this.initialRepeat=this.model.getMinRepeat(),this.maxRepeat=this.model.getMaxRepeat());for(var b=0;b<this.initialRepeat;b++)this.addElement();this.$el.append(this.$fieldWrapper),this.$el.append(this.$fieldActionBar),this.$el.attr("data-field",this.model.getFieldId()),this.options.parentEl.append(this.$el),this.checkActionBar(),this.show(),this.$el.hasClass("hide")&&this.hide(!0);var c=this.options.formView.getSubmission();c&&(this.submission=c,this.submission.getInputValueByFieldId(this.model.get("_id"),function(b,c){console.log(b,c),a.value(c)})),this.onRender()},onRender:function(){},initialize:function(){_.bindAll(this,"dumpContent","clearError","onAddInput","onRemoveInput"),this.model.isRequired()&&this.$el.addClass("required"),this.$fieldWrapper=$(this.fieldWrapper),this.$fieldActionBar=$(this.fieldActionBar),this.render()},dumpContent:function(){console.log("Value changed :: "+JSON.stringify(this.value()))},getTopView:function(){var a,b=this.options.parentView;do a=b.options.parentView,a&&(b=a);while(a);return b},validate:function(a){if(d.config.validationOn){var b=this,c=$(a.currentTarget),e=c.data().index,f=this.valueFromElement(e),g=this.model.getFieldId();this.model.validate(f,function(a,c){if(a)console.error(a);else{var d=c.validation[g];if(d.valid)b.clearError(e);else{var f=d.errorMessages.join(", ");b.setErrorText(e,f)}}}),this.trigger("checkrules")}},setErrorText:function(a,b){var c=this.getWrapper(a);c.find("label.errorMsg").text(b),c.find("label.errorMsg").show(),c.find("label.errorMsg").addClass("error"),c.find("input,textarea,select").addClass("error")},contentChanged:function(a){{var b=$(a.currentTarget);b.val()}this.dumpContent()},addRules:function(){},isRequired:function(){return this.model.isRequired()},addValidationRules:function(){"1"===this.model.get("IsRequired")&&this.$el.find("#"+this.model.get("ID")).rules("add",{required:!0})},addSpecialRules:function(){var a=this,b={Show:function(a,b){var c="Field"+b.Setting.FieldName;a?d.views.form.showField(c):d.views.form.hideField(c)},Hide:function(a,b){var c="Field"+b.Setting.FieldName;a?d.views.form.hideField(c):d.views.form.showField(c)}};_(this.model.get("Rules")||[]).each(function(c){var d=_.clone(c);d.pageView=a.options.parentView,d.fn=b[c.Type],a.$el.find("#"+a.model.get("ID")).wufoo_rules("add",d)})},removeRules:function(){this.$el.find("#"+this.model.get("ID")).rules("remove")},hide:function(a){(a||this.$el.is(":visible"))&&this.$el.hide()},renderButton:function(a,b,c){var d=$("<button>");d.addClass("special_button"),d.addClass(c),d.attr("data-index",a),d.text(" "+b);var e=$("<img>");return e.attr("src","./img/"+c+".png"),e.css("height","28px"),e.css("width","28px"),d.prepend(e),this.htmlFromjQuery(d)},addButton:function(a,b,c){var d=this,e=$("<button>");e.addClass("special_button"),e.addClass(b),e.text(" "+c);var f=$("<img>");return f.attr("src","./img/"+b+".png"),f.css("height","28px"),f.css("width","28px"),e.prepend(f),e.click(function(a){return d.action(this),a.preventDefault(),!1}),a.append(e),e},show:function(){this.$el.is(":visible")||this.$el.show()},defaultValue:function(){var a={};return a[this.model.get("_id")]=this.model.get("DefaultVal"),a},htmlFromjQuery:function(a){return $("<div>").append(a.clone()).html()},value:function(a){return a&&!_.isEmpty(a)&&this.valuePopulate(a),this.getValue()},getValue:function(){for(var a=[],b=this.curRepeat,c=0;b>c;c++)a[c]=this.valueFromElement(c);return a},valueFromElement:function(a){var b=this.getWrapper(a);return b.find("input,select,textarea").val()||""},valuePopulate:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.valuePopulateToElement(b,c)}},valuePopulateToElement:function(a,b){var c=this.getWrapper(a);c.find("input,select,textarea").val(b)},getWrapper:function(a){var b=this.model.getFieldId();return this.$fieldWrapper.find("#wrapper_"+b+"_"+a)},fillArray:function(a,b){for(var c=0;c<a.length;c++)a[c]||(a[c]=b)},clearError:function(a){var b=this.getWrapper(a);b.find("label.errorMsg").hide(),b.find(".error").removeClass("error")}}),FieldCameraView=FieldView.extend({events:{"click button.remove":"removeThumb","click button.fhcam":"addFromCamera","click button.fhcam_lib":"addFromLibrary"},template:['<label for="<%= id %>"><%= title %></label>','<input id="<%= id %>" name="<%= id %>" type="hidden">','<div class="upload"><p>Please choose a picture</p>',"</div>",'<div class="uploaded"><p>Picture chosen</p>','<img class="imageThumb" width="100%">',"</div>"],initialize:function(){FieldView.prototype.initialize.call(this),_.bindAll(this,"setImageData","imageSelected"),this.on("visible",this.clearError)},render:function(){var a=this;this.$el.append(_.template(this.template.join(""),{id:this.model.get("_id"),title:this.model.get("name")})),this.addButton(this.$el,"fhcam","Capture Photo from Camera"),this.addButton(this.$el,"fhcam_lib","Choose Photo from Library"),this.addButton(this.$el,"remove","Remove Photo","uploaded"),this.setImageData(null,!0),this.$el.hide(),this.options.parentEl.append(this.$el);var b=this.options.formView.getSubmission();b&&(this.submission=b,this.submission.getInputValueByFieldId(this.model.get("_id"),function(b,c){console.log(b,c),a.value(c)})),this.show()},contentChanged:function(){FieldView.prototype.contentChanged.apply(this,arguments),this.clearError()},addButton:function(a,b,c,d,e){var f=$("<button>");f.addClass("special_button"),f.addClass(b),f.text(" "+c);var g=$("<img>");return g.attr("src","./img/"+b+".png"),g.css("height","28px"),g.css("width","28px"),f.prepend(g),"undefined"!=typeof e&&f.click(function(a){return e(),a.preventDefault(),!1}),d&&f.addClass(d),a.append(f),f},getOrder:function(){return this.options.order},setImageData:function(a,b){var c=this.$el.find("#"+this.model.get("_id"));if(a){console.debug("setting imageData:",a.length);var d=a;/\bdata\:image\/.+?\;base64,/.test(d)||(d="data:image/jpeg;base64,"+a),c.val(d),this.$el.find(".imageThumb").attr("src",d),this.$el.find(".upload").hide(),this.$el.find(".uploaded").show(),this.fileData={},this.fileData.fileBase64=d,this.fileData.filename="photo",this.fileData.content_type="image/jpeg"}else c.val(null),this.$el.find(".imageThumb").removeAttr("src"),this.$el.find(".upload").show(),this.$el.find(".uploaded").hide(),delete this.fileData;b||this.contentChanged()},dumpContent:function(){FieldFileView.prototype.dumpContent.call(this)},hasImageData:function(){return this.$el.find("#"+this.model.get("_id")).val().length>0},getImageData:function(){return this.$el.find("#"+this.model.get("_id")).val()},removeThumb:function(a){a.preventDefault(),console.debug("removeThumb"),this.setImageData(null),this.trigger("imageRemoved")},addFromCamera:function(a){a.preventDefault(),this.addImage()},addFromLibrary:function(a){a.preventDefault(),this.addImage(!0)},imageSelected:function(a){this.setImageData(a),this.trigger("imageAdded")},parseCssClassCameraOptions:function(){var a={targetHeight:null,targetWidth:null,quality:null};return a},addImage:function(a){var b={quality:d.config.getValueOrDefault("cam_quality"),targetWidth:d.config.getValueOrDefault("cam_targetWidth"),targetHeight:d.config.getValueOrDefault("cam_targetHeight")},c=this.parseCssClassCameraOptions();b=_.defaults(c,b),"undefined"==typeof navigator.camera?this.imageSelected(this.sampleImage()):(a&&(b.sourceType=Camera.PictureSourceType.PHOTOLIBRARY),d.resumeFetchAllowed=!1,navigator.camera.getPicture(this.imageSelected,function(a){alert("Camera Error: "+a)},b))},show:function(){this.options.initHidden?this.options.initHidden=!1:FieldView.prototype.show.call(this)},value:function(a){return a&&!_.isEmpty(a)&&a[this.model.get("_id")]&&a[this.model.get("_id")].fileBase64&&this.setImageData(a[this.model.get("_id")].fileBase64.replace(/^data:([^,]*,|)/,""),!0),a={},this.fileData&&(a[this.model.get("_id")]=this.fileData),a},sampleImages:["/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAAAAAD/4QMraHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjAtYzA2MCA2MS4xMzQ3NzcsIDIwMTAvMDIvMTItMTc6MzI6MDAgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzUgTWFjaW50b3NoIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjVEMzgyQjRCMTU1MjExRTJBNzNDQzMyMEE5ODI5OEU0IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjVEMzgyQjRDMTU1MjExRTJBNzNDQzMyMEE5ODI5OEU0Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NUQzODJCNDkxNTUyMTFFMkE3M0NDMzIwQTk4Mjk4RTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NUQzODJCNEExNTUyMTFFMkE3M0NDMzIwQTk4Mjk4RTQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAAbGhopHSlBJiZBQi8vL0JHPz4+P0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHAR0pKTQmND8oKD9HPzU/R0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0dHR0f/wAARCAAyADIDASIAAhEBAxEB/8QATQABAQAAAAAAAAAAAAAAAAAAAAQBAQEBAAAAAAAAAAAAAAAAAAAEBRABAAAAAAAAAAAAAAAAAAAAABEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8AiASt8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//9k=","iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAALklEQVQYV2NkwAT/oUKMyFIoHKAETBFIDU6FIEUgSaJMBJk0MhQihx2W8IcIAQBhewsKNsLKIgAAAABJRU5ErkJggg==","iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAYUlEQVQYV2NkQAJlM1X/g7hd6bdBFCOyHCNIEigBppElkNkgeYIKYBrwKoQ6A+wEuDtwOQHmLLgbQbqQ3YnubhSfwRTj9DUu3+J0I7oGkPVwXwMZKOEHdCdcPdQJILczAAACnDmkK8T25gAAAABJRU5ErkJggg=="],sampleImage:function(){return window.sampleImageNum=(window.sampleImageNum+=1)%this.sampleImages.length,this.sampleImages[window.sampleImageNum]}}),window.sampleImageNum=-1,FieldCameraGroupView=FieldCameraView.extend({initialize:function(){FieldCameraView.prototype.initialize.call(this);var a=this;this.on("visible",function(){$fh.logger.debug("group visible");var b=this.subviews;_(b).forEach(function(b){a!==b&&b.trigger("visible")})})},render:function(){var a=this;FieldCameraView.prototype.render.call(this),this.options.order=0,this.subviews=[this],this.bind("imageAdded imageRemoved",this.updateFields,this);for(var b=this.model.get("fieldOptions").definition,c=1;c<b.maxRepeat;c++){var d=new FieldCameraView({parentEl:a.options.parentEl,parentView:a.options.parentView,model:a.model,order:c+1,formView:a.options.formView,initHidden:"1"===a.model.IsRequired?!1:!0});d.bind("imageAdded imageRemoved",a.updateFields,a),a.subviews.push(d)}this._optimiseVisibleFields()},updateFields:function(){this._fillBlanks(),this._optimiseVisibleFields()},_fillBlanks:function(){var a=this._getGroupedFields();_(a.optFilled).forEach(function(b){var c=a.empty[0];c&&c.getOrder()<b.getOrder()&&(a.empty.shift(),c.setImageData(b.getImageData(),!0),b.setImageData(null,!1),a.empty.push(b))})},_optimiseVisibleFields:function(){var a=this._getGroupedFields(),b=a.reqFilled.length>=a.req.length?Math.min(a.opt.length,Math.max(0,a.optFilled.length+1)):0;_(a.opt).forEach(function(a,c){b>c?a.show():a.hide()})},_getGroupedFields:function(){var a={req:[],reqEmpty:[],reqFilled:[],opt:[],optEmpty:[],optFilled:[],empty:[]};return _(this.subviews).forEach(function(b){b.isRequired()?(a.req.push(b),b.hasImageData()?a.reqFilled.push(b):(a.reqEmpty.push(b),a.empty.push(b))):(a.opt.push(b),b.hasImageData()?a.optFilled.push(b):(a.optEmpty.push(b),a.empty.push(b)))}),a},value:function(a){return a&&!_.isEmpty(a)&&_(this.subviews).forEach(function(b){FieldCameraView.prototype.value.call(b,a)}),a={},_(this.subviews).forEach(function(b){$.extend(a,FieldCameraView.prototype.value.call(b))}),a}}),FieldCheckboxView=FieldView.extend({choice:'<input data-fieldId="<%= fieldId %>" <%= checked %> data-index="<%= index %>" name="<%= fieldId %>[]" type="checkbox" class="field checkbox" value="<%= value %>" ><label class="choice" ><%= choice %></label><br/>',renderInput:function(a){var b=this.model.getCheckBoxOptions(),c=this.model.getFieldId(),d=this,e="";return $.each(b,function(b,f){e+=_.template(d.choice,{fieldId:c,index:a,choice:f.label,value:f.value,checked:f.selected?"checked='checked'":""})}),e},valueFromElement:function(a){var b=[],c=this.getWrapper(a),d=c.find("input:checked");return d.each(function(){b.push($(this).val())}),b},valuePopulateToElement:function(a,b){var c=this.getWrapper(a);if(b&&!(!b instanceof Array))for(var d=0;d<b.length;d++){var e=b[d];c.find("input[value='"+e+"']").attr("checked","checked")}}}),FieldEmailView=FieldView.extend({type:"email"}),FieldFileView=FieldView.extend({input:"<button style='display:none' data-field='<%= fieldId %>' class='special_button' data-index='<%= index %>'></button><input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>'/> ",type:"file",initialize:function(){this.fileObjs=[],FieldView.prototype.initialize.apply(this,arguments)},contentChanged:function(a){var b=this,c=a.target,d=$(c),e=d.data().index,f=c.files?c.files[0]:null;if(f){var g={fileName:f.name,fileSize:f.size,fileType:f.type};b.showButton(e,g)}else b.showFile(e)},valueFromElement:function(a){var b=this.getWrapper(a),c=b.find("input[type='file']")[0];return c.files&&c.files.length>0?c.files[0]:this.fileObjs[a]},showButton:function(a,b){var c=this.getWrapper(a),d=c.find("button"),e=c.find("input[type='file']");e.hide(),d.show(),d.text(b.fileName+"("+b.fileSize+")"),d.off("click"),d.on("click",function(){$(this).data().index;e.click()})},showFile:function(a){var b=this.getWrapper(a),c=b.find("button"),d=b.find("input[type='file']");c.off("click"),c.hide(),d.show(),this.fileObjs[a]&&(this.fileObjs[a]=null)},valuePopulateToElement:function(a,b){b&&(this.fileObjs[a]=b,this.showButton(a,b))}}),FieldGeoView=FieldView.extend({input:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='<%= inputType %>' disabled/> ",type:"text",initialize:function(){this.geoValues=[],this.locationUnit=this.model.getFieldDefinition().locationUnit,FieldView.prototype.initialize.apply(this,arguments)},renderInput:function(a){var b="latLong"===this.locationUnit?"Capture Location (Lat/Lon)":"Capture Location (East/North)",c=_.template(this.input,{fieldId:this.model.getFieldId(),index:a,inputType:"text"});return c+=this.renderButton(a,b,"fhgeo")},onRender:function(){var a=this;this.$el.find("button").on("click",function(b){b.preventDefault();var c=$(this),d=c.data().index,e=a.getWrapper(d),f=e.find("input[type='text']");return $fh.geo(function(b){if("latLong"===a.locationUnit)a.geoValues[d]={lat:b.lat,"long":b.lon};else if("northEast"===a.locationUnit){var c=a.convertLocation(b),e=c.toString().split(" ");a.geoValues[d]={zone:e[0],eastings:e[1],northings:e[2]}}a.renderElement(d)},function(){f.attr("placeholder","Location could not be determined")}),!1})},convertLocation:function(a){var c=a.lat,d=a.lon,e={lat:function(){return c},lon:function(){return d}};return b.latLongToOsGrid(e)},renderElement:function(a){var b=this.geoValues[a],c="",d=this.getWrapper(a).find("input[type='text']");b&&("latLong"===this.locationUnit?c="("+b.lat+", "+b.long+")":"northEast"===this.locationUnit&&(c="("+b.zone+" "+b.eastings+", "+b.northings+")"),d.val(c)),d.blur()},valuePopulateToElement:function(a,b){this.geoValues[a]=b,this.renderElement(a)},valueFromElement:function(a){return this.geoValues[a]}}),FieldMapView=FieldView.extend({extension_type:"fhmap",input:"<div data-index='<%= index %>' class='fh_map_canvas' style='width:<%= width%>; height:<%= height%>;'></div>",initialize:function(){this.mapInited=0,this.maps=[],this.mapData=[],this.markers=[],this.allMapInitFunc=[],this.mapSettings={mapWidth:"100%",mapHeight:"300px",defaultZoom:16,location:{lon:-5.80078125,lat:53.12040528310657}},FieldView.prototype.initialize.apply(this,arguments)},renderInput:function(a){return _.template(this.input,{width:this.mapSettings.mapWidth,height:this.mapSettings.mapHeight,index:a})},onMapInit:function(){this.mapInited++,this.mapInited==this.curRepeat&&this.allMapInit()},allMapInit:function(){for(;func=this.allMapInitFunc.shift();)func()},onAllMapInit:function(a){this.mapInited==this.curRepeat?a():-1==this.allMapInitFunc.indexOf(a)&&this.allMapInitFunc.push(a)},onElementShow:function(a){var b=this.getWrapper(a),c=this,d=b.find(".fh_map_canvas")[0];$fh.geo({interval:0},function(b){var e={lat:b.lat,lon:b.lon};$fh.map({target:d,lon:e.lon,lat:e.lat,zoom:c.mapSettings.defaultZoom},function(b){c.maps[a]=b.map;var d=new google.maps.Marker({position:c.maps[a].getCenter(),map:c.maps[a],draggable:!0,animation:google.maps.Animation.DROP,title:"Drag this to set position"});
c.markers[a]=d,c.mapData[a]={lat:d.getPosition().lat(),"long":d.getPosition().lng(),zoom:c.mapSettings.defaultZoom},c.onMapInit(a)},function(b){console.error(b),c.onMapInit(a)})})},mapResize:function(){if(this.maps.length>0)for(var a=0;a<this.maps.length;a++){var b=this.maps[a];b&&(google.maps.event.trigger(b,"resize"),b.setCenter(new google.maps.LatLng(this.latLongs[a].lat,this.latLongs[a].long)))}},addValidationRules:function(){},valueFromElement:function(a){var b=this.maps[a],c=this.markers[a];return b&&c?{lat:c.getPosition().lat(),"long":c.getPosition().lng(),zoom:b.getZoom()}:null},valuePopulateToElement:function(a,b){function c(){var c=d.maps[a],e=new google.maps.LatLng(b.lat,b.long);c.setCenter(e),c.setZoom(b.zoom),d.markers[a].setPosition(e)}if(b){var d=this;this.onAllMapInit(c)}}}),FieldNumberView=FieldView.extend({type:"number",valueFromElement:function(a){var b=this.getWrapper(a);return parseFloat(b.find("input,select,textarea").val())||0}}),FieldPhoneView=FieldView.extend({type:"tel"}),FieldRadioView=FieldView.extend({hidden_field:'<input id="radio<%= id %>" type="hidden" value="" data-type="radio">',choice:'<input data-field="<%= fieldId %>" data-index="<%= index %>" name="<%= fieldId %>_<%= index %>" type="radio" class="field radio" value="<%= value %>" ><label class="choice" ><%= choice %></label><br/>',renderInput:function(a){var b=this.model.getRadioOption(),c=this,d="",e=this.model.getFieldId();return $.each(b,function(b,f){var g=$(_.template(c.choice,{fieldId:e,choice:f.label,value:f.label,index:a}));1==f.checked&&g.attr("checked","checked"),d+=c.htmlFromjQuery(g)}),d},valuePopulateToElement:function(a,b){var c=this.getWrapper(a),d=c.find("input[value='"+b+"']");0==d.length&&(d=c.find("input:first-child")),d.attr("checked","checked")},valueFromElement:function(a){var b=this.getWrapper(a);return b.find("input:checked").val()||this.model.getRadioOption()[0].label}}),FieldSelectView=FieldView.extend({select:"<select data-field='<%= fieldId %>' data-index='<%= index %>'><%= options %></select>",option:'<option value="<%= value %>" <%= selected %>><%= value %></option>',renderInput:function(a){var b=this.model.getFieldId(),c=this.model.get("fieldOptions");c=c.definition.options;var d="",e=this;return $.each(c,function(a,b){d+=_.template(e.option,{value:b.label,selected:b.checked?"selected='selected'":""})}),_.template(this.select,{fieldId:b,index:a,options:d})}}),FieldSignatureView=FieldView.extend({extension_type:"fhsig",templates:{input:'<label for="<%= id %>"><%= title %></label><img class="sigImage"/><input id="<%= id %>" name="<%= id %>" type="hidden">',signaturePad:['<div class="sigPad">','<ul class="sigNav">','<button class="clearButton">Clear</button><button class="cap_sig_done_btn">Done</button>',"</ul>",'<div class="sig sigWrapper">','<canvas class="pad" width="<%= canvasWidth %>" height="<%= canvasHeight %>"></canvas>',"</div>","</div>"]},initialize:function(){FieldView.prototype.initialize.call(this),this.on("visible",this.clearError)},dumpContent:function(){FieldFileView.prototype.dumpContent.call(this)},render:function(){this.$el.append(_.template(this.templates.input,{id:this.model.get("_id"),title:this.model.get("Title")}));this.addButton(this.$el,this.extension_type,"Capture Signature");this.options.parentEl.append(this.$el),console.debug("render html="+this.$el.html()),this.show()},contentChanged:function(){FieldView.prototype.contentChanged.apply(this,arguments),this.clearError()},clearError:function(){var a=this.model.get("_id"),b=this.model.get("value");b&&b.hasOwnProperty(a)&&!this.isEmptyImage(b[a].fileBase64)&&FieldView.prototype.clearError.call(this)},action:function(){$("input",this.$el),this.showSignatureCapture()},showSignatureCapture:function(){var a=this,b=$(window).height(),c=$(window).width(),d=b-70,e=c-2,f=d-20;this.$el.append(_.template(this.templates.signaturePad.join(""),{canvasHeight:d,canvasWidth:e})),console.debug("showSignatureCapture html="+this.$el.html());var g=$(".sigPad",this.$el);g.css({position:"fixed","z-index":9999,width:c+"px",height:b+"px",top:"0px",left:"0px","background-color":"#fff"});var h=$(".sigNav",this.$el).outerHeight();$(".sigPad",this.$el).css({width:"100%",height:b+"px"}),$(".sigWrapper",this.$el).css({height:b-h-20+"px"}),sigPad=$(".sigPad",this.$el).signaturePad({drawOnly:!0,lineTop:f}),$(this.$el).data("sigpadInited",!0),$(".cap_sig_done_btn",this.$el).unbind("click").bind("click",function(b){var c=new LoadingView;c.show("generating signature"),b.preventDefault();var d=sigPad.getSignature();if(d&&d.length){var e=sigPad.getSignatureImage();a.dbgImage("signature field sig[default]=",e),a.isEmptyImage(e)&&(e=sigPad.getSignatureImage("image/png"),a.dbgImage("signature field sig[image/png]=",e)),a.isEmptyImage(e)&&(e=sigPad.getSignatureImage("image/jpeg"),a.dbgImage("signature field sig[image/jpeg]=",e)),a.isEmptyImage(e)&&(e=a.toJpg(),a.dbgImage("signature field sig[encoded jpg]=",e)),a.isEmptyImage(e)&&(e=a.toBmp(),a.dbgImage("signature field sigencoded bmp]=",e));var f=$(".sigImage",a.$el)[0];f.src=e,$("input",a.$el).val(e),a.fileData={},a.fileData.fileBase64=e;var g=a.splitImage(e);a.fileData.content_type=g[0],a.fileData.filename="signature."+g[1]}$(".sigPad",a.$el).hide(),c.hide(),a.contentChanged()})},value:function(a){return a&&!_.isEmpty(a)&&(this.fileData=a[this.model.get("_id")],$(".sigImage",this.$el).attr("src",this.fileData.fileBase64),$("input",this.$el).val(this.fileData.fileBase64)),a={},this.fileData&&(a[this.model.get("_id")]=this.fileData),console.debug("value html="+this.$el.html()),a},dbgImage:function(a,b){console.log(a+(b?b.substring(0,b.indexOf(","))+"[len="+b.length+"]":" empty"))},toJpg:function(a){a=_.extend({},a||{},{quality:100,width:248,height:100});var b=$(".sigPad",self.$el).find("canvas")[0],c=this.scaleCanvas(b,a.width,a.height),d=new JPEGEncoder(a.quality);return d.encode(c.getContext("2d").getImageData(0,0,a.width,a.height))},toBmp:function(a){a=_.extend({},a||{},{quality:100,width:248,height:100});var b,c=$(".sigPad",self.$el).find("canvas")[0],d=this.scaleCanvas(c,a.width,a.height),e=this.readCanvasData(d),f=this.createBMP(e);return b=this.makeDataURI(f,"image/bmp")},readCanvasData:function(a){var b=parseInt(a.width,10),c=parseInt(a.height,10);return a.getContext("2d").getImageData(0,0,b,c)},encodeData:function(a){var b="";if("string"==typeof a)b=a;else for(var c=a,d=0;d<c.length;d++)b+=String.fromCharCode(c[d]);return btoa(b)},createBMP:function(a){var b=[],c=a.width,d=a.height;b.push(66),b.push(77);var e=c*d*3+54;b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),e=Math.floor(e/256),b.push(e%256),b.push(0),b.push(0),b.push(0),b.push(0),b.push(54),b.push(0),b.push(0),b.push(0);var f=[];f.push(40),f.push(0),f.push(0),f.push(0);var g=c;f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256),g=Math.floor(g/256),f.push(g%256);var h=d;f.push(h%256),h=Math.floor(h/256),f.push(h%256),h=Math.floor(h/256),f.push(h%256),h=Math.floor(h/256),f.push(h%256),f.push(1),f.push(0),f.push(24),f.push(0),f.push(0),f.push(0),f.push(0),f.push(0);var i=c*d*3;f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256),i=Math.floor(i/256),f.push(i%256);for(var j=0;16>j;j++)f.push(0);var k=(4-3*c%4)%4,l=a.data,m="",n=d;do{for(var o=c*(n-1)*4,p="",q=0;c>q;q++){var r=4*q;p+=String.fromCharCode(l[o+r+2]),p+=String.fromCharCode(l[o+r+1]),p+=String.fromCharCode(l[o+r])}for(var s=0;k>s;s++)p+=String.fromCharCode(0);m+=p}while(--n);var t=this.encodeData(b.concat(f))+this.encodeData(m);return t},makeDataURI:function(a,b){return"data:"+b+";base64,"+a},scaleCanvas:function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";var e=d.getContext("2d");return e.drawImage(a,0,0,a.width,a.height,0,0,b,c),d}return a},isEmptyImage:function(a){return null===a||""===a||"data:,"===a},splitImage:function(a){var b="data:",c=";base64,",d=a.indexOf(b),e="image/bmp",f="bmp";if(d>=0){var g=a.indexOf(c,d)+1;e=a.substring(d,g-1),f=e.split("/")[1]}return[e,f]}}),FieldTextView=FieldView.extend({template:['<label class="desc" for="<%= id %>"><%= title %></label>','<input class="field text medium" maxlength="255" id="<%= id %>" name="<%= id %>" type="text" value="<%= defaultVal %>">']}),FieldTextareaView=FieldView.extend({input:"<textarea data-field='<%= fieldId %>' data-index='<%= index %>'  ></textarea>"}),FieldSectionBreak=FieldView.extend({renderEle:function(){return"<hr/>"}}),FieldDateTimeView=FieldView.extend({extension_type:"fhdate",inputTime:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='time'>",inputDate:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='date'>",inputDateTime:"<input data-field='<%= fieldId %>' data-index='<%= index %>' type='text'>",renderInput:function(a){var b=this.model.getFieldId(),c=this.getUnit(),d="",e="";"dateTime"==c?(d=this.inputDateTime,e="Get Current Date & Time"):"date"==c?(d=this.inputDate,e="Get Current Date"):"time"==c&&(d=this.inputTime,e="Get Current Time");var f=_.template(d,{fieldId:b,index:a});return f+=this.renderButton(a,e,"fhdate")},getUnit:function(){var a=this.model.getFieldDefinition();return a.dateTimeUnit},onRender:function(){var a=this;this.$el.on("click","button",function(){a.action(this)})},action:function(a){var b=$(a).data().index,c=this,d=new Date;"dateTime"===c.getUnit()?$('input[data-index="'+b+'"]',this.$el).val(c.getDate(d)+" "+c.getTime(d)).blur():"date"===c.getUnit()?$('input[data-index="'+b+'"]',this.$el).val(c.getDate(d)).blur():"time"===c.getUnit()&&$('input[data-index="'+b+'"]',this.$el).val(c.getTime(d)).blur()},getDate:function(a){return"YYYY-MM-DD".replace("YYYY",a.getFullYear()).replace("MM",this.twoDigi(a.getMonth()+1)).replace("DD",this.twoDigi(a.getDate()))},getTime:function(a){return"HH:mm:ss".replace("HH",this.twoDigi(a.getHours())).replace("mm",this.twoDigi(a.getMinutes())).replace("ss",this.twoDigi(a.getSeconds()))},twoDigi:function(a){return 10>a?"0"+a.toString():a.toString()}}),PageView=f.extend({viewMap:{text:FieldTextView,number:FieldNumberView,textarea:FieldTextareaView,radio:FieldRadioView,checkboxes:FieldCheckboxView,dropdown:FieldSelectView,file:FieldFileView,emailAddress:FieldEmailView,phone:FieldPhoneView,location:FieldGeoView,photo:FieldCameraGroupView,signature:FieldSignatureView,locationMap:FieldMapView,dateTime:FieldDateTimeView,sectionBreak:FieldSectionBreak},initialize:function(){var a=this;_.bindAll(this,"render","show","hide"),this.model.on("visible",a.show),this.model.on("hidden",a.hide),this.render()},render:function(){var a=this;this.fieldViews={},this.$el.empty().addClass("page hidden"),this.options.parentEl.append(this.$el);var b=this.model.getFieldModelList();b.forEach(function(b){var c=b.getType();a.viewMap[c]?(console.log("*- "+c),a.fieldViews[b.get("_id")]=new a.viewMap[c]({parentEl:a.$el,parentView:a,model:b,formView:a.options.formView})):console.warn("FIELD NOT SUPPORTED:"+c)})},show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")},showField:function(a){this.fieldViews[a]&&this.fieldViews[a].show()},hideField:function(a){this.fieldViews[a]&&this.fieldViews[a].hide()},isValid:function(){var a=this.$el.find("input,select,option,textarea").not('.validate_ignore,[type!="hidden"]:hidden');return a.length?a.valid():!0},checkRules:function(){var a=this,b={},c={SkipToPage:function(a,c){var d=c.Setting.Page;a&&(b.skipToPage=d)}};return _(this.model.get("Rules")||[]).forEach(function(b,d){var e=a.$el.find("#Field"+b.condition.FieldName+",#radioField"+b.condition.FieldName);if(b.fn=c[b.Type],"radio"===e.data("type")){var f=a.$el.find("#Field"+b.condition.FieldName+"_"+d);f.wufoo_rules("exec",b)}else e.wufoo_rules("exec",b)}),b}});{var i=f.extend({pageNum:0,pageCount:0,pageViews:[],submission:null,fieldValue:[],templates:{buttons:'<div id="buttons" class="fh_action_bar"><button class="saveDraft hidden button button-main">Save Draft</button><button class="previous hidden button">Previous</button><button class="next hidden button">Next</button><button class="submit hidden button button-positive">Submit</button></div>'},events:{"click button.next":"nextPage","click button.previous":"prevPage","click button.saveDraft":"saveToDraft","click button.submit":"submit"},initialize:function(){_.bindAll(this,"checkRules","onValidateError"),this.el=this.options.parentEl,this.fieldModels=[],this.el.empty()},loadForm:function(a,b){var c=this;a.formId?(this.onLoad(),$fh.forms.getForm(a,function(d,e){if(d)throw d.body;c.form=e,c.params=a,c.initWithForm(e,a),b()})):a.form&&(c.form=a.form,c.params=a,c.initWithForm(a.form,a),b())},readOnly:function(){this.readonly=!0;for(var a,b=0;a=this.fieldViews[b];b++)a.$el.find("button,input,textarea,select").attr("disabled","disabled");this.el.find("button.saveDraft").hide(),this.el.find(" button.submit").hide()},onValidateError:function(a){for(var b in a){var c=this.getFieldViewById(b),d=a[b].errorMessages.join(", ");c.setErrorText(0,d)}},initWithForm:function(a,b){var c=this;c.formId=a.getFormId(),c.el.empty(),c.model=a,b.submission||(b.submission=c.model.newSubmission()),c.submission=b.submission,c.submission.on("validationerror",c.onValidateError);for(var d,e=a.getPageModelList(),f=[],g=0;d=e[g];g++){var h=d.getFieldModelList();c.fieldModels=c.fieldModels.concat(h);var i=new PageView({model:d,parentEl:c.el,formView:c});f.push(i)}for(var i,j=[],g=0;i=f[g];g++){var k=i.fieldViews;for(var l in k){var m=k[l];j.push(m),m.on("checkrules",c.checkRules),c.readonly&&m.$el.find("input,button,textarea,select").attr("disabled","disabled")}}c.fieldViews=j,c.pageViews=f,c.pageCount=f.length,c.onLoadEnd()},checkRules:function(){var a=this;this.populateFieldViewsToSubmission(function(){var b=a.submission;b.checkRules(function(b,c){if(b)console.error(b);else{var d=c.actions,e=d.pages,f=d.fields;for(var g in e)a.performRuleAction("page",g,e[g].action);for(var g in f)a.performRuleAction("field",g,f[g].action)}})})},performRuleAction:function(a,b,c){var d=null;if("page"==a?d=this.getPageViewById(b):"field"==a&&(d=this.getFieldViewById(b)),null==d)return console.error("cannot find target with id:"+b),void 0;switch(c){case"show":d.show();break;case"hide":d.hide();break;default:console.error("action not defined:"+c)}},rebindButtons:function(){var a=this;this.el.find("button.next").unbind().bind("click",function(){a.nextPage()}),this.el.find("button.previous").unbind().bind("click",function(){a.prevPage()}),this.el.find("button.saveDraft").unbind().bind("click",function(){a.saveToDraft()}),this.el.find("button.submit").unbind().bind("click",function(){a.submit()})},setSubmission:function(a){this.submission=a},getSubmission:function(){return this.submission},getPageViewById:function(a){for(var b,c=0;b=this.pageViews[c];c++){var d=b.model.getPageId();if(d==a)return b}return null},getFieldViewById:function(a){for(var b,c=0;b=this.fieldViews[c];c++){var d=b.model.getFieldId();if(d==a)return b}return null},checkPages:function(){0===this.pageNum&&this.pageNum===this.pageCount-1?(this.el.find(" button.previous").hide(),this.el.find("button.next").hide(),this.el.find("button.saveDraft").show(),this.el.find(" button.submit").show(),this.el.find("button").addClass("two_button")):0===this.pageNum?(this.el.find(" button.previous").hide(),this.el.find("button.next").show(),this.el.find("button.saveDraft").show(),this.el.find(" button.submit").hide(),this.el.find("button").addClass("two_button")):this.pageNum===this.pageCount-1?(this.el.find(" button.previous").show(),this.el.find(" button.next").hide(),this.el.find(" button.saveDraft").show(),this.el.find(" button.submit").show(),this.el.find("button").addClass("three_button")):(this.el.find(" button.previous").show(),this.el.find(" button.next").show(),this.el.find(" button.saveDraft").show(),this.el.find(" button.submit").hide(),this.el.find("button").addClass("three_button")),this.readonly&&(this.el.find("button.saveDraft").hide(),this.el.find(" button.submit").hide())},render:function(){this.el.append(this.templates.buttons),this.rebindButtons(),this.pageViews[0].show(),this.checkPages()},nextPage:function(){this.hideAllPages(),this.pageViews[this.pageNum+1].show(),this.pageNum=this.pageNum+1,this.checkPages()},prevPage:function(){this.hideAllPages(),this.pageViews[this.pageNum-1].show(),this.pageNum=this.pageNum-1,this.checkPages()},hideAllPages:function(){this.pageViews.forEach(function(a){a.hide()})},submit:function(){var a=this;this.populateFieldViewsToSubmission(function(){a.submission.submit(function(b){b?console.error(b):a.el.empty()})})},saveToDraft:function(){var a=this;this.populateFieldViewsToSubmission(function(){a.submission.saveDraft(function(){a.el.empty()})})},populateFieldViewsToSubmission:function(a){for(var b,c=this.submission,d=this.fieldViews,e=[],f=0;b=d[f];f++)for(var g=b.value(),h=b.model.getFieldId(),i=0;i<g.length;i++){var j=g[i];e.push({id:h,value:j})}var k=e.length;c.reset();for(var l,f=0;l=e[f];f++){var h=l.id,m=l.value;c.addInputValue(h,m,function(b){b&&console.error(b),k--,0==k&&a()})}},setInputValue:function(a,b){for(var c,d=0;c=this.fieldValue[d];d++)c.id==a&&this.fieldValue.splice(d,1);for(var e,d=0;e=b[d];d++)this.fieldValue.push({id:a,value:e});console.log("INPUT VALUE SET",a,b)}});f.extend({events:{"click button#convert":"convert"},templates:{body:'<h1>Insert JSON</h1><textarea id="jsonBox" rows="30" cols="50"></textarea><button id="convert">Convert</button><div id="resultArea"></div>'},el:"#jsonPage",initialize:function(){_.bindAll(this,"render")},show:function(){$(this.el).show()},hide:function(){$(this.el).hide()},render:function(){$(this.el).html(this.templates.body),this.show()},convert:function(){var a=$("#jsonBox").val();try{var b=JSON.parse(a)}catch(c){throw console.log(c),"Invalid JSON object"}var d={formId:(new Date).getTime(),rawMode:!0,rawData:b},e=new i({parentEl:"#backbone #resultArea"});e.loadForm(d,function(){e.render()})}})}"undefined"==typeof $fh&&($fh={}),$fh.forms||($fh.forms={}),$fh.forms.renderForm=function(a,b){var c=a.container,d=(a.formId,a.fromRemote||!1,a.type||"backbone"),e=new i({parentEl:c});e.loadForm(a,function(){"backbone"==d?b(null,e):"html"==d&&b(null,e)})},$fh.forms.renderFormList=function(a){var b=a.fromRemote||!1,c=a.parentEl;$fh.forms.getForms({fromRemote:b},function(a,b){formListView=new g({model:b,parentEl:c}),formListView.render()})},$fh.forms.backbone={},$fh.forms.backbone.FormView=i}(window||module.exports);